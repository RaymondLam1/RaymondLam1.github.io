<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深度剖析 Apache Dubbo 核心技术内幕 | Raymondlam1</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="XXX">
    
    <link rel="preload" href="/assets/css/0.styles.975cf9e9.css" as="style"><link rel="preload" href="/assets/js/app.990df87d.js" as="script"><link rel="preload" href="/assets/js/7.491a51aa.js" as="script"><link rel="preload" href="/assets/js/2.e6a59b38.js" as="script"><link rel="preload" href="/assets/js/1.d6963574.js" as="script"><link rel="preload" href="/assets/js/14.b7d37254.js" as="script"><link rel="prefetch" href="/assets/js/10.797b224f.js"><link rel="prefetch" href="/assets/js/11.f1f1449d.js"><link rel="prefetch" href="/assets/js/15.56e70929.js"><link rel="prefetch" href="/assets/js/16.02b63a7a.js"><link rel="prefetch" href="/assets/js/17.e533830f.js"><link rel="prefetch" href="/assets/js/18.05f03067.js"><link rel="prefetch" href="/assets/js/19.20d4f721.js"><link rel="prefetch" href="/assets/js/20.629f92a3.js"><link rel="prefetch" href="/assets/js/21.85f5ad32.js"><link rel="prefetch" href="/assets/js/22.d9ae4026.js"><link rel="prefetch" href="/assets/js/23.61401ff0.js"><link rel="prefetch" href="/assets/js/24.de1681d0.js"><link rel="prefetch" href="/assets/js/25.9be151bc.js"><link rel="prefetch" href="/assets/js/26.9c6ab290.js"><link rel="prefetch" href="/assets/js/27.43f4ed25.js"><link rel="prefetch" href="/assets/js/28.0c7d7629.js"><link rel="prefetch" href="/assets/js/29.0bc708b8.js"><link rel="prefetch" href="/assets/js/3.a9685e30.js"><link rel="prefetch" href="/assets/js/30.21dc9da5.js"><link rel="prefetch" href="/assets/js/31.d4183985.js"><link rel="prefetch" href="/assets/js/32.b7bfe177.js"><link rel="prefetch" href="/assets/js/33.db8e03f4.js"><link rel="prefetch" href="/assets/js/34.a5820a8c.js"><link rel="prefetch" href="/assets/js/35.26cd22f6.js"><link rel="prefetch" href="/assets/js/36.b9d310dc.js"><link rel="prefetch" href="/assets/js/37.ce82ed82.js"><link rel="prefetch" href="/assets/js/38.cdd78f3b.js"><link rel="prefetch" href="/assets/js/39.4b9b9318.js"><link rel="prefetch" href="/assets/js/4.1db959a2.js"><link rel="prefetch" href="/assets/js/40.a0b2b6f6.js"><link rel="prefetch" href="/assets/js/41.d2f51ba4.js"><link rel="prefetch" href="/assets/js/42.6e33e97d.js"><link rel="prefetch" href="/assets/js/43.e6285fac.js"><link rel="prefetch" href="/assets/js/44.55f58fe3.js"><link rel="prefetch" href="/assets/js/45.b785e32e.js"><link rel="prefetch" href="/assets/js/46.95d1e4ba.js"><link rel="prefetch" href="/assets/js/47.bc46e5fd.js"><link rel="prefetch" href="/assets/js/48.f9bd2fe7.js"><link rel="prefetch" href="/assets/js/49.6ef8250b.js"><link rel="prefetch" href="/assets/js/5.3b2f494c.js"><link rel="prefetch" href="/assets/js/50.6f7acc39.js"><link rel="prefetch" href="/assets/js/51.c35bcef8.js"><link rel="prefetch" href="/assets/js/6.e7dc2624.js"><link rel="prefetch" href="/assets/js/8.8e69ed5c.js"><link rel="prefetch" href="/assets/js/9.bba2517f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.e6ae10a0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.975cf9e9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Raymondlam1</h3> <p class="description" data-v-59e6cb88>XXX</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Raymondlam1</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Raymondlam1 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/RaymondLam1" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>14</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Raymondlam1 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/RaymondLam1" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/" class="sidebar-heading clickable router-link-active"><span>很高兴认识你</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/" aria-current="page" class="sidebar-link">自我介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>博客</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/parallel_scavenge.html" class="sidebar-link">Parallel Scavenge 新生代算法究竟是“标记-复制”还是“标记-清理”算法</a></li><li><a href="/posts/JFR.html" class="sidebar-link">防痴呆记录-JFR</a></li><li><a href="/posts/finalize.html" class="sidebar-link">finalize 方法阻塞分析</a></li><li><a href="/posts/spring-boot.html" class="sidebar-link">Spring Boot ClassLoader</a></li><li><a href="/posts/wireshark-grpc.html" class="sidebar-link">Wireshark 抓包 grpc</a></li><li><a href="/posts/ant-design-swagger.html" class="sidebar-link">Ant Design Pro 集合 Swagger 的坑</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>读书笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/dubbo.html" aria-current="page" class="active sidebar-link">深度剖析 Apache Dubbo 核心技术内幕</a></li><li><a href="/posts/Large-scale_website_system_and_Java_middleware_practice.html" class="sidebar-link">大型网站系统与 Java 中间件实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/other/2FA.html" class="sidebar-link">Github 2FA 验证</a></li><li><a href="/posts/other/vue_press_deploy.html" class="sidebar-link">Vuepress 博客 GitHub Action</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>深度剖析 Apache Dubbo 核心技术内幕</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">深度剖析 Apache Dubbo 核心技术内幕</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Raymondlam1</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2024/5/12</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="基础篇"><a href="#基础篇" class="header-anchor">#</a> 基础篇</h2> <p>基础篇简单地讲解Dubbo如何使用以及本书中的Demo实例，建议读者先阅读基础篇再进入后面的章节，因为后面的章节基本上是基于本章的Demo进行讲解的。</p> <h2 id="第1章-dubbo基础"><a href="#第1章-dubbo基础" class="header-anchor">#</a> 第1章 Dubbo基础</h2> <h2 id="_1-1-初识dubbo"><a href="#_1-1-初识dubbo" class="header-anchor">#</a> 1.1 初识Dubbo</h2> <blockquote><p>整体来说，一个公司业务系统的演进流程基本上都是从单体应用到多体应用。业务系统为单体应用时，不同业务模块的相互调用直接在本地JVM 进程内就可以完成；而变为多个应用时，相互之间进行通信的方式就不是简单地进行本地调用了，因为不同业务模块部署到了不同的JVM进程里，更常见的情况是部署到了不同的机器中，这时候，一个高效、稳定的RPC远程调用框架就变得非常重要。</p></blockquote> <p>本节概要介绍使用Dubbo构建的分布式系统架构中各个组件服务的作用以及相互关系，其中各个组件之间的关系如图1.1所示。</p> <p><img src="/assets/img/image-20240512200415412.4ecf5ad3.png" alt="image-20240512200415412"></p> <ul><li><p>Provider为服务提供者集群，服务提供者负责暴露提供的服务，并将服务注册到服务注册中心。</p></li> <li><p>Consumer为服务消费者集群，服务消费者通过RPC远程调用服务提供者提供的服务。</p></li> <li><p>Registry负责服务注册与发现。</p></li> <li><p>Monitor为监控中心，统计服务的调用次数和调用时间。</p></li></ul> <p>以上各个组件的调用关系如下：</p> <ul><li>服务提供方在启动时会将自己提供的服务注册到服务注册中心。</li> <li>服务消费方在启动时会去服务注册中心订阅自己需要的服务的地址列表，然后服务注册中心异步把消费方需要的服务接口的提供者的地址列表返回给服务消费方，服务消费方根据路由规则和设置的负载均衡算法选择一个服务提供者IP进行调用。</li> <li>监控平台主要用来统计服务的调用次数和调用耗时，即服务消费者和提供者在内存中累计调用服务的次数和耗时，并每分钟定时发送一次统计数据到监控中心，监控中心则使用数据绘制图表来显示。监控平台不是分布式系统必需的，但是这些数据有助于系统的运维和调优。服务提供者和消费者可以直接配置监控平台的地址，也可以通过服务注册中心获取。</li></ul> <h2 id="_1-2-本书demo详解"><a href="#_1-2-本书demo详解" class="header-anchor">#</a> 1.2 本书Demo详解</h2> <h3 id="_1-2-1-demo结构说明"><a href="#_1-2-1-demo结构说明" class="header-anchor">#</a> 1.2.1 Demo结构说明</h3> <p>首先讲解本书使用的Demo的结构，Demo使用Maven聚合功能构建，里面有三个模块，目录如图1.2所示。</p> <img src="/assets/img/image-20240512201511031.22602ff7.png" alt="image-20240512201511031" style="zoom:50%;"> <ul><li><p>Consumer 模块为服务消费者相关模块，本书中所有与消费端有关的Demo都在该模块中，包含普通调用、各种异步调用、泛化调用、基于扩展接口实现的自定义负载均衡策略、集群容错策略等。</p></li> <li><p>Provider 模块为服务提供者相关模块，本书中所有与服务提供端有关的Demo都在该模块中，包含服务接口的实现类、服务提供方的同步处理请求、各种异步处理请求的实现等。</p></li> <li><p>SDK模块是一个二方包，用来存放服务接口，这是为了代码复用，在服务提供者和消费者（泛化调用除外）的模块里需要引入这个二方包。</p></li></ul> <h3 id="_1-2-2-sdk模块"><a href="#_1-2-2-sdk模块" class="header-anchor">#</a> 1.2.2 SDK模块</h3> <p>考虑到代码复用，SDK模块主要用来存放服务接口的定义与POJO类，下面我们看看其中的内容。</p> <ul><li>GreetingService接口类主要用来演示同步调用，如下代码就定义了两个方法：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GreetingService</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token class-name">PoJo</span> poJo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>GrettingServiceAsync接口类主要用来演示基于定义CompletableFuture签名的接口如何实现异步执行，如下代码就定义了一个返回值类型为CompletableFuture的方法：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GrettingServiceAsync</span> <span class="token punctuation">{</span>
	<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>GrettingServiceRpcContext接口类主要用来演示AsyncContext如何实现异步执行，如下代码只有一个方法：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GrettingServiceRpcContext</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>PoJo类，一个简单的POJO（Plain Ordinary Java Object，简单Java对象）对象，用于演示泛化调用时的参数转换：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PoJo</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span>  id<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> id<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Result类，POJO的返回值类型，用于演示泛化调用时的参数转换，定义如下：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSucess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> sucess<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSucess</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> sucess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>sucess <span class="token operator">=</span> sucess<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> msg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">boolean</span> sucess<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-2-3-同步发布与调用服务"><a href="#_1-2-3-同步发布与调用服务" class="header-anchor">#</a> 1.2.3 同步发布与调用服务</h3> <p>首先我们看看服务提供端是如何使用Dubbo API发布服务的。在了解具体如何发布之前，先看看服务提供端针对SDK中<code>com.books.dubbo.demo.api.GreetingService</code>接口的实现类GreetingServiceImpl的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GreetingService</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token class-name">PoJo</span> poJo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">setSucess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			result<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>poJo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre></div><p>上面的代码很简单，sayHello（）方法休眠1s后返回拼接的字符串。其中RpcContext.getContext（）.getAttachment（&quot;company&quot;）获取调用方在上下文对象中附加的company变量的值，如果调用方在调用前没进行设置，则返回null。testGeneric（）方法则把传入的poJo对象转换为字符串后返回。</p> <p>下面我们看看ApiProvider类是如何发布服务的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>books<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>provider</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">ApplicationConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RegistryConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">ServiceConfig</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>books<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">GreetingService</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiProvider</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.创建ServiceConfig实例</span>
		<span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> serviceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 2.设置应用程序配置</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-provider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3.设置服务注册中心信息</span>
		<span class="token class-name">RegistryConfig</span> registryConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span>registryConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 4.设置接口与实现类</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GreetingServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 5.设置服务分组与版本 </span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 6.设置线程池策略</span>
<span class="token comment">//		HashMap&lt;String, String&gt; parameters = new HashMap&lt;&gt;();</span>
<span class="token comment">//		parameters.put(&quot;threadpool&quot;, &quot;mythreadpool&quot;);</span>
<span class="token comment">//		serviceConfig.setParameters(parameters);</span>

		<span class="token comment">// 7.导出服务</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 8.挂起线程，避免服务停止</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;server is started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>代码1创建了ServiceConfig实例，其泛型参数为GreetingService接口；代码2配置应用程序属性；代码3设置服务注册中心地址，可知服务注册中心使用了ZooKeeper，并且ZooKeeper的地址为127.0.0.1，启动端口为2181，服务提供方会将服务注册到该中心。</p> <p>代码4将接口与实现类设置到ServiceConfig实例；代码5设置服务分组与版本，在Dubbo中，“服务接口+服务分组+服务版本”唯一地确定一个服务，同一个服务接口可以有不同的版本以便服务升级等，另外每个服务接口可以属于不同分组，所以当调用方消费服务时一定要设置正确的分组与版本。</p> <p>代码7导出服务，启动NettyServer监听链接请求，并将服务注册到服务注册中心；代码8挂起线程，避免服务停止。</p> <p>下面我们看看Consumer模块是如果同步调用服务的，APiConsumer类的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		
		
		
		<span class="token comment">// 10.创建服务引用对象实例</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 11.设置应用程序信息</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 12.设置服务注册中心</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//直连测试</span>
		<span class="token comment">//referenceConfig.setUrl(&quot;dubbo://192.168.0.109:20880&quot;);</span>
		
		<span class="token comment">// 13.设置服务接口和超时时间</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 14.设置自定义负载均衡策略与集群容错策略</span>
		 referenceConfig<span class="token punctuation">.</span><span class="token function">setLoadbalance</span><span class="token punctuation">(</span><span class="token string">&quot;myroundrobin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 referenceConfig<span class="token punctuation">.</span><span class="token function">setCluster</span><span class="token punctuation">(</span><span class="token string">&quot;myCluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;30.10.67.231&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 15.设置服务分组与版本</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 16.引用服务</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 17. 设置隐式参数</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alibaba&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 18调用服务</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>代码9创建服务引用对象实例，其中泛型参数为GreetingService；代码10创建应用程序配置对象；代码11设置服务注册中心地址，可知服务注册中心使用了ZooKeeper，并且ZooKeeper的地址为127.0.0.1，启动端口为2181，服务消费端启动后会从该中心获取服务提供者地址列表。</p> <p>代码12设置服务接口和超时时间；代码13设置自定义负载均衡策略与集群容错策略，后面会具体讲解；代码14设置服务分组与版本，需要注意的是分组与版本要与服务提供者的分组与版本一致；代码15引用服务；代码16设置隐式参数，然后服务提供者就可以在服务实现类方法里获取参数值；代码17同步发起远程调用，然后当前线程会被阻塞直到服务提供方把结果返回。</p> <h3 id="_1-2-4-服务消费端异步调用服务"><a href="#_1-2-4-服务消费端异步调用服务" class="header-anchor">#</a> 1.2.4 服务消费端异步调用服务</h3> <p>上一节我们讲解的服务消费端是同步调用的，也就是说调用线程在服务提供方结果返回前需要被阻塞，异步调用则是说消费端发起调用后会马上返回。本节我们将介绍两种异步调用方式。</p> <h4 id="_1-dubbo-2-6-版本提供的异步调用"><a href="#_1-dubbo-2-6-版本提供的异步调用" class="header-anchor">#</a> 1.Dubbo 2.6.*版本提供的异步调用</h4> <p>首先我们看看第一种异步调用方式，也就是Consumer模块中的APiAsyncConsumer类：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token comment">//1.创建引用实例，并设置属性</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//2. 设置为异步</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//3. 直接返回null</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//4.等待结果</span>
		<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>代码1创建引用实例，并设置属性；代码2设置调用为异步；代码3进行服务引用并且调用sayHello（）方法，由于是异步调用，所以该方法马上返回null；代码4使用RpcContext.getContext（）.getFuture（）获取future对象，然后在需要获取真实响应结果的地方调用future.get（）来获取响应结果（调用future.get（）会阻塞调用线程直到结果返回）。</p> <p>上面介绍的基于从返回的future对象调用get（）方法实现异步的缺点是当业务线程调用get（）方法后业务线程会被阻塞，这不是我们想要的，所以Dubbo提供了在future对象上设置回调函数的方式，让我们实现真正的异步调用。下面是Consumer模块的APiAsyncConsumerForCallBack类：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.创建引用实例，并设置属性</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 2. 设置为异步</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3. 直接返回null</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.异步执行回调</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FutureAdapter</span><span class="token punctuation">)</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token class-name">Object</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;result:&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">caught</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;error:&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码不同之处在于代码4，在((FutureAdapter) RpcContext.getContext().getFuture()).getFuture()获取的future对象上可以调用setCallback（）方法设置一个回调函数，该回调函数有两个方法，当远端正常返回响应结果后，会回调done（）方法，其参数response就是响应结果值；当发起远程调用发生错误时会回调caught（）方法以打印错误信息</p> <p>设置回调的这种方式不会阻塞业务调用线程，这是借助了Netty的异步通信机制，Netty底层的I/O线程会在接收到响应后自动回调注册的回调函数，不需要业务线程干预。</p> <h4 id="_2-dubbo-2-7-版本提供的异步调用"><a href="#_2-dubbo-2-7-版本提供的异步调用" class="header-anchor">#</a> 2.Dubbo 2.7.*版本提供的异步调用</h4> <p>上面我们介绍了Dubbo 2.7.0版本前提供的异步调用方式，Future方式只支持阻塞式的get（）接口获取结果。虽然通过获取内置的ResponseFuture接口可以设置回调，但获取ResponseFuture的API使用起来不方便，并且无法满足让多个Future协同工作的场景，功能比较单一。下面我们讲解Dubbo 2.7.0版本提供的基于CompletableFuture的异步调用。</p> <p>下面是Consumer模块的APiAsyncConsumerForCompletableFuture2类：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.创建服务引用对象，并设置数据</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 2. 设置为异步</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3. 直接返回null</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.异步执行回调</span>
		<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCompletableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;over&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-2-5-服务提供端异步执行"><a href="#_1-2-5-服务提供端异步执行" class="header-anchor">#</a> 1.2.5 服务提供端异步执行</h3> <h4 id="_1-基于定义completablefuture签名的接口实现异步执行"><a href="#_1-基于定义completablefuture签名的接口实现异步执行" class="header-anchor">#</a> 1.基于定义CompletableFuture签名的接口实现异步执行</h4> <p>在Provider模块中，基于CompletableFuture签名的接口实现异步执行的接口实现类为GrettingServiceAsyncImpl，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrettingServiceAsyncImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrettingServiceAsync</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1.创建业务自定义线程池</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> bizThreadpool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;biz-thread-pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 2.创建服务处理接口，返回值为CompletableFuture</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 2.1 为supplyAsync提供自定义线程池bizThreadpool，避免使用JDK公用线程池(ForkJoinPool.commonPool())</span>
		<span class="token comment">// 使用CompletableFuture.supplyAsync让服务处理异步化进行处理</span>
		<span class="token comment">// 保存当前线程的上下文</span>
		<span class="token class-name">RpcContext</span> context <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;async return &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> context<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> bizThreadpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，基于定义CompletableFuture签名的接口实现异步执行需要接口方法的返回值为CompletableFuture，并且方法内部使用CompletableFuture.supplyAsync让本该由Dubbo内部线程池中的线程处理的服务，转换为由业务自定义线程池中的线程来处理，CompletableFuture.supplyAsync（）方法会马上返回一个CompletableFuture对象（所以Dubbo内部线程池中的线程会得到及时释放），传递的业务函数则由业务线程池bizThreadpool执行。</p> <p>需要注意的是，调用sayHello（）方法的线程是Dubbo线程模型线程池中的线程，而业务处理是由bizThreadpool中的线程处理的，所以代码2.1保存了RPC上下文对象（ThreadLocal变量），以便在业务处理线程中使用。</p> <p>然后，ApiProviderForAsync类用来发布服务，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiProviderForAsync</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

		<span class="token comment">// 1.创建服务发布实例，并设置</span>
		<span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrettingServiceAsync</span><span class="token punctuation">&gt;</span></span> serviceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrettingServiceAsync</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-provider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GrettingServiceAsync</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GrettingServiceAsyncImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 2.设置线程池策略</span>
		<span class="token comment">// HashMap&lt;String, String&gt; parameters = new HashMap&lt;&gt;();</span>
		<span class="token comment">// parameters.put(&quot;threadpool&quot;, &quot;mythreadpool&quot;);</span>
		<span class="token comment">// serviceConfig.setParameters(parameters);</span>

		<span class="token comment">// 3.导出服务</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.阻塞线程</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;server is started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码比较简单，这里就不再讲解了。服务发布后我们看看服务调用端如何调用。我们看看Consumer模块的APiConsumerForProviderAsync类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APiConsumerForProviderAsync</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token comment">//1.创建服务引用实例，并设置</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrettingServiceAsync</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrettingServiceAsync</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GrettingServiceAsync</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//referenceConfig.setCluster(&quot;myCluster&quot;);</span>

		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//2.服务引用</span>
		<span class="token class-name">GrettingServiceAsync</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//3.设置隐士参数</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alibaba&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//RpcContext.getContext().set(&quot;ip&quot;, &quot;30.39.148.197&quot;);</span>
		
		<span class="token comment">//4.获取future并设置回调</span>
		<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre></div><h4 id="_2-使用asynccontext实现异步执行"><a href="#_2-使用asynccontext实现异步执行" class="header-anchor">#</a> 2.使用AsyncContext实现异步执行</h4> <p>在Provider模块中，GrettingServiceAsyncContextImpl使用了AsyncContext实现异步执行，具体代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrettingServiceAsyncContextImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrettingServiceRpcContext</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1.创建业务自定义线程池</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> bizThreadpool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;biz-thread-pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 2.创建服务处理接口，返回值为CompletableFuture</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 2.1开启异步</span>
		<span class="token keyword">final</span> <span class="token class-name">AsyncContext</span> asyncContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bizThreadpool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">// 2.2 如果要使用上下文，则必须要放在第一句执行</span>
			asyncContext<span class="token punctuation">.</span><span class="token function">signalContextSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 2.3写回响应</span>
			asyncContext<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码1创建了一个自定义线程池用来执行业务处理；代码2.1调用RpcContext.startAsync（）方法开启服务异步执行，返回一个asyncContext，然后把服务处理任务提交到业务线程池后sayHello（）方法就直接返回了null；异步任务内首先执行代码2.2切换任务的上下文，然后休眠500ms充当任务执行；最后，代码2.3把任务执行结果写入异步上下文。</p> <p>这里由于具体执行业务处理的逻辑不在sayHello（）方法所在的Dubbo内部线程池的线程里，所以Dubbo框架的线程不会被阻塞。</p> <h3 id="_1-2-6-服务消费端泛化调用"><a href="#_1-2-6-服务消费端泛化调用" class="header-anchor">#</a> 1.2.6 服务消费端泛化调用</h3> <p>前面我们讲到，当基于Dubbo API搭建Dubbo服务时，服务消费端需要引入一个SDK二方包，其中存放着服务提供端提供的所有接口类。</p> <p>泛化接口调用方式主要在服务消费端没有API接口类及模型类元（比如入参和出参的POJO 类）的情况下使用，其参数及返回值中没有对应的POJO 类，所以所有POJO参数均转换为Map表示。使用泛化调用时，服务消费模块不再需要引入SDK二方包。</p> <p>在Dubbo中，根据序列化方式的不同，分为三种泛化调用，分别为true、bean和nativejava。</p> <h4 id="_1-generic-true方式"><a href="#_1-generic-true方式" class="header-anchor">#</a> 1.generic=true方式</h4> <p>在Consumer模块的APiGenericConsumerForTrue类中演示了这种方式，其代码如下：代码1创建引用实例，这里需要注意的是，在泛型调用时，泛型参数固定为GenericService；代码2设置泛化调用类型为true；代码3获取引用，注意泛化值类型固定为GenericService。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.泛型参数固定为GenericService</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GenericService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GenericService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 2. 设置为泛化引用，类型为true</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token string">&quot;com.books.dubbo.demo.api.GreetingService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGeneric</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3.用org.apache.dubbo.rpc.service.GenericService替代所有接口引用</span>
		<span class="token class-name">GenericService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.泛型调用， 基本类型以及Date,List,Map等不需要转换，直接调用,如果返回值为POJO也将自动转成Map</span>
		<span class="token class-name">Object</span> result <span class="token operator">=</span> greetingService<span class="token punctuation">.</span>$<span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;java.lang.String&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;world&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 5. POJO参数转换为map</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;com.books.dubbo.demo.api.PoJo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1990&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jiaduo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 6.发起泛型调用</span>
		result <span class="token operator">=</span> greetingService<span class="token punctuation">.</span>$<span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;testGeneric&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;com.books.dubbo.demo.api.PoJo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> map <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>代码4调用greetingService.$invoke（）方法，其中第一个参数为sayHello，说明要调用sayHello（）方法，第二个参数为sayHello的参数类型，第三个参数为sayHello参数的值。</p> <p>代码5和代码6是对方法testGeneric（）发起泛型调用，这里的第二个参数为testGeneric入参的POJO类型；第三个参数为入参的值，这里由于为POJO类，所以把POJO类的属性转换到了Map里，并且Map中固定有一个key为class的属性，其对应的value为第二个参数的包名加类名，这是为了在服务提供端进行反射使用。</p> <p>另外，由于这里的testGeneric（）方法返回值是Result类型，是POJO类，所以返回值也会被转换为Map。</p> <h4 id="_2-generic-bean方式"><a href="#_2-generic-bean方式" class="header-anchor">#</a> 2.generic=bean方式</h4> <p>在Consumer模块的APiGenericConsumerForBean类中演示了这种方式，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.泛型参数固定为GenericService</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GenericService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GenericService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 2. 设置为泛化引用，并且泛化类型为bean</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token string">&quot;com.books.dubbo.demo.api.GreetingService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGeneric</span><span class="token punctuation">(</span><span class="token string">&quot;bean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3.用org.apache.dubbo.rpc.service.GenericService替代所有接口引用</span>
		<span class="token class-name">GenericService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.泛型调用，参数使用JavaBean进行序列化</span>
		<span class="token class-name">JavaBeanDescriptor</span> param <span class="token operator">=</span> <span class="token class-name">JavaBeanSerializeUtil</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Object</span> result <span class="token operator">=</span> greetingService<span class="token punctuation">.</span>$<span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;java.lang.String&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> param <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 5.结果反序列化</span>
		result <span class="token operator">=</span> <span class="token class-name">JavaBeanSerializeUtil</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JavaBeanDescriptor</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>上面代码的不同之处在于代码2设置了泛型类型为bean，这意味着对参数使用JavaBean方式进行序列化，如代码4使用JavaBeanSerializeUtil.serialize把参数进行序列化，然后把序列化结果作为第三个参数，最后执行泛化调用。</p> <p>代码5对响应结果使用JavaBeanSerializeUtil.deserialize进行反序列化就可以得到我们可以理解的响应结果（之所以进行反序列化，是因为服务提供方会对返回结果进行序列化）。</p> <h4 id="_3-generic-nativejava方式"><a href="#_3-generic-nativejava方式" class="header-anchor">#</a> 3.generic=nativejava方式</h4> <p>在Consumer模块的APiGenericConsumerForNativeJava类中演示了这种方式，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.泛型参数固定为GenericService</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GenericService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GenericService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 2. 设置为泛化引用，并且泛化类型为nativejava</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token string">&quot;com.books.dubbo.demo.api.GreetingService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGeneric</span><span class="token punctuation">(</span><span class="token string">&quot;nativejava&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3.用org.apache.dubbo.rpc.service.GenericService替代所有接口引用</span>
		<span class="token class-name">GenericService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">UnsafeByteArrayOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.泛型调用， 需要把参数使用Java序列化为二进制</span>
		<span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Serialization</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_SERIALIZATION_NATIVE_JAVA</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Object</span> result <span class="token operator">=</span> greetingService<span class="token punctuation">.</span>$<span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;java.lang.String&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> out<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 5.打印结果，需要把二进制结果使用Java反序列为对象</span>
		<span class="token class-name">UnsafeByteArrayInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayInputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Serialization</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_SERIALIZATION_NATIVE_JAVA</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>上面代码的不同之处在于代码2设置了泛型类型nativejava，这意味着对参数使用nativejava方式进行序列化，如代码4使用nativejava对把参数进行序列化，然后把序列化结果作为第三个参数，最后执行泛化调用。</p> <p>代码5对响应结果使用nativejava进行反序列化就可以得到我们可以理解的响应结果（之所以进行反序列化，是因为服务提供方会对返回结果进行序列化）。</p> <h3 id="_1-2-7-服务消费端本地服务mock与服务降级"><a href="#_1-2-7-服务消费端本地服务mock与服务降级" class="header-anchor">#</a> 1.2.7 服务消费端本地服务mock与服务降级</h3> <h4 id="_1-本地服务mock"><a href="#_1-本地服务mock" class="header-anchor">#</a> 1.本地服务mock</h4> <p>服务消费端本地服务mock主要用来做本地测试用，当服务提供端服务不可用时，使用本地mock服务可以模拟服务提供端来让服务消费方测试自己的功能，而不需要发起远程调用，在Demo的Consumer模块中实现了mock功能。</p> <p>要实现mock功能，首先需要消费端先实现服务接口的mock实现类，在Demo中我们是对接口com.books.dubbo.demo.api.GreetingService进行模拟（mock）的，其mock实现类为com.books.dubbo.demo.api.GreetingServiceMock。需要注意的是，mock实现类必须要符合“接口包名.类名Mock”格式，否则启动时候会抛出“throw new IllegalStateException（&quot;No default constructor from mock class&quot;+mockClass.getName（），e）”异常，这在后面的高级篇会做讲解。</p> <p>Demo中的GreetingServiceMock类的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingServiceMock</span> <span class="token keyword">implements</span> <span class="token class-name">GreetingService</span><span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;mock value&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token class-name">PoJo</span> poJo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中的mock实现类比较简单，对于sayHello（）方法来说，mock返回mock value；对于testGeneric（）方法来说，mock返回null。</p> <p>创建完mock类后，我们看看在APiConsumerMock类中是如何开启mock功能的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APiConsumerMock</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 0.创建服务引用对象实例</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 1.设置应用程序信息</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 2.设置服务注册中心</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 3.设置服务接口和超时时间</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.设置服务分组与版本</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 5设置启动时候不检查服务提供者是否可用</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setCheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setMock</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 6.引用服务</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 7. 设置隐式参数</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alibaba&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 8调用服务</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，代码5设置启动时不检查服务提供端是否可用，然后设置mock为true开启mock功能，接着执行该类，并且保证GreetingServiceMock类的class文件位于classpath下，运行后会输出mock value字符串，说明mock功能生效了。</p> <p>需要注意的是，在执行mock服务实现类mock（）方法前，会先发起远程调用，当远程调用失败（比如服务不存在）时，才会降级执行mock功能。</p> <h4 id="_2-服务降级"><a href="#_2-服务降级" class="header-anchor">#</a> 2.服务降级</h4> <p>Dubbo提供了一些服务降级措施，当服务提供端某一个非关键的服务出错时，可以手动对消费端的调用进行降级，这样服务消费端就避免了再去调用出错的服务，以避免加重服务提供端的负担。</p> <p>下面我们看看Dubbo提供的两种服务降级策略如何使用。</p> <ul><li>force：return策略：当服务调用方设置某个接口的降级策略为这种方式时，服务调用方在调用该接口服务时会直接在客户端内返回设置的mock值，而不会在通过远程调用方式调用服务提供者，比如配置URL为override：<code>//0.0.0.0/com.books.dubbo.demo.api.GreetingService？category=configurators&amp;dynamic=false&amp;application=first-dubbo-consumer&amp;&quot;+&quot;mock=&quot;+type+&quot;：return+null&amp;group=dubbo&amp;version=1.0.0&quot;</code>，其中mock=force：return+null 表示服务调用方在调用该服务的方法时都直接返回mock 的null 值，而不发起远程调用。需要注意的是，在URL里要指明是对哪个接口的哪个分组的哪个版本的服务进行降级，另外category 必须为configurators，application 为你的服务调用方的应用名称，也就是ApplicationConfig 的name 值。override：//0.0.0.0/标识该降级策略对所有的服务消费者生效。该URL会被保存到ZooKeeper中，持久化存放该设置，当消费端启动时会获取到该配置。</li> <li>fail：return策略：表示服务调用方调用服务提供方的服务失败后再返回mock值，与force：return的区别是前者如果调用服务提供者成功，则返回正常的结果，如果调用失败则返回mock的值。这个功能和上一节讲解的本地服务mock功能一致。</li></ul> <p>在Demo的Consumer的APiConsumerMockResult类中演示了如何对一个服务进行降级设置：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APiConsumerMockResult</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mockResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// (1)获取服务注册中心工厂</span>
		<span class="token class-name">RegistryFactory</span> registryFactory <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">RegistryFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// (2)根据zk地址，获取具体的zk注册中心的客户端实例</span>
		<span class="token class-name">Registry</span> registry2 <span class="token operator">=</span> registryFactory<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// directory.subscribe(subscribeUrl.addParameter(CATEGORY_KEY,</span>
		<span class="token comment">// PROVIDERS_CATEGORY + &quot;,&quot; + CONFIGURATORS_CATEGORY + &quot;,&quot; + ROUTERS_CATEGORY));</span>

		<span class="token comment">// (3)注册降级方案到zk</span>
		registry2<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>
				<span class="token string">&quot;override://0.0.0.0/com.books.dubbo.demo.api.GreetingService?category=configurators&amp;dynamic=false&amp;application=first-dubbo-consumer&amp;&quot;</span>
						<span class="token operator">+</span> <span class="token string">&quot;mock=&quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;:return+null&amp;group=dubbo&amp;version=1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//(4)取消配置</span>
<span class="token comment">//		registry2.unregister(URL.valueOf(</span>
<span class="token comment">//				&quot;override://0.0.0.0/com.books.dubbo.demo.api.GreetingService?category=configurators&amp;dynamic=false&amp;application=first-dubbo-consumer&amp;&quot;</span>
<span class="token comment">//						+ &quot;mock=&quot; + type + &quot;:return+null&amp;group=dubbo&amp;version=1.0.0&quot;));</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

		<span class="token comment">// mock=force:result+null;</span>
		<span class="token function">mockResult</span><span class="token punctuation">(</span><span class="token string">&quot;force&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// mock=fail:result+null;</span>
		<span class="token comment">// mockResult(&quot;fail&quot;);</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码1通过增强SPI获取服务注册中心的工厂，这里获取的为ZooKeeper工厂，然后代码2获取ZooKeeper客户端，代码3将服务降级方案注册到ZooKeeper。其中参数type为降级方案（比如force或者fail），执行代码后，配置信息会被保存到服务注册中心，然后当消费端启动时会获取到该配置，并发返回null结果。当服务提供方的服务恢复后，可以执行上面代码4以取消服务降级方案。</p> <h3 id="_1-2-8-隐式参数传递"><a href="#_1-2-8-隐式参数传递" class="header-anchor">#</a> 1.2.8 隐式参数传递</h3> <p>在Consumer模块的APiConsumer类中使用隐式参数设置：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APiConsumer</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>

		<span class="token comment">// 17. 设置隐式参数</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alibaba&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 18调用服务</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码3在消费端发起远程调用前，通过RpcContext.getContext（）.setAttachment设置了key为company、value为alibaba的键值对，这个键值对会随着远程调用通过网络传递给服务提供端。下面我们看看Demo的Provider模块的GreetingServiceImpl类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GreetingService</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>上面的代码在服务提供端服务实现类中通过RpcContext.getContext（）.getAttachment （&quot;company&quot;）可以获取消费端传递的变量值。</p> <h3 id="_1-2-9-本地服务暴露与引用"><a href="#_1-2-9-本地服务暴露与引用" class="header-anchor">#</a> 1.2.9 本地服务暴露与引用</h3> <p>远程服务暴露与引用，是指提供方与消费方通过网络来进行通信，具体通信流程如图1.3所示。</p> <p><img src="/assets/img/image-20240513091704462.43409dec.png" alt="image-20240513091704462"></p> <p>其实Dubbo还提供了一种本地服务暴露与引用的方式，这在同一个JVM进程中同时发布与调用同一个服务时显得比较重要，因为如果当前JVM内要调用的服务在本JVM进程内有提供，则避免了一次远程过程调用，而是直接在JVM内进行通信，如图1.4所示。</p> <p><img src="/assets/img/image-20240513091731652.90d0c9cc.png" alt="image-20240513091731652"></p> <p>在Demo的Provider模块的APiConsumerInJvm类中演示了本地服务暴露与引用的实例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APiConsumerInJvm</span> <span class="token punctuation">{</span>

	<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.创建ServiceConfig实例</span>
		<span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> serviceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 2.设置应用程序配置</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-provider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3.设置服务注册中心信息</span>
		<span class="token class-name">RegistryConfig</span> registryConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span>registryConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 4.设置接口与实现类</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GreetingServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 5.设置服务分组与版本</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 6.设置线程池策略</span>

		<span class="token comment">// 7.导出服务</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 8.挂起线程，避免服务停止</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;server is started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">referService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 10.创建服务引用对象实例</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 12.设置服务注册中心</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 13.设置服务接口和超时时间</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setCheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 16.引用服务</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 17. 设置隐式参数</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alibaba&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 18调用服务</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 导出服务</span>
		<span class="token function">exportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 引用服务</span>
		<span class="token function">referService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，exportService（）方法导出服务（包含本地服务与远程服务），referService（）方法进行服务引用，由于在JVM内存在要引用的服务，所以实际是进行了本地调用，大家可以在InjvmInvoker的invoke（）方法内添加断点以便验证是否真的调用了本地服务。</p> <h2 id="_1-3-小结"><a href="#_1-3-小结" class="header-anchor">#</a> 1.3 小结</h2> <blockquote><p>本章首先初步介绍了Dubbo中各个组件之间的关系，然后基于本书的Demo讲解了Dubbo的基本使用方法，希望大家在使用ZooKeeper搭建起服务注册中心后，练习本书的Demo，以便对Dubbo的使用有深入的理解。</p></blockquote> <h2 id="高级篇"><a href="#高级篇" class="header-anchor">#</a> 高级篇</h2> <p>高级篇主要讲解Dubbo框架的内部实现原理，包含支撑Dubbo框架的适配器类原理、动态编译原理、增强SPI原理、消费端的泛化调用实现原理、消费端异步调用与服务提供端的异步执行、Dubbo框架的线程模型、消费端负载均衡策略、消费端集群容错策略、并发控制原理等。</p> <h2 id="第2章-dubbo框架内核原理剖析"><a href="#第2章-dubbo框架内核原理剖析" class="header-anchor">#</a> 第2章 Dubbo框架内核原理剖析</h2> <h2 id="_2-1-dubbo分层架构概述"><a href="#_2-1-dubbo分层架构概述" class="header-anchor">#</a> 2.1 Dubbo分层架构概述</h2> <p>本节我们从整体上来看看Dubbo的分层架构设计，架构分层是一个比较经典的模式，比如网络中的7层协议，每层执行固定的功能，上层依赖下层提供的功能，下层的改变对上层不可见等，并且每层都是一个可被替换的组件。</p> <p>图2.1是Dubbo官方提供的Dubbo整体架构图。</p> <blockquote><p>Dubbo官方提供的该架构图很复杂，一开始我们没必要深入细节，下面我们简单讲解一下其中的主要模块。</p></blockquote> <p><img src="/assets/img/image-20240513212123692.3d59ddb2.png" alt="image-20240513212123692"></p> <ul><li><p>Service和Config层为API接口层，是为了让Dubbo使用方方便地发布服务和引用服务；对于服务提供方来说需要实现服务接口，然后使用ServiceConfig API 来发布该服务；对于服务消费方来说需要使用ReferenceConfig 对服务接口进行代理。Dubbo服务发布与引用方可以直接初始化配置类，也可以通过Spring配置自动生成配置类。</p></li> <li><p>其他各层均为SPI（Service Provider Interface，服务提供者接口）层，SPI意味着下面各层都是组件化的，是可以被替换的，这也是Dubbo设计比较好的一点。</p> <blockquote><p>Dubbo增强了JDK中提供的标准SPI功能，在Dubbo中除了Service和Config层，其他各层都是通过实现扩展点接口来提供服务的；Dubbo增强的SPI增加了对扩展点IoC和AOP的支持，一个扩展点可以直接使用setter（）方法注入其他扩展点，并且不会一次性实例化扩展点的所有实现类，这就避免了当扩展点实现类初始化很耗时，但当前还没用上它的功能时仍进行加载实例化这种浪费资源的情况；增强的SPI是在具体用某一个实现类的时候才对具体实现类进行实例化。后续会具体讲解Dubbo增强的SPI的实现原理。</p></blockquote></li> <li><p>Proxy服务代理层：该层主要是对服务消费端使用的接口进行代理，把本地调用透明地转换为远程调用；另外对服务提供方的服务实现类进行代理，把服务实现类转换为Wrapper类，这是为了减少反射的调用，后面会具体讲解。</p> <blockquote><p>Proxy层的SPI扩展接口为ProxyFactory，Dubbo提供的实现类主要有JavassistProxyFactory（默认使用）和JdkProxyFactory，用户可以实现ProxyFactory SPI接口，自定义代理服务层的实现。</p></blockquote></li> <li><p>Registry 服务注册中心层：服务提供者启动时会把服务注册到服务注册中心，消费者启动时会去服务注册中心获取服务提供者的地址列表，<strong>Registry层主要功能是封装服务地址的注册与发现逻辑</strong>。</p> <blockquote><p>扩展接口Registry 对应的扩展实现为ZookeeperRegistry、RedisRegistry、MulticastRegistry、DubboRegistry等。扩展接口RegistryFactory 对应的扩展接口实现为DubboRegistryFactory、DubboRegistryFactory、RedisRegistryFactory、ZookeeperRegistryFactory。另外，该层扩展接口Directory实现类有RegistryDirectory、StaticDirectory，用来透明地把Invoker列表转换为一个Invoker；用户可以实现该层的一系列扩展接口，自定义该层的服务实现。</p></blockquote></li> <li><p>Cluster 路由层：封装多个服务提供者的路由规则、负载均衡、集群容错的实现，并桥接服务注册中心；</p> <blockquote><p>扩展接口Cluster 对应的实现类有FailoverCluster（失败重试）、FailbackCluster（失败自动恢复）、FailfastCluster（快速失败）、FailsafeCluster （失败安全）、ForkingCluster（并行调用）等；负载均衡扩展接口LoadBalance 对应的实现类为RandomLoadBalance（随机）、RoundRobinLoadBalance（轮询）、LeastActiveLoadBalance（最小活跃数）、ConsistentHashLoadBalance（一致性Hash）等。用户可以实现该层的一系列扩展接口，自定义集群容错和负载均衡策略。</p></blockquote></li> <li><p>Monitor 监控层：用来统计RPC 调用次数和调用耗时时间</p> <blockquote><p>扩展接口为MonitorFactory，对应的实现类为DubboMonitorFactroy。用户可以实现该层的MonitorFactory扩展接口，实现自定义监控统计策略。</p></blockquote></li> <li><p>Protocol 远程调用层：封装RPC 调用逻辑</p> <blockquote><p>扩展接口为Protocol，对应实现有RegistryProtocol、DubboProtocol、InjvmProtocol等。</p></blockquote></li> <li><p>Exchange 信息交换层：封装请求响应模式，同步转异步</p> <blockquote><p>扩展接口为Exchanger，对应的扩展实现有HeaderExchanger等</p></blockquote></li> <li><p>Transport网络传输层：Mina和Netty抽象为统一接口</p> <blockquote><p>扩展接口为Channel，对应的实现有NettyChannel（默认）、MinaChannel等；扩展接口Transporter对应的实现类有GrizzlyTransporter、MinaTransporter、NettyTransporter（默认实现）；扩展接口Codec2对应的实现类有DubboCodec、ThriftCodec等。</p></blockquote></li> <li><p>Serialize 数据序列化层：提供可以复用的一些工具</p> <blockquote><p>扩展接口为Serialization，对应的扩展实现有DubboSerialization、FastJsonSerialization、Hessian2Serialization、JavaSerialization等，扩展接口ThreadPool对应的扩展实现有FixedThreadPool、CachedThreadPool、LimitedThreadPool等。</p></blockquote></li></ul> <p>综上可知，Dubbo的分层架构使得Dubbo每层的功能都是可被替换的，这使得Dubbo的扩展性极强，上面说了那么多关于扩展点的东西，那么什么是扩展点呢？下面看看Dubbo扩展点的一个简单例子。以扩展点Protocol为例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Protocol</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>扩展点接口的类都含有@SPI注解，这里注解中的&quot;dubbo&quot;说明Protocol扩展接口SPI的默认实现是DubboProtocol。</p> <p>如果我们想自己写一个Protocol 扩展接口的实现类，那么我们需要在实现类所在的Jar 包内的META-INF/dubbo/目录下创建一个名字为org.apache.dubbo.rpc.Protocol 的文本文件，然后配置它的内容为：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">myprotocol</span><span class="token punctuation">=</span><span class="token value attr-value">com.alibaba.user.MyProtocol</span>
</code></pre></div><p>假设该实现类MyProtocol的内容如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProtocol</span> implemenets <span class="token class-name">Protocol</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么如何使用我们自定义的扩展实现呢？在Dubbo 配置模块中，扩展点均有对应配置属性或标签，如下代码通过配置标签方式指定使用哪个扩展实现：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myprotocol<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><h2 id="_2-2-dubbo远程调用细节"><a href="#_2-2-dubbo远程调用细节" class="header-anchor">#</a> 2.2 Dubbo远程调用细节</h2> <p>本节我们先从整体来看看Dubbo服务发布与消费的概要流程，以便对其中涉及的概念有个了解，更详细的过程后面的章节会具体讲解。</p> <h3 id="_2-2-1-服务提供者暴露一个服务的概要过程"><a href="#_2-2-1-服务提供者暴露一个服务的概要过程" class="header-anchor">#</a> 2.2.1 服务提供者暴露一个服务的概要过程</h3> <p>图2.2是服务提供者暴露一个服务的概要过程。</p> <p><img src="/assets/img/image-20240513214932063.8923452b.png" alt="image-20240513214932063"></p> <p>首先，ServiceConfig 类引用对外提供服务的实现类ref（如GreetingServiceImpl），然后通过ProxyFactory 接口的扩展实现类的getInvoker（）方法使用ref 生成一个AbstractProxyInvoker 实例，到这一步就完成了具体服务到Invoker 的转化。接下来就是Invoker转换到Exporter的过程。Dubbo协议的Invoker转为Exporter发生在DubboProtocol类的export （）方法中，Dubbo处理服务暴露的关键就在Invoker转换到Exporter的过程中，在这个过程中会先启动Netty Server监听服务连接，然后将服务注册到服务注册中心。</p> <h3 id="_2-2-2-服务消费者消费一个服务的概要过程"><a href="#_2-2-2-服务消费者消费一个服务的概要过程" class="header-anchor">#</a> 2.2.2 服务消费者消费一个服务的概要过程</h3> <p>图2.3为服务消费者消费一个服务的概要过程。</p> <p><img src="/assets/img/image-20240513215813983.91d66abe.png" alt="image-20240513215813983"></p> <p>首先ReferenceConfig类的init（）方法调用Protocol扩展接口实现类的refer（）方法生成Invoker 实例（如图2.3中的左上角部分），这是服务消费的关键。接下来把Invoker 转换为客户端需要的接口（如GreetingService）。</p> <p>Dubbo协议的Invoker转换为客户端需要的接口，发生在ProxyFactory接口的扩展实现类的getProxy（）方法中，它主要是使用代理对服务接口的调用转换为对Invoker的调用。</p> <h2 id="_2-3-dubbo的适配器原理"><a href="#_2-3-dubbo的适配器原理" class="header-anchor">#</a> 2.3 Dubbo的适配器原理</h2> <p>在前面谈论Dubbo的分层架构时，我们讲到，Dubbo为每个功能点提供了一个SPI扩展接口，Dubbo框架在使用扩展点功能的时候是对接口进行依赖的，而一个扩展接口对应了一系列的扩展实现类。那么如何选择使用哪一个扩展接口的实现类呢？其实这是使用适配器模式来做的。</p> <p>首先我们看看什么是适配器模式，比如Dubbo提供的扩展接口Protocol，其定义如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Protocol</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Adaptive</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dubbo会使用我们下一节将要讲解的动态编译技术为接口Protocol生成一个适配器类Protocol$Adaptive的对象实例，在Dubbo框架中需要使用Protocol的实例时，实际上就是使用Protocol$Adaptive的对象实例来获取具体的SPI实现类的，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>extension<span class="token punctuation">.</span></span><span class="token class-name">ExtensionLoader</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Protocol</span>$<span class="token class-name">Adaptive</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Exporter</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Invoker</span> arg0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg0 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;org.apache.dubbo.rpc.Invoker argument == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg0<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;org.apache.dubbo.rpc.Invoker argument getUrl() == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1)</span>
        <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>URL</span> url <span class="token operator">=</span> arg0<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2)</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> <span class="token punctuation">(</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;dubbo&quot;</span> <span class="token operator">:</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>extName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get extension (org.apache.dubbo.rpc.Protocol) name from url (&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) use keys([protocol])&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span> extension <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">)</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3)</span>
        <span class="token keyword">return</span> extension<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在Dubbo框架中，protocol的定义为：private static final Protocol protocol=Extension-Loader.getExtensionLoader（Protocol.class）.getAdaptiveExtension（）；，当调用protocol.export （wrapperInvoker）时，实际是调用Protocol$Adaptive的对象实例的export（）方法，然后后者根据wrapperInvoker中URL里面的协议类型参数执行；代码2使用Dubbo增强SPI方法getExtension（）获取对应的SPI实现类，然后调用代码3来执行具体SPI实现类的export（）方法。</p> <p>需要注意的是，在Dubbo中URL是一个核心概念，Dubbo框架把所需的参数都拼接到了URL对象里。这里假设代码2传递的协议类型为Dubbo，则说明使用增强SPI返回扩展接口Protocol的Dubbo实现，即返回了DubboProtocol的实例，那么代码3则返回调用DubboProtocol的export（）方法的返回结果，也就是说当框架调用protocol.export（wrapperInvoker）时，实际上是调用了DubboProtocol的export（）方法。</p> <p>总结一下就是，适配器类Protocol$Adaptive会根据传递的协议参数的不同，加载不同的Protocol的SPI实现。</p> <blockquote><p>其实在Dubbo框架中，框架会给每个SPI扩展接口动态生成一个对应的适配器类，并根据参数来使用增强SPI以选择不同的SPI实现。比如扩展接口ProxyFactory的适配器类为ProxyFactory$Adaptive，其根据参数proxy来选择使用JdkProxyFactory还是使用JavassistProxyFactory做代理工厂；扩展接口Registry的适配器类Registry$Adaptive则根据参数register来决定使用ZookeeperRegistry、RedisRegistry、MulticastRegistry、DubboRegistry中的哪一个作为服务注册中心等。</p></blockquote> <h2 id="_2-4-dubbo的动态编译原理"><a href="#_2-4-dubbo的动态编译原理" class="header-anchor">#</a> 2.4 Dubbo的动态编译原理</h2> <p>众所周知，Java程序要想运行首先需要使用javac把源代码编译为class字节码文件，然后使用JVM把class字节码文件加载到内存创建Class对象后，使用Class对象创建对象实例。正常情况下我们是把所有源文件静态编译为字节码文件，然后由JVM统一加载，而动态编译则是在JVM进程运行时把源文件编译为字节码文件，然后使用字节码文件创建对象实例。</p> <p>上一节我们提到，在Dubbo框架中框架会给每个SPI扩展接口动态生成一个对应的适配器类，那么如何生成呢？这里就使用了动态编译技术，在Dubbo中提供了一个Compiler的SPI：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">&quot;javassist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dubbo提供Compiler的实现有JavassistCompiler（默认实现）和JdkCompiler两种。</p> <p>这里我们从Dubbo框架如何使用动态编译生成扩展接口对应的适配器类入手，首先我们打开ExtensionLoader的createAdaptiveExtensionClass（）方法，就是该方法将<strong>源文件动态编译为Class对象的</strong>，有了Class对象后，我们就可以使用newInstance（）方法创建对象实例了：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">createAdaptiveExtensionClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1)</span>
  <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdaptiveClassCodeGenerator</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> cachedDefaultName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">findClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2)</span>
  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span></span>Compiler</span> compiler <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span></span>Compiler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3)</span>
  <span class="token keyword">return</span> compiler<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码1是根据SPI扩展接口生成其对应的适配器类的源码，其返回的是一个字符串。</p> <p>代码2使用增强SPI选择扩展接口Compiler的实现，这里默认为JavassistCompiler</p> <p>代码3调用JavassistCompiler的compile（）方法并根据源代码生成Protocol$Adaptive的Class对象。</p> <p>总结一下就是，Dubbo框架会为每个扩展接口生成其对应的适配器类的源码，然后选择具体的动态编译类的扩展实现对源码进行编译以生成适配器类的Class对象，然后就可以调用Class对象的newInstance（）方法生成扩展接口对应的适配器类的实例。</p> <h2 id="_2-5-dubbo增强spi"><a href="#_2-5-dubbo增强spi" class="header-anchor">#</a> 2.5 Dubbo增强SPI</h2> <p>前面我们讲解了Dubbo框架如何使用动态编译技术给每个扩展接口生成适配器类，并讲解了适配器类根据其中的参数来选择对应的SPI实现，下面我们讲解在适配器类中是如何根据参数来装载具体的SPI实现的。</p> <h3 id="_2-5-1-jdk标准spi"><a href="#_2-5-1-jdk标准spi" class="header-anchor">#</a> 2.5.1 JDK标准SPI</h3> <p>Dubbo增强的SPI功能是从JDK标准SPI演化而来的，所以有必要先讲讲标准SPI的原理。</p> <p>JDK 中的SPI是面向接口编程的，服务规则提供者会在JRE 的核心API 里提供服务访问接口，而具体实现则由其他开发商提供。</p> <p>例如，如果规范制定者在 rt.jar 包里定义了数据库的驱动接口 java.sql.Driver，那么MySQL实现的开发商则会在MySQL的驱动包的META-INF/services文件夹下建立名称为java.sql.Driver的文件，文件内容就是MySQL对java.sql.Driver接口的实现类，如图2.4所示。</p> <img src="/assets/img/image-20240514093019215.e9c9b2fa.png" alt="image-20240514093019215" style="zoom:50%;"> <p>通过如下代码可知，com.mysql.jdbc.Driver实现了java.sql.Driver接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>NonRegisteringDriver</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Driver</span>
</code></pre></div><p>上面讲解了如何使用SPI扩展自定义自己的实现，下面说说SPI的实现原理。我们知道Java核心API（比如rt.jar包）是使用Bootstrap ClassLoader类加载器加载的，而用户提供的Jar包是由AppClassLoader加载的。如果一个类由类加载器加载，那么这个类依赖的类也是由相同的类加载器加载的。</p> <p>用来搜索开发商提供的SPI 扩展实现类的API 类（ServiceLoader）是使用Bootstrap ClassLoader 加载的，那么ServiceLoader 里面依赖的类应该也是由Bootstrap ClassLoader加载的。而上面说了用户提供的包含SPI实现类的Jar包是由AppClassLoader加载的，所以这就需要一种违反双亲委派模型的方法，线程上下文类加载器ContextClassLoader就是用来解决这个问题的。</p> <p>下面我们写个测试代码，看看具体是如何工作了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// (1)</span>
    <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> loader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// (2)</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Driver</span> driver <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Driver</span><span class="token punctuation">)</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// (3)</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;driver:&quot;</span> <span class="token operator">+</span> driver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,loader:&quot;</span><span class="token operator">+</span>driver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getClassLoa
<span class="token function">der</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//（4）</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ServiceLoader loader:&quot;</span> <span class="token operator">+</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后引入MySQL驱动的Jar包，执行结果如下。</p> <div class="language- extra-class"><pre class="language-text"><code>driver:class com.mysql.jdbc.Driver , loader:sun.misc.Launcher$AppClassLoader@4554617c
current thread contextloader:sun.misc.Launcher$AppClassLoader@4554617c
ServiceLoader loader:null
</code></pre></div><p>从结果可知找到了MySQL的驱动，如果你在引入Oracle驱动的Jar包后再运行，则会输出找到了MySQL和Oracle的驱动，这也说明了，JDK标准的SPI会同时把SPI接口的所有实现类都提前加载好。</p> <p>另外从执行结果可以知道 ServiceLoader 的加载器 Bootstrap ，因为这里输出了null，并且从该类在 rt.jar 里面，也可以证明。</p> <p>下面我们来看下 ServiceLoader 的 load 方法源码。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// (5) 获取当前线程上下文加载器</span>
        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// (6)</span>
    <span class="token keyword">private</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> svc<span class="token punctuation">,</span><span class="token class-name">ClassLoader</span> cl<span class="token punctuation">)</span><span class="token punctuation">{</span>
        service <span class="token operator">=</span> svc<span class="token punctuation">;</span>
        loader <span class="token operator">=</span> cl<span class="token punctuation">;</span>
        <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码（5）获取了当前线程上下文加载器，这里是AppClassLoader。</p> <p>代码（6）传递该类加载器到新构造的ServiceLoader的成员变量loader。那么这个loader什么时候使用的呢？下面我们看下LazyIterator的next()方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>acc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">S</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">// (7) 使用loader类加载器加载</span>
        c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span><span class="token string">&quot;Provider &quot;</span><span class="token operator">+</span>cn<span class="token operator">+</span><span class="token string">&quot; not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码（7）使用loader也就是AppClassLoader加载具体的驱动实现类。至于cn是怎么来的，读者可以参见 LazyIterator 的 hasNext() 方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 在 jar 的 META-INF/services/ 下查找接口名称的文件并保存到 configs 中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> fullName <span class="token operator">=</span> <span class="token constant">PREFIX</span> <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        configs <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        configs <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Error locating configuration files&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 遍历每个文件</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>pending<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configs<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                pending <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            nextName <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-5-2-增强spi原理"><a href="#_2-5-2-增强spi原理" class="header-anchor">#</a> 2.5.2 增强SPI原理</h3> <p>Dubbo 的扩展点加载机制是基于JDK 标准的SPI 扩展机制增强而来的，Dubbo 解决了JDK标准的SPI的以下问题：</p> <ul><li>JDK标准的SPI会一次性实例化扩展点的所有实现，如果有些扩展实现初始化很耗时，但又没用上，那么加载就很浪费资源。</li> <li>如果扩展点加载失败，是不会友好地向用户通知具体异常的。比如：对于JDK 标准的ScriptEngine来说，如果Ruby ScriptEngine因为所依赖的jruby.jar不存在，导致Ruby ScriptEngine 类加载失败，那么这个失败原因就被隐藏了，当用户执行Ruby脚本时，会报空指针异常，而不是报Ruby ScriptEngine不存在。</li> <li>增加了对扩展点IoC和AOP的支持，一个扩展点可以直接使用setter（）方法注入其他扩展点，也可以对扩展点使用Wrapper类进行功能增强。</li></ul> <p>本节我们结合服务提供者配置类ServiceConfig 来讲解如何使用增强SPI 加载扩展接口Protocol的实现类，在ServiceConfig类中，有如下代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>这里的ExtensionLoader类似JDK标准SPI里的ServiceLoader类，代码ExtensionLoader.getExtensionLoader（Protocol.class）.getAdaptiveExtension（）的作用是获取Protocol接口的适配器类，在Dubbo中每个扩展接口都有一个对应的适配器类，前面所述这个适配器类是动态生成的一个类，这里我们给出Protocol扩展接口对应的适配器类的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>extension<span class="token punctuation">.</span></span><span class="token class-name">ExtensionLoader</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Protocol</span>$<span class="token class-name">Adaptive</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getDefaultPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;method public abstract int com.alibaba.dubbo.rpc.Protocol.getDefaultPort() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Invoker</span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span> arg0<span class="token punctuation">,</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>URL</span> arg1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>RpcException</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>arg1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;url == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>URL</span> url <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;dubbo&quot;</span> <span class="token operator">:</span> url<span class="token punctuation">.</span>getProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>extName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) use keys([protocol])&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span> extension <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">)</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> extension<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Exporter</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Invoker</span> arg0<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// (1)</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>URL</span> url <span class="token operator">=</span> arg0<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;dubbo&quot;</span> <span class="token operator">:</span> url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>extName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) use keys([protocol])&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (2)</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span> extension <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">)</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (3)</span>
        <span class="token keyword">return</span> extension<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以当我们调用protocol.export（invoker） 方法的时候实际调用的是动态生成的Protocol$Adaptive实例的export（invoker）方法，其内部代码1首先获取参数里的URL对象，然后从URL对象里获取用户设置的协议（Protocol）的实现类的名称，然后调用代码2根据名称获取具体的Protocol协议的实现类（<strong>后面我们会知道获取的是被使用Wrapper类增强后的实现类</strong>），最后代码3具体调用Protocol协议的实现类的export（invoker）方法。</p> <p>下面我们结合时序图来讲解ExtensionLoader的getAdaptiveExtension()方法是如何动态生成扩展接口对应的适配器类，以及getExtension方法如何根据扩展实现类的名称找到对应的实现类的：</p> <p><img src="/assets/img/1057539-20180524150543111-1863936250.5fd01048.png" alt="img"></p> <blockquote><p>这里的时序图严格来说有问题，分为两个步骤，但是图中合成了一个步骤</p></blockquote> <p>图2.5中的步骤1获取当前扩展接口对应的ExtensionLoader 对象，在Dubbo 中每个扩展接口对应着自己的ExtensionLoader对象，如下面的代码所示，内部通过并发Map来缓存扩展接口与对应的ExtensionLoader的映射，其中key为扩展接口的Class对象，value为对应的ExtensionLoader实例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ExtensionLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token keyword">class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Extension type == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Extension type(&quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;) is not interface!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">withExtensionAnnotation</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Extension type(&quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;) is not extension,because WITHOUT @&quot;</span> <span class="token operator">+</span> <span class="token constant">SPI</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; Annotation!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ExtensionLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> loader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token constant">EXTENSION_LOADERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>loader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token constant">EXTENSION_LOADERS</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ExtensionLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Extension</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token constant">EXTENSION_LOADERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>步骤2获取当前扩展接口对应的适配器对象，getAdaptiveExtension（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> instance <span class="token operator">=</span> cachedAdaptiveInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>createAdaptiveInstanceError <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">sychronized</span><span class="token punctuation">(</span>cachedAdaptiveInstance<span class="token punctuation">)</span><span class="token punctuation">{</span>
                instance <span class="token operator">=</span> cachedAdaptiveInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">try</span><span class="token punctuation">{</span>
                        instance <span class="token operator">=</span> <span class="token function">createAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cachedAdaptiveInstance<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        createAdaptiveInstanceError <span class="token operator">=</span> t<span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;fail to create adaptive instance: &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;fail to create adaptive instance:&quot;</span> <span class="token operator">+</span> createAdaptiveInstanceError<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>createAdaptiveInstanceError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码通过双重锁检查创建cachedAdaptiveInstance 对象，接口对应的适配器对象就保存到这个对象里。</p> <p>我们重点看看步骤3的createAdaptiveExtension（） 方法，因为具体创建适配器对象的是这个方法。createAdaptiveExtension（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">injectExtension</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token function">getAdaptiveExtensionClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Can not create adaptive extension &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;, cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>这里首先调用了步骤4的getAdaptiveExtensionClass（）.newInstance（）以获取适配器对象的一个实例，然后调用步骤7的injectExtension（） 方法进行扩展点相互依赖注入（扩展点之间的依赖自动注入）。下面首先看看步骤4的getAdaptiveExtensionClass（）方法是如何动态生成适配器类的Class对象的：</p> <blockquote><p>https://cn.dubbo.apache.org/zh-cn/docsv2.7/dev/source/adaptive-extension/</p> <p>@Adaptive 主要是用在方法上</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAdaptiveExtensionClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">getExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cachedAdaptiveClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> cachedAdaptiveClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cachedAdaptiveClass <span class="token operator">=</span> <span class="token function">createAdaptiveExtensionClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码首先调用了步骤5的getExtensionClasses（） 方法获取了该扩展接口所有实现类的Class 对象，然后调用了步骤6的createAdaptiveExtensionClass（） 方法创建具体的适配器对象的Class 对象。前面我们讲解过createAdaptiveExtensionClass（） 方法，该方法根据字符串代码生成适配器的Class 对象并返回，然后通过getAdaptiveExtensionClass（）.newInstance（）创建适配器类的一个对象实例。至此扩展接口的适配器对象已经创建完毕。</p> <blockquote><p>步骤5的getExtensionClasses（） 方法是如何加载扩展接口的所有实现类的Class对象的。其内部最终调用了loadExtensionClasses（）方法进行加载，loadExtensionClasses（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取扩展接口上SPI注解</span>
    <span class="token keyword">final</span> <span class="token class-name">SPI</span> defaultAnnotation <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token constant">SPI</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否存在注解</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>defaultAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> defaultAnnotation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> <span class="token constant">NAME_SEPARATOR</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;more than 1 default extension name on extension &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 默认实现类的名称放到cachedDefaultName</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>names<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> cachedDefaultName <span class="token operator">=</span> names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在指定目录的jar里面查找扩展点</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">loadFile</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span><span class="token constant">DUBBO_INTERNAL_DIRECTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// META/dubbo/internal/</span>
    <span class="token function">loadFile</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span><span class="token constant">DUBBO_DIRECTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// META-INF/dubbo/</span>
    <span class="token function">loadFile</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span><span class="token constant">SERVICES_DIRECTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// META-INF/services/</span>
    <span class="token keyword">return</span> extensionClasses<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>拿Protocol协议来说，这里SPI被注解为@SPI（&quot;dubbo&quot;），这里的cachedDefaultName就是dubbo。然后，loadDirectory（）方法到META-INF/dubbo/internal/、META-INF/dubbo/、META-INF/services/目录下去加载具体的扩展实现类，比如Protocol 协议默认实现类为DubboProtocol，如图2.6所示。</p> <p><img src="/assets/img/1057539-20180524180330584-2123255224.90e1ccde.png" alt="img"></p></blockquote> <p>步骤7的injectExtension（）方法进行扩展点实现类相互依赖自动注入（IoC功能）：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">injectExtension</span><span class="token punctuation">(</span><span class="token class-name">T</span> instance<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>objectFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 遍历扩展点实现类所有的方法</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> instance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 当前方法public的set方法，并且只有一个入参</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">// 获取参数类型</span>
                    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> pt <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span><span class="token punctuation">{</span>
                        <span class="token class-name">String</span> property <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">?</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLowerCase <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                        <span class="token comment">// 如果是则反射调用set方法</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;fail to inject via method &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>  <span class="token string">&quot; of  interface &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，ExtensionLoader 的getAdaptiveExtension（） 方法是如何动态生成扩展接口对应的适配器类以及如何加载扩展接口的实现类的Class对象的就讲解完了</p> <p>下面我们看看getExtension（）方法是如何根据扩展实现类的名称找到对应的实现类的：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> wrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Extension name == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getDefaultExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//从缓存中获取</span>
        <span class="token keyword">final</span> <span class="token class-name">Holder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> holder <span class="token operator">=</span> <span class="token function">getOrCreateHolder</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> instance <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不存在就双重加锁 创建实例并放入缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    instance <span class="token operator">=</span> <span class="token function">createExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> wrap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    holder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>其中createExtension（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> wrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//getExtensionClasses上面说过 会从dubbo spi的目录下扫描到所有类并缓存起来</span>
      <span class="token comment">//从这些类中获取指定的name 如果没有则说明不存在相应的实现类</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token function">getExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">findException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//先从缓存中获取</span>
            <span class="token class-name">T</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token constant">EXTENSION_INSTANCES</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//缓存中没有就通过反射获取实例</span>
                <span class="token constant">EXTENSION_INSTANCES</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token constant">EXTENSION_INSTANCES</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果扩展点实现类需要其他实现类则自动注入</span>
            <span class="token function">injectExtension</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wrapperClassesList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//增强类缓存 在getExtensionClasses的时候 从dubbo spi目录下扫描扩展类实现的时候</span>
                <span class="token comment">//如果发现某个实现类的构造函数只有一个 并且类型是扩展类 则说明这个类是扩展类的增强类</span>
                <span class="token comment">//加入增强类缓存中比如 ProtocolFilterWrapper, ProtocolListenerWrapper 都是protocol的增强类</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedWrapperClasses <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    wrapperClassesList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>cachedWrapperClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//对增强类的优先性进行排序</span>
                    wrapperClassesList<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">WrapperComparator</span><span class="token punctuation">.</span><span class="token constant">COMPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>wrapperClassesList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>wrapperClassesList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> wrapperClass <span class="token operator">:</span> wrapperClassesList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Wrapper</span> wrapper <span class="token operator">=</span> wrapperClass<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Wrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> <span class="token keyword">null</span>
                                <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">mismatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//把扩展类实例传入增强类的构造函数 创建增强类 并且把扩展类实例自动注入到增强类中</span>
                            instance <span class="token operator">=</span> <span class="token function">injectExtension</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> wrapperClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//返回增强类</span>
            <span class="token function">initExtension</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Extension instance (name: &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;, class: &quot;</span> <span class="token operator">+</span>
                    type <span class="token operator">+</span> <span class="token string">&quot;) couldn't be instantiated: &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>至此，如何使用getExtension（String name） 方法加载具体的扩展实现类也讲完了。上面我们讲解的getExtension（String name） 方法只会加载某一个扩展接口实现的Class对象的实例，但在有些情况下我们需要全部创建，比如ProtocolFilterWrapper类中的buildInvokerChain（）方法在建立Filter责任链时，需要把属于某一个group的所有Filter都放到责任链里，其是通过如下方式来获取属于某个组的Filter扩展实现类的：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>比如，当服务提供端启动时只会加载group为provider的Filter扩展实现类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Activate</span><span class="token punctuation">(</span>group <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PROVIDER</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">EXECUTES_KEY</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecuteLimitFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span>
</code></pre></div><p>当消费端启动时只会加载group为consumer的Filter扩展实现类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Activate</span><span class="token punctuation">(</span>group <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONSUMER</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ACTIVES_KEY</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActiveLimitFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span>
</code></pre></div><p>另外还需要注意，并不是所有属于某个group的Filter都会被加载，还需要看其设置的value的值是否在URL里（用户是否设置了该value的属性），比如ActiveLimitFilter在默认情况下是不会在服务消费端加载到Filter链的，只有当消费端设置了并发活跃数actives属性时才会（设置后actives属性就会出现在URL里了），具体内容可以参见9.1节。这里我们以加载Filter为例看看getActivateExtension（）方法的实现原理：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getActivateExtension</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getActivateExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">COMMA_SPLIT_PATTERN</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getActivateExtension</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> exts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names <span class="token operator">=</span> values <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>names<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REMOVE_VALUE_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 获取接口 org.apache.dubbo.rpc.Filter 的所有扩展实现</span>
            <span class="token function">getExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token comment">// 遍历 Filter 的所有实现</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> cachedActivates<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> activate <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> activateGroup<span class="token punctuation">,</span> activateValue<span class="token punctuation">;</span>

              <span class="token comment">// 2.1）如果含有注解 @Activate，则获取注解的 group 和 value 值</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>activate <span class="token keyword">instanceof</span> <span class="token class-name">Activate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activateGroup <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Activate</span><span class="token punctuation">)</span> activate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    activateValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Activate</span><span class="token punctuation">)</span> activate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>activate <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>extension<span class="token punctuation">.</span></span>Activate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activateGroup <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>extension<span class="token punctuation">.</span></span>Activate</span><span class="token punctuation">)</span> activate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    activateValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>extension<span class="token punctuation">.</span></span>Activate</span><span class="token punctuation">)</span> activate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token comment">// 2.2）如果当前扩展实现的组与我们传递的 group 匹配，且 value 值在 URL 中存在</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMatchGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> activateGroup<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">T</span> ext <span class="token operator">=</span> <span class="token function">getExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>names<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>names<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REMOVE_VALUE_PREFIX</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token function">isActive</span><span class="token punctuation">(</span>activateValue<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        exts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            exts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">ActivateComparator</span><span class="token punctuation">.</span><span class="token constant">COMPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1首先获取接口org.apache.dubbo.rpc.Filter的所有扩展实现，然后遍历所有扩展接口实现；代码2.2判断当前扩展实现所属分组是不是我们需要的group，如果是则还要看扩展接口实现的注解中的value值是否在URL中（这是isActive（）方法所做的事情），如下列代码所示：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keys<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 1）遍历当前扩展实现的 value 值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 2）遍历当前 URL 中的所有属性值</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> url<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> k <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 3）若 URL 中属性对的 key 等于扩展接口实现的 value 且值相等，则返回 true</span>
                <span class="token class-name">String</span> v <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> k<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 都不匹配返回 false</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>上面的代码遍历当前扩展实现的value值，如果发现某一个值在URL中，则返回true，否则返回false。</p> <h3 id="_2-5-3-扩展点的自动包装"><a href="#_2-5-3-扩展点的自动包装" class="header-anchor">#</a> 2.5.3 扩展点的自动包装</h3> <p>在Spring AOP中，我们可以使用多个切面对指定类的方法进行增强，在Dubbo中也提供了类似的功能。在Dubbo中你可以指定多个Wrapper类对指定的扩展点的实现类的方法进行增强。</p> <p>如下面的代码所示，当执行protocol.export（wrapperInvoker）方法时，实际调用的是适配器Protocol$Adaptive的export（）方法，如果URL对象里面的protocol为dubbo，那么在没有扩展点自动包装时，protocol.export（）方法返回的就是DubboProtocol的对象。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>wrapperInvoker<span class="token punctuation">)</span>l
</code></pre></div><p>而在真正的情况下，Dubbo里使用ProtocolFilterWrapper、ProtocolListenerWrapper等Wrapper类对DubboProtocol对象进行包装增强。</p> <blockquote><p>ProtocolFilterWrapper、ProtocolListenerWrapper、DubboProtocol（SPI的默认实现类） 三个类都有一个拷贝构造函数，这个拷贝构造函数的参数就是扩展接口Protocol。</p></blockquote> <p>所谓包装，其含义如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxxProtocolWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">Protocol</span> <span class="token punctuation">{</span>
 	<span class="token keyword">private</span> <span class="token class-name">Protocol</span> impl<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">XxxProtocol</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span> protocol<span class="token punctuation">)</span><span class="token punctuation">{</span>
    impl <span class="token operator">=</span> protocol<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 在调用 DubboProtcol 的 export 前做些事情</span>
    impl<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在调用 DubboProtcol 的 export 后做些事情</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>比如这里会进行两次包装，第一次使用ProtocolListenerWrapper类对DubboProtocol进行包装，这时ProtocolListenerWrapper类里的impl就是DubboProtocol，然后第二次使用ProtocolFilterWrapper对ProtocolListenerWrapper进行包装，也就是说ProtocolFilterWrapper里的impl是ProtocolListenerWrapper。这时调用适配器Protocol$Adaptive的export（）方法，如果URL对象里面的protocol为dubbo，那么在扩展点自动包装时，protocol.export返回的就是ProtocolFilterWrapper的实例了。</p> <p>下面我们看看在Dubbo增强的SPI中如何去收集这些包装类，以及使用包装类对SPI实现类的自动包装（AOP功能）是如何实现的</p> <p>其实，上一节所讲的getExtensionClasses 里面的loadDirectory（） 方法除了加载扩展接口的所有实现类的Class 对象，还对包装类（Wrapper类）进行了收集，下面我们看看loadDirectory-＞loadResource中的loadClass（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionClasses<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL</span> resourceURL<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurred when loading extension class (interface: &quot;</span> <span class="token operator">+</span>
                    type <span class="token operator">+</span> <span class="token string">&quot;, class line: &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;), class &quot;</span>
                    <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is not subtype of interface.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token comment">// 如果是适配器类，则调用 cacheAdaptiveClass() 做缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Adaptive</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cacheAdaptiveClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 如果是 Warpper 类，则调用 cacheWrapperClass() 方法做缓存</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWrapperClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cacheWrapperClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 剩下的则是扩展点的扩展实现类</span>
            clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                name <span class="token operator">=</span> <span class="token function">findAnnotationName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No such extension name for the class &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; in the config &quot;</span> <span class="token operator">+</span> resourceURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> <span class="token constant">NAME_SEPARATOR</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cacheActivateClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> n <span class="token operator">:</span> names<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">cacheName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">saveInExtensionClass</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 如果 clazz 的构造函数参数是 type 类型，则说明是 Wrapper 类</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isWrapperClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>上面的代码使用isWrapperClass（）方法方法判断clazz是否为Wrapper类，其中调用了clazz.getConstructor（type）方法来判断SPI实现类clazz是否有参数类型为type的构造函数。如果没有，则直接抛出异常NoSuchMethodException，该异常被catch块捕获了，然后返回false；如果有，则说明clazz 类为Wrapper 类，此时返回true并调用cacheWrapperClass（）方法将Wrapper类的Class对象收集起来放入cachedWrapperClasses 集合。至此，Wrapper类收集完毕。</p> <p>而对扩展实现类使用收集的Wrapper类进行自动包装是在createExtension （）方法里完成的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">// cachedWrapperClasses里面有元素，即为wrapper类</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wrapperClasses <span class="token operator">=</span> cachedWrapperClasses<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wrapperClasses <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wrapperClasses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 使用循环一层层对包装类进行包装，可以参考上面讲解的使用 ProtocolFilterWrapper / ProtocolListenerWrapper对DubboProtocol进行包装的流程</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> wrapperClass <span class="token operator">:</span> wrapperClasses<span class="token punctuation">)</span><span class="token punctuation">{</span>
                instance <span class="token operator">=</span> <span class="token function">injectExtension</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>wrapperClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码遍历了所有Wrapper类，并使用injectExtension一层层对扩展实现类进行功能增强。</p> <h2 id="_2-6-dubbo使用javaassist减少反射调用开销"><a href="#_2-6-dubbo使用javaassist减少反射调用开销" class="header-anchor">#</a> 2.6 Dubbo使用JavaAssist减少反射调用开销</h2> <p>Dubbo会给每个服务提供者的实现类生产一个Wrapper类，这个Wrapper类里面最终调用服务提供者的接口实现类，Wrapper类的存在是为了减少反射的调用。当服务提供方收到消费方发来的请求后，需要根据消费者传递过来的方法名和参数反射调用服务提供者的实现类，而反射本身是有性能开销的，Dubbo把每个服务提供者的实现类通过JavaAssist包装为一个Wrapper类以减少反射调用开销。那么Wrapper类为何能减少反射调用呢？</p> <p>假设我们的服务提供方实现类为GreetingServiceImpl，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GreetingService</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token class-name">PoJo</span> poJo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>那么其对应的Wrapper类的源码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Wrapper1</span> <span class="token keyword">extends</span> <span class="token class-name">Wrapper</span> <span class="token keyword">implements</span> <span class="token class-name">ClassGenerator</span>$<span class="token constant">DC</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvocationTargetException</span> <span class="token punctuation">{</span>
        <span class="token class-name">GreetingServiceImpl</span> greetingServiceImpl<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            greetingServiceImpl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GreetingServiceImpl</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                greetingServiceImpl<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>arrobject<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;testGeneric&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> greetingServiceImpl<span class="token punctuation">.</span><span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PoJo</span><span class="token punctuation">)</span> arrobject<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;setDepenededService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                helloServiceSlowImpl<span class="token punctuation">.</span><span class="token function">setDepenededService</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DepenededService</span><span class="token punctuation">)</span>array2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Not found method \&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot; in class com.books.dubbo.demo.provider.GreetingServiceImpl.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，Wrapper1类的invokeMethod最终直接调用的是GreetingServiceImpl的具体方法，这就避免了反射开销，而Wrapper1类是在Dubbo服务启动时生成的，所以不会对运行时带来开销。</p> <p>下面我们看看Dubbo是在哪里生成Wrapper类的。在Dubbo分层架构概述中，我们讲过Proxy层的SPI扩展接口为ProxyFactory，Dubbo 提供的实现主要有JavassistProxyFactory（默认使用）和JdkProxyFactory，其实就是JavassistProxyFactory为每个服务提供者实现类生成了Wrapper类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavassistProxyFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProxyFactory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 生成 Wrapper 类</span>
        <span class="token keyword">final</span> <span class="token class-name">Wrapper</span> wrapper <span class="token operator">=</span> <span class="token class-name">Wrapper</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'$'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AbstractProxyInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span>
                                      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span>
                                      <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> wrapper<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="_2-7-小结"><a href="#_2-7-小结" class="header-anchor">#</a> 2.7 小结</h2> <p>本章首先讲解了Dubbo框架的分层架构，除了最上面的两层，其他每层都是可以被替换的SPI组件，可知Dubbo是一个扩展性极强的框架；然后讲解了Dubbo核心的适配器原理以及增强SPI原理；最后讲解了Dubbo是如何使用JavaAssist减少反射调用开销的。本章内容是Dubbo框架的内核原理实现，后面的章节我们会具体针对每个SPI组件进行讲解。</p> <h2 id="第3章-远程服务发布与引用流程剖析"><a href="#第3章-远程服务发布与引用流程剖析" class="header-anchor">#</a> 第3章 远程服务发布与引用流程剖析</h2> <h2 id="_3-1-dubbo服务发布端启动流程剖析"><a href="#_3-1-dubbo服务发布端启动流程剖析" class="header-anchor">#</a> 3.1 Dubbo服务发布端启动流程剖析</h2> <p>首先我们通过一个时序图，直观地看看Dubbo服务提供方启动的流程，如图3.1所示。</p> <p><img src="/assets/img/image-20240515211933271.dab8ce5d.png" alt="image-20240515211933271"></p> <p>在2.2节中我们提到，服务提供方需要使用ServiceConfig API发布服务，具体来说就是执行图3.1中步骤1的export（）方法来激活发布服务。export（）方法的核心代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 这里是延迟发布</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>delay <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        delayExportExecutor<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">doExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token punctuation">,</span> delay <span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// 直接发布</span>
        <span class="token function">doExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> delayExportExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;DubboServiceDelayExporter&quot;</span> <span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过上面的代码可知，Dubbo 的延迟发布是通过使用ScheduledExecutorService 来实现的，可以通过调用ServiceConfig的setDelay（Integer delay）方法来设置延迟发布时间</p> <blockquote><p>如果没有设置延迟时间，则直接调用doExport（）方法发布服务；如果设置了延迟发布，则等时间过期后调用doExport（）方法来发布服务。</p></blockquote> <p>图3.1中的步骤2主要是根据ServiceConfig里面的属性进行合法性检查，这里我们主要看其内部最后调用的doExportUrls （）方法。</p> <p>图3.1中的步骤4通过调用loadRegistries（） 方法加载所有的服务注册中心对象，在Dubbo中，一个服务可以被注册到多个服务注册中心。</p> <p>图3.1中的步骤5是在doExportUrlsFor1Protocol（）方法内部首先把参数封装为URL（在Dubbo里会把所有参数封装到一个URL里），然后具体执行服务导出，其核心代码如下：代码1解析MethodConfig对象设置的方法级别的配置并保存到参数map中；代码2用来判断调用类型，如果为泛型调用，则设置泛型类型（true、nativejava或bean方式）；代码5用来导出服务，Dubbo服务导出分本地导出与远程导出，本地导出使用了injvm协议，是一个伪协议，它不开启端口，不发起远程调用，只在JVM 内直接关联，但执行Dubbo的Filter链；在默认情况下，Dubbo同时支持本地导出与远程导出协议，可以通过ServiceConfig的setScope（）方法设置，其中配置为none表示不导出服务，为remote表示只导出远程服务，为local表示只导出本地服务。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doExportUrlsFor1Protocol</span><span class="token punctuation">(</span><span class="token class-name">ProtocolConfig</span> protocolConfig<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1) 解析 MethodConfig 配置</span>
      
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
      <span class="token comment">// 2）如果为泛型调用，设置泛型类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isGeneric</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">,</span> generic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">METHODS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ANY_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 3）正常调用设置拼接 URL 的参数</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isDefault</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TOKEN_KEY</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TOKEN_KEY</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// export service 4）拼接 URL 对象</span>
        <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConfigedHosts</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">,</span> registryURLs<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> port <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConfigedPorts</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">,</span> name<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token function">getContextPath</span><span class="token punctuation">(</span>protocolConfig<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> p <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ConfiguratorFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">hasExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            url <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ConfiguratorFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 5）导出服务，本地服务，远程服务</span>
        <span class="token class-name">String</span> scope <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SCOPE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// don't export when none is configured</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SCOPE_NONE</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// export to local if the config is not remote (export to remote only when config is remote)</span>
          <span class="token comment">// 5.1）如果 scope 不是 SCOPE_REMOTE，则导出本地服务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SCOPE_REMOTE</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">exportLocal</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// export to remote if the config is not local (export to local only when config is local)</span>
          <span class="token comment">// 5.2）如果 scope 不是 SCOPE_LOCAL，则导出远程服务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SCOPE_LOCAL</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 5.2.1）如果有服务注册中心地址</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>registryURLs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token constant">URL</span> registryURL <span class="token operator">:</span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> registryURL<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">EXPORT_KEY</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">toFullString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">DelegateProviderMetaDataInvoker</span> wrapperInvoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>wrapperInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 5.2.2）直连方式</span>
                    <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">DelegateProviderMetaDataInvoker</span> wrapperInvoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>wrapperInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/**
                 * @since 2.7.0
                 * ServiceData Store
                 */</span>
              <span class="token comment">// 5.2.3） 元数据存储</span>
                <span class="token class-name">MetadataReportService</span> metadataReportService <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>metadataReportService <span class="token operator">=</span> <span class="token function">getMetadataReportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    metadataReportService<span class="token punctuation">.</span><span class="token function">publishProvider</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>如果使用MetadataReportConfig设置了元数据存储信息，代码5.2.3则将元数据保存到指定配置中心。在Dubbo 2.7.0中对服务元数据进行了改造，其把原来都保存到服务注册中心的元数据进行了分类存储，注册中心将只用于存储关键服务信息，比如服务提供者地址列表、完整的接口定义等。Dubbo 2.7.0使用更专业的配置中心，如Nacos、Apollo、Consul和Etcd等，提供更灵活、更丰富的配置规则，包括服务和应用不同粒度的配置、更丰富的路由规则和集中式管理的动态参数规则等。</p> <p>https://dubbo.apache.org/zh-cn/overview/reference/proposals/registry-config-meta/</p></blockquote> <p>另外，服务提供端导出服务具体使用的是下列代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>                    <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">DelegateProviderMetaDataInvoker</span> wrapperInvoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>wrapperInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其中，proxyFactory和protocol的定义为：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ProxyFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>由此可知，proxyFactory和protocol都是扩展接口的适配器类。</p> <h4 id="服务提供方实现类到invoker的转换"><a href="#服务提供方实现类到invoker的转换" class="header-anchor">#</a> 服务提供方实现类到Invoker的转换</h4> <p>执行代码proxyFactory.getInvoker（ref，（Class） interfaceClass，url） 时，我们发现实际上是首先执行扩展接口ProxyFactory 的适配器类ProxyFactory$Adaptive 的getInvoker（）方法，其内部根据URL里的proxy的类型选择具体的代理工厂，这里默认proxy 类型为javassist，所以又调用了JavassistProxyFactory的getInvoker（）方法获取了代理类。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO Wrapper cannot handle this scenario correctly: the classname contains '$'</span>
        <span class="token keyword">final</span> <span class="token class-name">Wrapper</span> wrapper <span class="token operator">=</span> <span class="token class-name">Wrapper</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'$'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AbstractProxyInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span>
                                      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span>
                                      <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> wrapper<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>根据前面章节介绍的内容可知，这里首先把服务实现类转换为Wrapper 类，是为了减少反射的调用，这里返回的是AbstractProxyInvoker对象，其内部重写doInvoke（）方法，并委托给Wrapper 实现具体功能。到这里就完成了2.2节中讲解的服务提供方实现类到Invoker的转换。</p> <blockquote><img src="/assets/img/image-20240515210803107.5d7c96b1.png" alt="image-20240515210803107" style="zoom:25%;"></blockquote> <h4 id="远程服务暴露流程"><a href="#远程服务暴露流程" class="header-anchor">#</a> 远程服务暴露流程</h4> <p>另外，当执行protocol.export（wrapperInvoker） 方法的时候，实际调用了Protocol 的适配器类Protocol$Adaptive 的export（） 方法。</p> <blockquote><p>如果为远程服务暴露，则其内部根据URL中Protocol的类型为registry，会选择Protocol 的实现类RegistryProtocol。如果为本地服务暴露，则其内部根据URL 中Protocol的类型为injvm，会选择Protocol 的实现类InjvmProtocol。但由于Dubbo SPI 的扩展点使用了Wrapper 自动增强，这里就使用了ProtocolFilterWrapper、ProtocolListenerWrapper、QosProtocolWrapper 对其进行了增强，所以需要一层层调用才会调用到RegistryProtocol的export（）方法。本节我们只讲解远程服务暴露流程。</p></blockquote> <p>图3.1中步骤10的RegistryProtocol中的export（）方法通过步骤11的doLocalExport启动了NettyServer进行监听服务，步骤12、步骤13则将当前服务注册到服务注册中心。到这里就完成了2.2节中谈到的Invoker到Exporter的转换。</p> <h4 id="如何启动nettyserver"><a href="#如何启动nettyserver" class="header-anchor">#</a> 如何启动NettyServer</h4> <p>下面我们首先看看doLocalExport是如何启动NettyServer的。doLocalExport内部主要调用DubboProtocol的export（）方法，下面看看如图3.2所示的时序图。</p> <p><img src="/assets/img/image-20240515212045260.90db36cc.png" alt="image-20240515212045260"></p> <p>从图3.2可以看到，在RegistryProtocol的doLocalExport（）方法内调用了Protocol的适配器类Protocol$Adaptive，这里URL内的协议类型是dubbo，所以返回的SPI扩展实现类是DubboProtocol，由于DubboProtocol也被Wrapper类增强了，所以也是一层层调用后，才执行到图3.2中的步骤8，即调用DubboProtocol的export （）方法。export（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// Invoker 到 Exporter 的转换</span>
        <span class="token comment">// export service.</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">serviceKey</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> key<span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exporterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 同一个机器的不同服务导出只会开启一个 NettyServer</span>
        <span class="token function">openServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">optimizeSerialization</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> exporter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里将Invoker 转换为DubboExporter 对象，并且把DubboExporter保存到了缓存exporterMap里（在服务提供方处理请求时会从中获取出来），然后执行图3.2中步骤10的openServer（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ExchangeServer</span><span class="token punctuation">&gt;</span></span> serverMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
		<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">openServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// find server.</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//client can export a service which's only for server to invoke</span>
        <span class="token keyword">boolean</span> isServer <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">IS_SERVER_KEY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ExchangeServer</span> server <span class="token operator">=</span> serverMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    server <span class="token operator">=</span> serverMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        serverMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">createServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// server supports reset, use together with override</span>
                server<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，这里首先是获取当前机器地址信息（ip：port）并作为key，然后判断当前是否为服务提供端。如果是，则以此key为key查看缓存serverMap中是否有对应的Server，如果没有则调用createServer（）方法来创建，否则返回缓存中的value。</p> <blockquote><p>由于每个机器的ip：port是唯一的，所以多个不同服务启动时只有第一个会被创建，后面的服务都是直接从缓存中返回的。</p></blockquote> <p>接着一步步会执行到如图3.3所示的时序图中的步骤7，即NettyTransporter 的bind（）方法，这里由于Transporter是扩展接口，所以需要先经过其适配器类Transporter$Adaptive来根据URL里的参数做选择扩展实现。</p> <p><img src="/assets/img/image-20240515213912847.23cc1b42.png" alt="image-20240515213912847"></p> <p>在默认情况下，传输扩展实现选择的是Netty，而Netty对应的扩展实现为：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">netty</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.remoting.transport.netty4.NettyTransporter</span>
</code></pre></div><p>下面，我们看看NettyTransporter的bind（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在NettyServer的构造函数内部又调用了其父类AbstractServer的构造函数，后者构造函数的内容如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AbstractServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Start &quot;</span> <span class="token operator">+</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; bind &quot;</span> <span class="token operator">+</span> <span class="token function">getBindAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, export &quot;</span> <span class="token operator">+</span> <span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemotingException</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">toInetSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed to bind &quot;</span> <span class="token operator">+</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot; on &quot;</span> <span class="token operator">+</span> <span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, cause: &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，NettyServer 的doOpen（）方法启动了服务监听，其中doOpen（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建 ServerBootstrap</span>
        bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置 Netty 的 boss 线程池和 worker 线程池</span>
        bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;NettyServerBoss&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPositiveParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">IO_THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_IO_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;NettyServerWorker&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 配置 NettyServer，添加 handler 到管线</span>
        <span class="token keyword">final</span> <span class="token class-name">NettyServerHandler</span> nettyServerHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channels <span class="token operator">=</span> nettyServerHandler<span class="token punctuation">.</span><span class="token function">getChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_REUSEADDR</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">ALLOCATOR</span><span class="token punctuation">,</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// FIXME: should we use getTimeout()?</span>
                      <span class="token comment">// 添加 handler 到接收连接的管线</span>
                        <span class="token keyword">int</span> idleTimeout <span class="token operator">=</span> <span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">getIdleTimeout</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">NettyCodecAdapter</span> adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyCodecAdapter</span><span class="token punctuation">(</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NettyServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//.addLast(&quot;logging&quot;,new LoggingHandler(LogLevel.INFO))//for debug</span>
                                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 解码器</span>
                                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 编码器</span>
                                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;server-idle-handler&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> idleTimeout<span class="token punctuation">,</span> <span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;handler&quot;</span><span class="token punctuation">,</span> nettyServerHandler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 业务 handler</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// bind</span>
      <span class="token comment">// 绑定本地端口，并启动监听服务</span>
        <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">getBindAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channelFuture<span class="token punctuation">.</span><span class="token function">syncUninterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>至此，服务提供方的NettyServer已经启动了，这里需要注意是，将NettyServerHandler和编解码Handler注册到了每个接收链接的通道（channel）管理的管线中，这些Handler的详细说明在后面的章节会具体讲解。</p> <h4 id="将服务注册到服务注册中心"><a href="#将服务注册到服务注册中心" class="header-anchor">#</a> 将服务注册到服务注册中心</h4> <p>最后，我们看看在启动NettyServer后如何将服务注册到服务注册中心，这里我们使用ZooKeeper作为服务注册中心。接着上面的图3.1中步骤12的流程，我们先看看RegistryProtocol中export（）方法里的getRegistry（）方法是如何获取服务注册中心和注册服务的，首先看看如图3.4所示的时序图。</p> <p><img src="/assets/img/image-20240515215048463.e3126b2b.png" alt="image-20240515215048463"></p> <p>3.4中的步骤2用来获取服务注册中心，其中RegistryFactory为扩展接口，所以这里通过适配器类来确定RegistryFactory的扩展实现为ZookeeperRegistryFactory，然后后者内部调用createRegistry（）方法创建了一个ZookeeperRegistry作为ZooKeeper注册中心。其中ZookeeperRegistryFactory的getRegistry（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Registry</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token class-name">RegistryService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">INTERFACE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">RegistryService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">removeParameters</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">EXPORT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REFER_KEY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toServiceStringWithoutResolving</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Lock the registry access process to ensure a single instance of the registry</span>
        <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token constant">REGISTRIES</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>registry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> registry<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//create registry by spi/ioc</span>
            registry <span class="token operator">=</span> <span class="token function">createRegistry</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>registry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Can not create registry &quot;</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token constant">REGISTRIES</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> registry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Release the lock</span>
            <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 独占锁</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> <span class="token constant">LOCK</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 缓存</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">&gt;</span></span> <span class="token constant">REGISTRIES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Registry</span> <span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> zookeeperTransporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


</code></pre></div><p>在图3.4的步骤6中，register（）方法最终调用了zkClient的create（）方法将服务注册到ZooKeeper：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            zkClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">toUrlPath</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DYNAMIC_KEY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register &quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot; to zookeeper &quot;</span> <span class="token operator">+</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>其中，create（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkExists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createEphemeral</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">createPersistent</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>比如，以com.books.dubbo.demo.api.GreetingService服务接口为例，则其URL为：</p> <img src="/assets/img/image-20240515223309926.3d2bb6e5.png" alt="image-20240515223309926" style="zoom:33%;"> <img src="/assets/img/image-20240515223323267.b99afc5b.png" alt="image-20240515223323267" style="zoom:33%;"> <p>经过toUrlPath转换后为：</p> <p><img src="/assets/img/image-20240515223402314.84d1e358.png" alt="image-20240515223402314"></p> <p>create（）方法是递归函数，首先其调用了方法createPersistent（）分别创建了节点/dubbo、/dubbo/com.books.dubbo.demo.api.GreetingService 和/dubbo/com.books.dubbo.demo.api.GreetingService/providers，然后调用createEphemeral（）方法创建了下列内容：</p> <p>服务注册到ZooKeeper后，ZooKeeper服务端的最终树图结构如图3.5所示。</p> <p><img src="/assets/img/image-20240515223505157.6910efcf.png" alt="image-20240515223505157"></p> <p>通过图3.5可知，机器192.168.0.1作为com.books.dubbo.demo.api.GreetingService服务的提供者，第一层Root节点说明ZooKeeper的服务分组为Dubbo，第二层Service节点说明注册的服务为com.books.dubbo.demo.api.GreetingService接口，第三层Type节点说明是为服务提供者注册的服务，第四层URL记录服务提供者的地址信息（这里只是简单地显示了服务提供者的IP信息，对于真实情况则不只是IP信息）。</p> <blockquote><p>第一个服务提供者注册时需要ZooKeeper服务端创建第一层的Dubbo节点、第二层的Service节点、第三层的Type节点，但是同一个Service的其他机器在注册服务时因为上面三层节点已经存在了，所以只需在Providers下也就是第四层插入服务提供者信息节点就可以了。</p></blockquote> <p>服务注册到ZooKeeper 后，消费端就可以在Providers节点下找到com.books.dubbo.demo.api.GreetingService服务的所有服务提供者，然后根据设置的负载均衡策略选择机器进行远程调用了。</p> <h2 id="_3-2-dubbo服务提供方如何处理请求"><a href="#_3-2-dubbo服务提供方如何处理请求" class="header-anchor">#</a> 3.2 Dubbo服务提供方如何处理请求</h2> <p>我们先看看当消费端发起TCP链接并完成后，在接收消费端发来的请求时，服务提供方是如何处理的，其处理时序图如图3.6所示。</p> <p><img src="/assets/img/image-20240516202428897.60d124f6.png" alt="image-20240516202428897"></p> <h4 id="conneted"><a href="#conneted" class="header-anchor">#</a> conneted</h4> <p>图3.6中的connected部分（步骤1～步骤11），消费端发起TCP链接并完成后，服务提供方的NettyServer的connected方法会被激活，该方法的执行是在Netty的I/O线程上执行的，为了可以及时释放I/O线程，Netty默认的线程模型为All正如在第7章所介绍的，所有消息都派发到Dubbo内部的业务线程池，这些消息包括请求事件、响应事件、连接事件、断开事件、心跳事件等，这里对应的是AllChannelHandler类把I/O线程接收到的所有消息包装为ChannelEventRunnable任务并都投递到了线程池里。</p> <p>线程池里的任务被执行后，最终会调用DubboProtocol的connected（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
  <span class="token function">invoke</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ON_CONNECT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">String</span> methodKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1）创建 Invocation 对象</span>
  <span class="token class-name">Invocation</span> invocation <span class="token operator">=</span> <span class="token function">createInvocation</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2）不为 null 则调用 received 进行处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>invocation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">received</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to invoke event method &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;(), cause: &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中，createInvocation（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">private</span> <span class="token class-name">Invocation</span> <span class="token function">createInvocation</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> methodKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 3）如果 URL 里面不包含 key，则直接返回 null</span>
            <span class="token class-name">String</span> method <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>methodKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> method<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token comment">// 4）根据 method 创建 RPCInvocation 对象</span>
            <span class="token class-name">RpcInvocation</span> invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcInvocation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PATH_KEY</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GROUP_KEY</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GROUP_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">INTERFACE_KEY</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">INTERFACE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">VERSION_KEY</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">VERSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">STUB_EVENT_KEY</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">STUB_EVENT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> invocation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>在这里的URL内不包含Constants.ON_CONNECT_KEY，所以直接返回了null。</p> <h4 id="received"><a href="#received" class="header-anchor">#</a> received</h4> <p>图3.6中的received部分（步骤12～步骤22）类似于connected，received事件被投递到线程池后进行异步处理。线程池任务被激活后调用了HeaderExchangeHandler的received（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        channel<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">KEY_READ_TIMESTAMP</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ExchangeChannel</span> exchangeChannel <span class="token operator">=</span> <span class="token class-name">HeaderExchangeChannel</span><span class="token punctuation">.</span><span class="token function">getOrAddChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 5）请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token keyword">instanceof</span> <span class="token class-name">Request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// handle request.</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> message<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handlerEvent</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 5.1）需要有返回值的请求，req-res，towway</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">handleRequest</span><span class="token punctuation">(</span>exchangeChannel<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      <span class="token comment">// 5.2）不需要有返回值的请求req，oneway</span>
                        handler<span class="token punctuation">.</span><span class="token function">received</span><span class="token punctuation">(</span>exchangeChannel<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token comment">//6）响应</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token keyword">instanceof</span> <span class="token class-name">Response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">handleResponse</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">)</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果请求不需要响应结果则直接调用DubboProtocol的received（）方法，否则执行handleRequest（）方法，后者代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ExchangeChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Request</span> req<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Response</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      。。。
        <span class="token comment">// find handler by message class.</span>
        <span class="token class-name">Object</span> msg <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// handle data.</span>
          <span class="token comment">// 调用 DubboProtocol 的 reply 方法</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">reply</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 如果请求已经完成，则设置结果并写回</span>
                res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 否则等返回结果后异步调用回调</span>
            future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Send result to consumer failed, channel is &quot;</span> <span class="token operator">+</span> channel <span class="token operator">+</span> <span class="token string">&quot;, msg is &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// HeaderExchangeChannel.removeChannelIfDisconnected(channel);</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果请求需要返回值则执行handleRequest（）方法，其也是委托给DubboProtocol的reply（）方法来执行的。如果执行结果已经完成，则直接将结果写回消费端，否则使用异步回调方式（避免当前线程被阻塞），等执行完毕并拿到结果后再把结果写回消费端。</p> <p>通过图3.6可知，无论消费端是否需要执行结果，最终都是DubboProtocol类的reply（）方法来执行具体的服务，下面我们看看reply（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">reply</span><span class="token punctuation">(</span><span class="token class-name">ExchangeChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">Invocation</span> inv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Invocation</span><span class="token punctuation">)</span> message<span class="token punctuation">;</span>
          <span class="token comment">// 7）获取调用放到对应的 Invoker</span>
            <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token function">getInvoker</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 8）获取上下文对象，并设置对端地址</span>
            <span class="token class-name">RpcContext</span> rpcContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rpcContext<span class="token punctuation">.</span><span class="token function">setRemoteAddress</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 9）执行 invoker 调用链</span>
            <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 10）写回结果</span>
          <span class="token comment">// 如果结果为 AsyncRpcResult 说明为服务提供方的异步执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 否则为同步执行，则转换结果为 CompletableFuture</span>
                <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>代码7首先使用getInvoker（）方法获取调用方法对应的DubboExporter对象导出的Invoker对象，具体代码如下。在3.1节中我们介绍了导出的DubboExporter对象会保存到exporterMap中，这里的getInvoker获取的是RegistryProtocol$InvokerDelegate：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> inv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">String</span> serviceKey <span class="token operator">=</span> <span class="token function">serviceKey</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> path<span class="token punctuation">,</span> inv<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">VERSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inv<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GROUP_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> exporterMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> exporter<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码8把对端的地址设置到上下文对象中。</p> <p>代码9 执行导出的Invoker的invoke（）方法，这里有个调用链，经过调用链后最终调用了服务提供方启动时AbstractProxyInvoker代理类创建的invoke（）方法，其调用时序如图3.7所示。</p> <p><img src="/assets/img/image-20240516211422656.442ce9fa.png" alt="image-20240516211422656"></p> <p>图3.7显示的是调用DubboProtocol的reply（）方法的情况，在调用InvokerDelegate的invoke（）方法前会先经过Filter链（这里只列出来了Filter链中的一部分Filter），然后InvokerDelegate会调用服务提供方启动时AbstractProxyInvoker代理类的invoke（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取上下文对象</span>
        <span class="token class-name">RpcContext</span> rpcContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 11.1）具体执行本地服务调用</span>
            <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token comment">// 11.2）返回结果</span>
          <span class="token comment">// 返回结果是 CompletableFuture 类型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isReturnTypeFuture</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcContext<span class="token punctuation">.</span><span class="token function">isAsyncStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ignore obj in case of RpcContext.startAsync()? always rely on user to write back.</span>
              <span class="token comment">// 使用 RpcContext.startAsync() 开启异步执行</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AsyncContextImpl</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rpcContext<span class="token punctuation">.</span><span class="token function">getAsyncContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInternalFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 同步执行时候</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码11获取上下文对象，代码11.1调用doInvoke（）方法，并使用JavaAssist来执行本地服务，以便减少反射调用，这里我们再回顾一下doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO Wrapper cannot handle this scenario correctly: the classname contains '$'</span>
        <span class="token keyword">final</span> <span class="token class-name">Wrapper</span> wrapper <span class="token operator">=</span> <span class="token class-name">Wrapper</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'$'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AbstractProxyInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span>
                                      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span>
                                      <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> wrapper<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，AbstractProxyInvoker的doInvoke（）方法委托Wrapper类的invokeMethod执行具体逻辑，后者则通过调用服务提供方接口的实现类来执行本地服务，细节可参考<strong>2.5.4</strong>小节。</p> <blockquote><p>需要注意的是，步骤11.2返回的结果是区分情况的，如果返回值类型为CompletableFuture，或者如果是使用RpcContext.startAsync（）开启异步执行的，则返回AsyncRpcResult对象，否则返回正常的RpcResult对象，我们在随后的11.2.1小节中会用到这些内容。</p> <p>另外，如果代码10发现结果为AsyncRpcResult，则说明是服务提供方的异步执行，此时返回对应的CompletableFuture对象，如果返回的是正常的RpcResult结果，则使用CompletableFuture.completedFuture（result）；把结果转换为CompletableFuture对象（即同步转异步），以便统一处理，在随后的11.2.1小节中我们也会讲到。</p></blockquote> <h2 id="_3-3-dubbo服务消费方启动流程剖析"><a href="#_3-3-dubbo服务消费方启动流程剖析" class="header-anchor">#</a> 3.3 Dubbo服务消费方启动流程剖析</h2> <p>我们看看服务消费方启动流程时序图（如图3.8所示）。</p> <p><img src="/assets/img/image-20240517083745533.067c60f2.png" alt="image-20240517083745533"></p> <p>在2.2节中，我们提到服务消费方需要使用ReferenceConfig API来消费服务，这里就是执行图3.8中步骤1的get（）方法来生成远程调用代理类。get（）方法首先会执行init（）方法：其中，checkMock（）方法用来检查设置的mock是否正确（有关细节我们在第5章会展开讲解），然后通过调用createProxy （）方法来创建代理类，createProxy（）方法的核心代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 检查 mock 设置</span>
        <span class="token function">checkMock</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 创建代理</span>
        ref <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）是否需要打开本地引用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldJvmRefer</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCAL_PROTOCOL</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCALHOST_VALUE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addParameters</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            invoker <span class="token operator">=</span> refprotocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 2）用户是否指定服务提供方地址：可以是服务提供方IP地址（直连方式）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// user specified URL, could be peer-to-peer address, or register center's address.</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> us <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SEMICOLON_SPLIT_PATTERN</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>us <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> us<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> u <span class="token operator">:</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REGISTRY_PROTOCOL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REFER_KEY</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toQueryString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClusterUtils</span><span class="token punctuation">.</span><span class="token function">mergeUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// assemble URL from register center's configuration</span>
              <span class="token comment">// 3）根据服务注册中心信息装配 URL 对象</span>
                <span class="token function">checkRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> us <span class="token operator">=</span> <span class="token function">loadRegistries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>us<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token constant">URL</span> u <span class="token operator">:</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">URL</span> monitorUrl <span class="token operator">=</span> <span class="token function">loadMonitor</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>monitorUrl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MONITOR_KEY</span><span class="token punctuation">,</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>monitorUrl<span class="token punctuation">.</span><span class="token function">toFullString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REFER_KEY</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toQueryString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No such any registry to reference &quot;</span> <span class="token operator">+</span> interfaceName <span class="token operator">+</span> <span class="token string">&quot; on the consumer &quot;</span> <span class="token operator">+</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; use dubbo version &quot;</span> <span class="token operator">+</span> <span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, please config &lt;dubbo:registry address=\&quot;...\&quot; /&gt; to your spring config.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 4）只有一个服务注册中心的时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                invoker <span class="token operator">=</span> refprotocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> urls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 多个服务注册中心时</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 5）是否应该在启动时候检查提供方是否可以用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>invoker<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// make it possible for consumer to retry later if provider is temporarily unavailable</span>
            initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to check the status of the service &quot;</span> <span class="token operator">+</span> interfaceName <span class="token operator">+</span> <span class="token string">&quot;. No provider available for the service &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>group <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> group <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> interfaceName <span class="token operator">+</span> <span class="token punctuation">(</span>version <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> version<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; from the url &quot;</span> <span class="token operator">+</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; to the consumer &quot;</span> <span class="token operator">+</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; use dubbo version &quot;</span> <span class="token operator">+</span> <span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 6)创建服务代理 </span>
        <span class="token comment">// create service proxy</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>上面的代码比较简单，首先判断是否需要开启本地引用，如果需要则创建JVM协议的本地引用，然后加载服务注册中心信息，服务注册中心可以有多个。</p> <p>在2.2节我们讲过，服务消费第一步是调用Protocol扩展接口实现类的refer（）方法以生成Invoker实例，这正是代码4做所的事情，其中refprotocol的定义如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Protocol</span> refprotocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>从上面的代码可知，refprotocol 是Protocol 扩展接口的适配器类，这里调用的refprotocol.refer（interfaceClass，urls.get（0））；实际上是Protocol$Adaptive的refer（）方法。</p></blockquote> <p>在Protocol$Adaptive 的refer（）方法内部，当我们设置了服务注册中心后，可以发现当前协议类型为registry，也就是说这里需要调用RegistryProtocol 的refer（）方法。但RegistryProtocol 被QosProtocolWrapper、ProtocolFilterWrapper、ProtocolListenerWrapper三个Wrapper 类增强了，所以这里经过一层层调用后，最后才调用到RegistryProtocol 的refer（）方法，其内部主要是调用了doRefer（）方法，doRefer（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doRefer</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token class-name">Registry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）建立路由规则链</span>
        directory<span class="token punctuation">.</span><span class="token function">buildRouterChain</span><span class="token punctuation">(</span>subscribeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）订阅服务提供者地址</span>
        directory<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>subscribeUrl<span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span><span class="token constant">CATEGORY_KEY</span><span class="token punctuation">,</span>
                <span class="token constant">PROVIDERS_CATEGORY</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> <span class="token constant">CONFIGURATORS_CATEGORY</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> <span class="token constant">ROUTERS_CATEGORY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 3）包装机器容错策略到 invoker</span>
        <span class="token class-name">Invoker</span> invoker <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProviderConsumerRegTable</span><span class="token punctuation">.</span><span class="token function">registerConsumer</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> url<span class="token punctuation">,</span> subscribeUrl<span class="token punctuation">,</span> directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1根据订阅的URL创建路由规则链，代码2的作用是向服务注册中心订阅服务提供者的服务，代码3则是调用扩展接口Cluster的适配器类的join（）方法，根据参数选择配置的集群容错策略。这里我们先讲讲代码2的逻辑，看看Invoker是如何生成的，这里结合ZooKeeper作为服务注册中心来讲解，首先看看如图3.9所示的时序图。</p> <h4 id="invoker-如何生成"><a href="#invoker-如何生成" class="header-anchor">#</a> Invoker 如何生成</h4> <p><img src="/assets/img/image-20240519100310271.d3d63256.png" alt="image-20240519100310271"></p> <p>图3.9中的步骤2、步骤3和步骤4用来从ZooKeeper 获取服务提供者的地址列表，等ZooKeeper返回地址列表后会调用RegistryDirectory的notify（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 使用 JDK8 流式迭代对不同类别的元数据进行分类</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> categoryUrls <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isValidCategory</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isNotCompatibleFor26x</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>url <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isConfigurator</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">CONFIGURATORS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRoute</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">ROUTERS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isProvider</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">PROVIDERS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 配置信息，比如服务降级信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> configuratorURLs <span class="token operator">=</span> categoryUrls<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATORS_CATEGORY</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>configurators <span class="token operator">=</span> <span class="token class-name">Configurator</span><span class="token punctuation">.</span><span class="token function">toConfigurators</span><span class="token punctuation">(</span>configuratorURLs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurators<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 路由信息收集并保存</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> routerURLs <span class="token operator">=</span> categoryUrls<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token constant">ROUTERS_CATEGORY</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">toRouters</span><span class="token punctuation">(</span>routerURLs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">addRouters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// providers</span>
      <span class="token comment">// 服务提供者信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> providerURLs <span class="token operator">=</span> categoryUrls<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token constant">PROVIDERS_CATEGORY</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">refreshOverrideAndInvoker</span><span class="token punctuation">(</span>providerURLs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面代码的notify（）方法内，对元数据信息进行了分类保存。</p> <p>图3.9中的步骤6、步骤7和步骤8根据获取的最新的服务提供者URL地址，将其转换为具体的invoker列表，也就是说每个提供者的 URL会被转换为一个Invoker对象，具体转换在toInvokers（）方法中进行：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">toInvokers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> newUrlInvokerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token constant">URL</span> providerUrl <span class="token operator">:</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> localUrlInvokerMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlInvokerMap<span class="token punctuation">;</span> <span class="token comment">// local reference</span>
            <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> localUrlInvokerMap <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> localUrlInvokerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Not in the cache, refer again</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 这里调用 Dubbo 协议转换服务到 invoker</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerDelegate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>serviceType<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> providerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to refer invoker for interface:&quot;</span> <span class="token operator">+</span> serviceType <span class="token operator">+</span> <span class="token string">&quot;,url:(&quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Put new invoker in cache</span>
                    newUrlInvokerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                newUrlInvokerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        keys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> newUrlInvokerMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，将服务接口转换到invoker 对象是通过调用protocol.refer（serviceType，url）来完成的，调用的应该是DubboProtocol的refer（）方法。</p> <blockquote><p>这里的protocol对象也是Protocol扩展接口的适配器对象，所以调用protocol.refer实际上是调用适配器Protocol$Adaptive的refer（）方法。在URL中，协议默认为是Dubbo</p> <p>前面的章节已讲过，Dubbo默认提供了一系列Wrapper类对扩展实现类进行功能增强，当然这里也不例外，Dubbo 使用了ProtocolListenerWrapper、ProtocolFilterWrapper 等类对DubboProtocol进行了功能增强。所以，在这里经过一次次调用后才调用到DubboProtocol的refer（）方法</p></blockquote> <p>DubboProtocol的refer（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> serviceType<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token function">optimizeSerialization</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// create rpc invoker.</span>
        <span class="token class-name">DubboInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>serviceType<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token function">getClients</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，getClients（）方法创建服务消费端的NettyClient对象，其调用链的时序图如图3.10所示</p> <p><img src="/assets/img/image-20240519113912435.d68c2f99.png" alt="image-20240519113912435"></p> <p>其中NettyClient构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">NettyClient</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token function">wrapChannelHandler</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">ChannelHandler</span> <span class="token function">wrapChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url <span class="token operator">=</span> <span class="token class-name">ExecutorUtil</span><span class="token punctuation">.</span><span class="token function">setThreadName</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">CLIENT_THREAD_POOL_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREADPOOL_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CLIENT_THREADPOOL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ChannelHandlers</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">ChannelHandler</span> <span class="token function">wrapInternal</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MultiMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartbeatHandler</span><span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Dispatcher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>在ChannelHandlers.wrap函数内会确定消费端Dubbo内部的线程池模型（关于线程池模型，在后面的章节会做具体讲解）。</p></blockquote> <p>NettyClient的父类AbstractClient的构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AbstractClient</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 加载编解码器实现</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 调用子类的 doOpen</span>
            <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// connect.</span>
          <span class="token comment">// 发起远端连接</span>
            <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>在上面的代码中，首先调用了NettyClient的doOpen（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）创建业务 handler</span>
        <span class="token keyword">final</span> <span class="token class-name">NettyClientHandler</span> nettyClientHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyClientHandler</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）创建启动器并配置</span>
        bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>nioEventLoopGroup<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">ALLOCATOR</span><span class="token punctuation">,</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span>
                <span class="token comment">//.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout())</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">CONNECT_TIMEOUT_MILLIS</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">CONNECT_TIMEOUT_MILLIS</span><span class="token punctuation">,</span> <span class="token function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 3）添加 handler 到链接的管线</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> heartbeatInterval <span class="token operator">=</span> <span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">getHeartbeat</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">NettyCodecAdapter</span> adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyCodecAdapter</span><span class="token punctuation">(</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NettyClient</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//.addLast(&quot;logging&quot;,new LoggingHandler(LogLevel.INFO))//for debug</span>
                        <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 解码器</span>
                        <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 编码器</span>
                        <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;client-idle-handler&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span>heartbeatInterval<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;handler&quot;</span><span class="token punctuation">,</span> nettyClientHandler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 框架内部使用的 handler</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>上面的代码创建了一个启动NettyClient的bootstrap并对其进行设置，这里是把编解码器和自定义的nettyClientHandler添加到了链接Channel对应的管线里，在后面的第13章会做具体讲解。</p> <p>在调用doOpen（）方法后会调用NettyClient的doConnect（）方法与服务提供者建立TCP链接，其中NettyClient的doConnect（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 发起链接</span>
        <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token function">getConnectAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

</code></pre></div><blockquote><p>另外需要注意的是，在NettyClient的父类AbstractEndpoint中确定了编解码器，这里默认为DubboCodec：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Codec2</span> <span class="token function">getChannelCodec</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> codecName <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CODEC_KEY</span><span class="token punctuation">,</span> <span class="token string">&quot;telnet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Codec2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasExtension</span><span class="token punctuation">(</span>codecName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Codec2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>codecName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CodecAdapter</span><span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Codec</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>codecName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>然后，在doOpen（）方法中，代码NettyCodecAdapter adapter=new NettyCodecAdapter （getCodec（），getUrl（），NettyClient.this）；使用getCodec（）方法获取了该编解码器并封装到NettyCodecAdapter适配器中，然后把编解码器设置到链接Channel的管线中。关于编解码器的使用，后面有专门的章节进行讲解。</p></blockquote> <p>这里需要注意三点：第一点，由于同一个服务提供者机器可以提供多个服务，那么消费者机器需要与同一个服务提供者机器提供的多个服务共享连接，还是与每个服务都建立一个连接？第二点，消费端是启动时就与服务提供者机器建立好连接吗？第三点，每个服务消费端与服务提供者集群中的所有机器都有连接吗？</p> <ul><li>对于第三点，每个服务消费端与服务提供者集群中的所有机器都有连接吗？</li></ul> <p>我们可以看看图3.9中的toRouters（）方法就可以找到答案，其内部是把具体服务的所有服务提供者的URL信息转换为了Invoker，也就是说服务消费端与服务提供者的所有机器都有连接。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> categoryUrls <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isValidCategory</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isNotCompatibleFor26x</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>url <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isConfigurator</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">CONFIGURATORS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRoute</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">ROUTERS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isProvider</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">PROVIDERS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">toRouters</span><span class="token punctuation">(</span>routerURLs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">addRouters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>对于第一个问题：由于同一个服务提供者机器可以提供多个服务，那么消费者机器需要与同一个服务提供者机器提供的多个服务共享连接，还是与每个服务都建立一个连接？</li></ul> <p>通过下面的代码可知，在默认情况下当消费端引用同一个服务提供者机器上多个服务时，这些服务复用一个Netty连接：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">ExchangeClient</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClients</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// whether to share connection</span>

      <span class="token comment">// 1）不同服务是否共享连接</span>
        <span class="token keyword">boolean</span> useShareConnect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> connections <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONNECTIONS_KEY</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceCountExchangeClient</span><span class="token punctuation">&gt;</span></span> shareClients <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// if not configured, connection is shared, otherwise, one connection for one service</span>
      <span class="token comment">// 2）如果没有配置，则默认连接是共享的，否则每个服务单独有自己的连接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connections <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            useShareConnect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">/**
             * The xml configuration should have a higher priority than properties.
             */</span>
          <span class="token comment">// 2.1）xml 优先级高于属性配置</span>
            <span class="token class-name">String</span> shareConnectionsStr <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SHARE_CONNECTIONS_KEY</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connections <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>shareConnectionsStr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SHARE_CONNECTIONS_KEY</span><span class="token punctuation">,</span>
                    <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_SHARE_CONNECTIONS</span><span class="token punctuation">)</span> <span class="token operator">:</span> shareConnectionsStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 2.2）获取共享 nettyClient</span>
            shareClients <span class="token operator">=</span> <span class="token function">getSharedClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> connections<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 3）初始化 Client</span>
        <span class="token class-name">ExchangeClient</span><span class="token punctuation">[</span><span class="token punctuation">]</span> clients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExchangeClient</span><span class="token punctuation">[</span>connections<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> clients<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>useShareConnect<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 3.1）共享则返回已经存在的</span>
                clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> shareClients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// 否则创建新的</span>
                clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">initClient</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> clients<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>对于第二个问题：消费端是启动时就与服务提供者机器建立好连接吗？</li></ul> <p>下面的代码默认lazy为false，所以当消费端启动时就与提供者建立了连接：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">ExchangeClient</span> <span class="token function">initClient</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ExchangeClient</span> client<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// connection should be lazy</span>
          <span class="token comment">// 为惰性连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LAZY_CONNECT_KEY</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyConnectExchangeClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 为及时连接</span>
                client <span class="token operator">=</span> <span class="token class-name">Exchangers</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>另外，从DubboProtocol的refer（）方法可知，其内部返回了一个DubboInvoker，这就是原生的invoker对象，服务消费方远程服务转换就是为了这个invoker。图3.9中的步骤17则是对这个invoker进行装饰，即使用一系列Filter形成了责任链，invoker被放到责任链的末尾。下面我们看看ProtocolFilterWrapper的buildInvokerChain（）方法是如何形成责任链的，具体代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> last <span class="token operator">=</span> invoker<span class="token punctuation">;</span>
      <span class="token comment">// 获取所有激活的 Filter，然后使用链表方式形成责任链</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Filter</span> filter <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> last<span class="token punctuation">;</span>
                last <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">URL</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Result</span> result <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment">// 支持异步调用</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">AsyncRpcResult</span> asyncResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
                            asyncResult<span class="token punctuation">.</span><span class="token function">thenApplyWithContext</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> filter<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> asyncResult<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        invoker<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>其中，扩展接口Filter对应的实现类如下所示：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">monitor</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.monitor.support.MonitorFilter</span>
<span class="token key attr-name">metrics</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.monitor.support.MetricsFilter</span>
<span class="token key attr-name">echo</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.EchoFilter</span>
<span class="token key attr-name">generic</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.GenericFilter</span>
<span class="token key attr-name">genericimpl</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.GenericImplFilter</span>
<span class="token key attr-name">token</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.TokenFilter</span>
<span class="token key attr-name">accesslog</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.AccessLogFilter</span>
<span class="token key attr-name">activelimit</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.ActiveLimitFilter</span>
<span class="token key attr-name">classloader</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.ClassLoaderFilter</span>
<span class="token key attr-name">context</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.ContextFilter</span>
<span class="token key attr-name">consumercontext</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.ConsumerContextFilter</span>
<span class="token key attr-name">exception</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.ExceptionFilter</span>
<span class="token key attr-name">executelimit</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.ExecuteLimitFilter</span>
<span class="token key attr-name">deprecated</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.DeprecatedFilter</span>
<span class="token key attr-name">compatible</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.CompatibleFilter</span>
<span class="token key attr-name">timeout</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.filter.TimeoutFilter</span>
...
</code></pre></div><blockquote><p>其中，MonitorFilter 和监控中心进行交互，FutureFilter 用来实现异步调用，GenericFilter 用来实现泛化调用，ActiveLimitFilter 用来控制消费端最大并发调用量，ExecuteLimitFilter用来控制服务提供方最大并发处理量等，当然也可以写自己的Filter。</p> <p>需要注意的是，消费端启动时并不是把所有的Filter扩展实现都放到责任链中，而是把group=consumer并且value值在URL里的才会放到责任链中，这一点在2.5节中提到过。</p></blockquote> <p>由于是责任链，所以ProtocolFilterWrapper的refer（）方法是将责任链头部的Filter返回到ProtocolListenerWrapper。ProtocolListenerWrapper的refer（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REGISTRY_PROTOCOL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REFERENCE_FILTER_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONSUMER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>至此可知，在图3.9中，在RegistryDirectory 里维护了所有服务者的invoker 列表，消费端发起远程调用时就是根据集群容错和负载均衡算法以及路由规则从invoker列表里选择一个进行调用的，当服务提供者宕机的时候，ZooKeeper会通知更新这个invoker列表。</p> <p><img src="/assets/img/image-20240519122629921.6d99ae2c.png" alt="image-20240519122629921"></p> <p>到这里，我们就讲完了图3.9中directory.subscribe（）方法是如何订阅服务提供者服务的，并且把服务提供者所有的URL信息转换为了invoker列表，并保存到RegistryDirectory里。</p> <h4 id="invoker客户端转换为需要的接口的"><a href="#invoker客户端转换为需要的接口的" class="header-anchor">#</a> invoker客户端转换为需要的接口的</h4> <blockquote><p>org/apache/dubbo/registry/integration/RegistryProtocol.java#L389</p></blockquote> <p>下面，我们接着讲解图3.9中RegistryProtocol的doRefer（）方法中的cluster.join（directory）是如何使用集群容错扩展将Dubbo协议的invoker客户端转换为需要的接口的。在默认情况下，cluster的扩展接口实现为FailoverCluster，所以这里是调用FailoverCluster的join （）方法，FailoverCluster的join （）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FailoverCluster</span> <span class="token keyword">implements</span> <span class="token class-name">Cluster</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;failover&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> directory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FailoverClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>这里是把directory 对象包裹到了FailoverClusterInvoker里，需要注意的是，directory就是上面讲解的RegistryDirectory，其内部维护了所有服务提供者的invoker 列表，而FailoverCluster就是集群容错策略。</p> <blockquote><p>其实，Dubbo对cluster扩展接口实现类使用Wrapper类MockClusterWrapper进行增强：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">mock</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.wrapper.MockClusterWrapper</span>
<span class="token key attr-name">failover</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.FailoverCluster</span>
<span class="token key attr-name">failfast</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.FailfastCluster</span>
<span class="token key attr-name">failsafe</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.FailsafeCluster</span>
<span class="token key attr-name">failback</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.FailbackCluster</span>
<span class="token key attr-name">forking</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.ForkingCluster</span>
<span class="token key attr-name">available</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.AvailableCluster</span>
<span class="token key attr-name">mergeable</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.MergeableCluster</span>
<span class="token key attr-name">broadcast</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.BroadcastCluster</span>
<span class="token key attr-name">registryaware</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.rpc.cluster.support.RegistryAwareCluster</span>
</code></pre></div></blockquote> <p>实际上调用的时序图如图3.12所示。</p> <p><img src="/assets/img/image-20240519140953647.4fff2291.png" alt="image-20240519140953647"></p> <p>图3.12中的步骤3将FailbackClusterInvoker 对象返回到步骤2，下面看看MockClusterWrapper类的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MockClusterWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">Cluster</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MockClusterWrapper</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cluster <span class="token operator">=</span> cluster<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> directory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MockClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>directory<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，MockClusterWrapper 类把FailoverClusterInvoker 包装成了MockClusterInvoker 实例，所以整个调用链最终调用返回的是MockClusterInvoker 对象。也就是说，本节第一个时序图（见图3.8）中的步骤4返回的是MockClusterInvoker，然后执行图3.9中的步骤14以获取MockClusterInvoker的代理，实现invoker到客户端接口的转换，这里默认调用的是JavassistProxyFactory的getProxy（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>interfaces<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InvokerInvocationHandler</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>其中，InvokerInvocationHandler为具体拦截器。至此，我们按照逆序的方式把服务消费端启动流程讲解完了，下面一节讲解一次远程调用过程。</p> <p><img src="/assets/img/image-20240519141411645.84ceb459.png" alt="image-20240519141411645"></p> <p><img src="/assets/img/image-20240519122629921.6d99ae2c.png" alt="image-20240519122629921"></p> <h2 id="_3-4-dubbo服务消费端一次远程调用过程"><a href="#_3-4-dubbo服务消费端一次远程调用过程" class="header-anchor">#</a> 3.4 Dubbo服务消费端一次远程调用过程</h2> <p>我们先看看整体时序图，如图3.13所示。</p> <p><img src="/assets/img/image-20240519144035305.7df57eb0.png" alt="image-20240519144035305"></p> <p>在3.3节中，我们提到服务消费端通过ReferenceConfig 的get（） 方法返回的是一个代理类，并且方法拦截器为InvokerInvocationHandler，所以当消费方调用了服务的接口方法后会被InvokerInvocationHandler拦截，执行图3.13所示的流程。</p> <blockquote><p>https://blog.csdn.net/jy02268879/article/details/109469335 能够从 Proxy 触发拦截器的原理</p></blockquote> <p>在图3.13所示的流程中，步骤1的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token function">createInvocation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">RpcInvocation</span> <span class="token function">createInvocation</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RpcInvocation</span> invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcInvocation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果返回值为 CompletableFuture 则设置标记</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">hasFutureReturnType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">FUTURE_RETURNTYPE_KEY</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invocation<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ASYNC_KEY</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> invocation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>https://blog.csdn.net/shaolong1013/article/details/105582263 Dubbo 类型的解释</p></blockquote> <p>从上面的代码可知，这里创建了RpcInvocation，其中method为调用的方法，args为参数，这个RpcInvocation对象会一直传递，直到发起远程调用（下面对此会做讲解）。</p> <blockquote><p>这里需要注意的一点是，如果服务接口的方法的返回值为CompletableFuture类或者其子类，则需要设置标记future_returntype为true和async=true，这些属性需要设置到附加属性RpcInvocation里：</p> <p>这些内容在11.2.1小节会做具体讲解。</p></blockquote> <p>步骤2和步骤3调用了默认的集群容错策略FailoverClusterInvoker，其内部首先根据设置的负载均衡策略LoadBalance的扩展实现，选择一个invoker作为FailoverClusterInvoker具体的远程调用者，如果调用发生异常，则根据FailoverClusterInvoker的策略重新选择一个invoker进行调用。</p> <p>在FailoverClusterInvoker 内每次调用invoker 的invoke（）方法时，都会走到步骤8和步骤9，后面的步骤10、步骤11和步骤12是在ProtocolFilterWrapper 内创建的责任链，最后调用了原生的DubboInvoker，其使用NettyClient 与服务提供者进行交互，其中DubboInvoker的doInvoke（）方法的内容如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）设置附加属性</span>
        <span class="token class-name">RpcInvocation</span> inv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> invocation<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> methodName <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inv<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PATH_KEY</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inv<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">VERSION_KEY</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 2）获取远程调用 client</span>
        <span class="token class-name">ExchangeClient</span> currentClient<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clients<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentClient <span class="token operator">=</span> clients<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            currentClient <span class="token operator">=</span> clients<span class="token punctuation">[</span>index<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> clients<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
      <span class="token comment">// 3）执行远程调用</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 3.1）是否为异步调用</span>
            <span class="token keyword">boolean</span> isAsync <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3.2）是否为 future 方式异步</span>
            <span class="token keyword">boolean</span> isAsyncFuture <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isReturnTypeFuture</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3.3）是否为 oneway（不需要响应结果的请求）</span>
            <span class="token keyword">boolean</span> isOneway <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isOneway</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3.4）超时等待</span>
            <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3.5）不需要结果的响应</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOneway<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> isSent <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SENT_KEY</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> isSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 3.6）异步 future</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ResponseFuture</span> future <span class="token operator">=</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// For compatibility</span>
                <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> futureAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Result</span> result<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsyncFuture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// register resultCallback, sometimes we need the async result being processed by the filter chain.</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 3.7）同步请求</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，程序首先获取远程调用Client，然后判断调用是否为异步调用、是否请求响应。</p> <p>如果请求不需要响应结果则直接使用远程Client发起请求调用，然后将RpcContext上下文的future设置为null，并且返回空的RpcResult。</p> <p>如果请求是异步请求，则保存远程Client发起请求后返回的future对象，并且设置到RpcContext上下文中，这样，调用方就可以通过RpcContext上下文获取该future。</p> <p>如果请求为同步请求，则首先设置RpcContext上下文中的future对象为null，然后使用远程Client发起请求，然后在返回的future对象上调用get（）方法，以同步等待远程调用结果的返回。</p> <h2 id="_3-5-小结"><a href="#_3-5-小结" class="header-anchor">#</a> 3.5 小结</h2> <p>本章首先详细讲解了Dubbo服务提供方启动的流程以及Dubbo服务提供端如何对接收的请求进行处理，然后讲解了Dubbo服务消费方启动流程以及如何发起一次远程过程调用。学完本章，相信大家对Dubbo的服务发布与消费的流程将会有直观的理解。</p> <h2 id="第4章-directory目录与router路由服务"><a href="#第4章-directory目录与router路由服务" class="header-anchor">#</a> 第4章 Directory目录与Router路由服务</h2> <h2 id="_4-1-directory目录"><a href="#_4-1-directory目录" class="header-anchor">#</a> 4.1 Directory目录</h2> <p>Directory代表了多个invoker（对于消费端来说，每个invoker代表了一个服务提供者），其内部维护着一个List，并且这个List的内容是动态变化的，比如当服务提供者集群新增或者减少机器时，服务注册中心就会推送当前服务提供者的地址列表，然后Directory中的List就会根据服务提供者地址列表相应变化。</p> <p>在Dubbo中，接口Directory的实现有RegistryDirectory和StaticDirectory两种，其中前者管理的invoker列表是根据服务注册中心的推送变化而变化的，而后者是当消费端使用了多注册中心时，其把所有服务注册中心的invoker列表汇集到一个invoker列表中。</p> <p>本章我们主要从下面几个方面来探讨RegistryDirectory：</p> <ul><li>消费端启动时何时构建RegistryDirectory</li> <li>RegistryDirectory管理的invoker列表如何动态变化</li> <li>路由信息是如何保存与变化的</li></ul> <h2 id="_4-2-registrydirectory的创建"><a href="#_4-2-registrydirectory的创建" class="header-anchor">#</a> 4.2 RegistryDirectory的创建</h2> <p>图4.1是RegistryDirectory的创建流程。</p> <p><img src="/assets/img/image-20240519154955476.b0fb55cb.png" alt="image-20240519154955476"></p> <p>通过图4.1可知，RegistryDirectory是在服务消费端启动时创建的。</p> <ul><li><p>在2.1节中我们提到，ReferenceConfig代表一个要消费的服务的配置对象，调用ReferenceConfig的get（）方法，就意味着要创建一个对服务提供方的远程调用代理。</p></li> <li><p>在图4.1中，步骤2在创建对远程服务提供者的代理时，第一步是调用RegistryProtocol类的refer（）方法，由于RegistryProtocol是一个SPI，所以这里是通过其适配器类Protocol$Adaptive进行间接调用的。另外，这里的ProtocolListenerWrapper、QosProtocolWrapper和ProtocolFilterWrapper是对RegistryProtocol类的功能的增强。</p></li></ul> <h2 id="_4-3-registrydirectory中invoker列表的更新"><a href="#_4-3-registrydirectory中invoker列表的更新" class="header-anchor">#</a> 4.3 RegistryDirectory中invoker列表的更新</h2> <p>上一节探讨了RegistryDirectory何时被创建，本节我们看看其管理的invoker列表是何时被创建与更新的。</p> <p>下面看看RegistryDirectory中invoker列表的更新流程，如图4.2所示。</p> <p>通过图4.2可知，创建完RegistryDirectory后，调用了其subscribe（）方法，这里假设使用的服务注册中心为ZooKeeper，这样就会去ZooKeeper订阅需要调用的服务提供者的地址列表，然后步骤3添加了一个监听器，当ZooKeeper服务端发现服务提供者地址列表发生变化后，会将地址列表推送到服务消费端，然后zkClient会回调该监听器的notify（）方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 流式迭代，对 URL 进行过滤，并对过滤后的 URL 根据不同类型的信息进行分类</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> categoryUrls <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isValidCategory</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isNotCompatibleFor26x</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>url <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isConfigurator</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">CONFIGURATORS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isRoute</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">ROUTERS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isProvider</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token constant">PROVIDERS_CATEGORY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 动态配置信息，比如服务降级信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> configuratorURLs <span class="token operator">=</span> categoryUrls<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATORS_CATEGORY</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>configurators <span class="token operator">=</span> <span class="token class-name">Configurator</span><span class="token punctuation">.</span><span class="token function">toConfigurators</span><span class="token punctuation">(</span>configuratorURLs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurators<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 路由规则信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> routerURLs <span class="token operator">=</span> categoryUrls<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token constant">ROUTERS_CATEGORY</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">toRouters</span><span class="token punctuation">(</span>routerURLs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">addRouters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// providers</span>
      <span class="token comment">// 服务提供者列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> providerURLs <span class="token operator">=</span> categoryUrls<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token constant">PROVIDERS_CATEGORY</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 刷新 invoker 列表</span>
        <span class="token function">refreshOverrideAndInvoker</span><span class="token punctuation">(</span>providerURLs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>步骤6从ZooKeeper返回的服务提供者的信息里获取对应的路由规则，并使用步骤7保存到RouterChain里，这个路由规则是通过管理控制台进行配置的，如图4.3所示。</p> <p>步骤9根据服务降级信息，重写URL（也就是把mock=return null等信息拼接到URL中）并保存到overrideDirectoryUrl中，然后执行步骤10，把服务提供者的URL列表转换为invoker列表，并保存到RouterChain里：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refreshInvoker</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> invokerUrls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只有一个服务提供者时</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invokerUrls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
                <span class="token operator">&amp;&amp;</span> invokerUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">EMPTY_PROTOCOL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>invokerUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>forbidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Forbid to access</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>invokers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            routerChain<span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>invokers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">destroyAllInvokers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Close all invokers</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 多个提供者</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>forbidden <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Allow to access</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> oldUrlInvokerMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlInvokerMap<span class="token punctuation">;</span> <span class="token comment">// local reference</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> newUrlInvokerMap <span class="token operator">=</span> <span class="token function">toInvokers</span><span class="token punctuation">(</span>invokerUrls<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Translate url list to Invoker map</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> newInvokers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>newUrlInvokerMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置 newUrlInvokerMap.values()</span>
          routerChain<span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span>newInvokers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>invokers <span class="token operator">=</span> multiGroup <span class="token operator">?</span> <span class="token function">toMergeInvokerList</span><span class="token punctuation">(</span>newInvokers<span class="token punctuation">)</span> <span class="token operator">:</span> newInvokers<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>urlInvokerMap <span class="token operator">=</span> newUrlInvokerMap<span class="token punctuation">;</span>

          <span class="token comment">// 关闭无用的 invokers</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">destroyUnusedInvokers</span><span class="token punctuation">(</span>oldUrlInvokerMap<span class="token punctuation">,</span> newUrlInvokerMap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Close the unused Invoker</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;destroyUnusedInvokers error. &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>另外，RouterChain里也保存了可用服务提供者对应的invokers列表和路由规则信息，当服务消费方的集群容错策略要获取可用服务提供者对应的invoker列表时，会调用RouterChain的route（）方法，其内部根据路由规则信息和invokers列表来提供服务，流程如图4.4所示。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> finalInvokers <span class="token operator">=</span> invokers<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Router</span> router <span class="token operator">:</span> routers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            finalInvokers <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>finalInvokers<span class="token punctuation">,</span> url<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> finalInvokers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/assets/img/image-20240520085641494.fc4b0114.png" alt="image-20240520085641494"></p> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>总结一下就是，在服务消费端应用中，每个需要消费的服务都被包装为ReferenceConfig，在应用启动时会调用每个服务对应的ReferenceConfig的get（）方法，然后会为每个服务创建一个自己的RegistryDirectory对象，每个RegistryDirectory管理该服务提供者的地址列表、路由规则、动态配置等信息，当服务提供者的信息发生变化时，RegistryDirectory会动态地得到变化通知，并自动更新。</p> <blockquote><p>至于RouterChain链是什么时候创建的，我们已经在3.3节提到过，即RouterChain链是在消费端启动过程中通过RegistryProtocol的doRefer（）方法调用RegistryDirectory的buildRouterChain（）方法创建的。</p></blockquote> <h2 id="_4-4-小结"><a href="#_4-4-小结" class="header-anchor">#</a> 4.4 小结</h2> <p>本章首先讲解了RegistryDirectory在消费服务方是何时进行创建的，以及如何动态地根据服务注册中心推送的服务元数据来更新RegistryDirectory中维护的服务提供者信息、路由等信息的，然后讲解了消费端发起远程调用时如何从RouterChain中获取经过路由规则过滤后的服务提供者的inovker列表。</p> <h2 id="第5章-dubbo消费端服务mock与服务降级策略原理"><a href="#第5章-dubbo消费端服务mock与服务降级策略原理" class="header-anchor">#</a> 第5章 Dubbo消费端服务mock与服务降级策略原理</h2> <h2 id="_5-1-服务降级原理"><a href="#_5-1-服务降级原理" class="header-anchor">#</a> 5.1 服务降级原理</h2> <h3 id="_5-1-1-降级策略注册"><a href="#_5-1-1-降级策略注册" class="header-anchor">#</a> 5.1.1 降级策略注册</h3> <p>在基础篇中，我们介绍了使用下面的代码可以将服务降级信息注册到ZooKeeper：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mockResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// (1)获取服务注册中心工厂</span>
		<span class="token class-name">RegistryFactory</span> registryFactory <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">RegistryFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// (2)根据zk地址，获取具体的zk注册中心的客户端实例</span>
		<span class="token class-name">Registry</span> registry2 <span class="token operator">=</span> registryFactory<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// (3)注册降级方案到zk</span>
		registry2<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>
				<span class="token string">&quot;override://0.0.0.0/com.books.dubbo.demo.api.GreetingService?category=configurators&amp;dynamic=false&amp;application=first-dubbo-consumer&amp;&quot;</span>
						<span class="token operator">+</span> <span class="token string">&quot;mock=&quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;:return+null&amp;group=dubbo&amp;version=1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>当以参数force调用上述代码时，降级策略就会写入ZooKeeper 服务器com.books.dubbo.demo.api.GreetingService子树中Type为configurators的下面，如图5.1所示。</p> <blockquote><p>当然，也可以使用admin手动配置服务降级策略。</p></blockquote> <p><img src="/assets/img/image-20240521083136104.410e5847.png" alt="image-20240521083136104"></p> <p>当服务消费者启动时，会去订阅com.books.dubbo.demo.api.GreetingService子树中的信息，比如Providers（服务提供者列表）、Routes（路由信息）、Configurators（服务降级策略）等信息，这些内容在第4章已经讲过。</p> <p>当服务消费者发起远程调用时，会看是否设置了force：return 降级策略，如果设置了则不发起远程调用并直接返回mock值，否则发起远程调用。当远程调用结果OK时，直接返回远程调用返回的结果；如果远程调用失败了，则看当前是否设置了fail：return 的降级策略，如果设置了，则直接返回mock值，否则返回调用远程服务失败的具体原因。</p> <h3 id="_5-1-2-服务消费端使用降级策略"><a href="#_5-1-2-服务消费端使用降级策略" class="header-anchor">#</a> 5.1.2 服务消费端使用降级策略</h3> <p>首先，我们看一幅简化的时序图，了解一下从消费端发起远程调用的流程，如图5.2所示。</p> <p><img src="/assets/img/image-20240521083446240.334bb012.png" alt="image-20240521083446240"></p> <p>从图中可以看出，服务消费端是在MockClusterInvoker类的invoke（）方法里使用降级策略并在DubboInvoker的invoke（）方法里发起远程调用的，所以服务降级是在消费端还没有发起远程调用时完成的。</p> <p>本节主要讲解服务降级，所以我们看看MockClusterInvoker类的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 1）查看 URL 里面是否有 mock 字段</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MOCK_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）如果没有，或者值为默认的 false，则说明没有设置降级策略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> value<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//no mock</span>
          <span class="token comment">// 2.）没有 mock，正常发起远程调用</span>
            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3）设置了 force:return 降级策略</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;force&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.1）force:direct mock</span>
            result <span class="token operator">=</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//4）设置fail-mock</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4.1</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">isBiz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//4.2</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;fail-mock: &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; fail-mock enabled , url : &quot;</span> <span class="token operator">+</span> directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result <span class="token operator">=</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4.3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，其中directory.getUrl（）方法获取的就是上一节我们讲解overrideDirectoryUrl，代码1查看该URL里面是否含有mock的值，如果没有或者有但是值为false，说明没有设置降级策略，则执行代码2.1，也就是正常发起远程调用。</p> <blockquote><p>overrideDirectoryUrl 可以全局搜索找到4.3节中的介绍</p></blockquote> <p>如果URL里面含有mock 字段，并且其值以force 开头，则说明设置了force：return降级策略，那么直接调用doMockInvoke（） 方法（其内部会调用创建的MockInvoker的invoke（）方法），返回mock值，而不发起远程调用。</p> <p>如果URL里面含有mock字段，并且其值以fail开头，则说明设置了fail：return降级策略，那么先发起远程调用。如果远程调用成功，则直接返回远程返回的结果（如果这里使用了默认的集群容错策略，则代码4.1会调用FailoverClusterInvokerd的invoke（）方法发起远程调用）；如果发起远程调用失败，则执行代码4.3，直接返回mock的值。</p> <h2 id="_5-2-本地服务mock原理"><a href="#_5-2-本地服务mock原理" class="header-anchor">#</a> 5.2 本地服务mock原理</h2> <h3 id="_5-2-1-mock合法性检查"><a href="#_5-2-1-mock合法性检查" class="header-anchor">#</a> 5.2.1 mock合法性检查</h3> <p>在3.3节我们讲解了在服务引用启动时会在ReferenceConfig的init（）方法内调用checkMock来检查设置的mock的正确性，下面我们看看相应的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">void</span> <span class="token function">checkMock</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> interfaceClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//1）没设置 mock，则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">//2）获取格式化 mock 方式</span>
        <span class="token class-name">String</span> normalizedMock <span class="token operator">=</span> <span class="token class-name">MockInvoker</span><span class="token punctuation">.</span><span class="token function">normalizeMock</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）检查 mock 值是否合法，不合法则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedMock<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">RETURN_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            normalizedMock <span class="token operator">=</span> normalizedMock<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">RETURN_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//Check whether the mock value is legal, if it is illegal, throw exception</span>
                <span class="token class-name">MockInvoker</span><span class="token punctuation">.</span><span class="token function">parseMockValue</span><span class="token punctuation">(</span>normalizedMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal mock return in &lt;dubbo:service/reference ... &quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;mock=\&quot;&quot;</span> <span class="token operator">+</span> mock <span class="token operator">+</span> <span class="token string">&quot;\&quot; /&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedMock<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THROW_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            normalizedMock <span class="token operator">=</span> normalizedMock<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THROW_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>normalizedMock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//Check whether the mock value is legal</span>
                    <span class="token class-name">MockInvoker</span><span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span>normalizedMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal mock throw in &lt;dubbo:service/reference ... &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;mock=\&quot;&quot;</span> <span class="token operator">+</span> mock <span class="token operator">+</span> <span class="token string">&quot;\&quot; /&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//Check whether the mock class is a implementation of the interfaceClass, and if it has a default constructor</span>
          <span class="token comment">// 4）检查 mock 接口的实现类是否符合规则</span>
            <span class="token class-name">MockInvoker</span><span class="token punctuation">.</span><span class="token function">getMockObject</span><span class="token punctuation">(</span>normalizedMock<span class="token punctuation">,</span> interfaceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果代码1没有设置mock规则，则直接返回，否则代码2对mock规则进行格式化：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">return</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; return null</span>
<span class="token key attr-name">fail</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; default</span>
<span class="token key attr-name">force</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; default</span>
<span class="token key attr-name">fail</span><span class="token punctuation">:</span><span class="token value attr-value">throw/return foo =&gt; throw/return foo</span>
<span class="token key attr-name">force</span><span class="token punctuation">:</span><span class="token value attr-value">throw/return foo =&gt; throw/return foo</span>
</code></pre></div><blockquote><p>例如，如果设置mock为return，则格式化后为return null。</p></blockquote> <p>代码将检查mock值是否合法，不合法将抛出异常。由于我们的Demo是将mock设置为true，所以我们会看到代码4将检查mock接口的实现类是否符合规则，MockInvoker.getMockObject的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getMockObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> mockService<span class="token punctuation">,</span> <span class="token class-name">Class</span> serviceType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 5)如果 mock 类型为 true 或者 default</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isDefault</span><span class="token punctuation">(</span>mockService<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mockService <span class="token operator">=</span> serviceType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Mock&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 6）反射加载字节码创建 Class 对象</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mockClass <span class="token operator">=</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>mockService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>mockClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;The mock class &quot;</span> <span class="token operator">+</span> mockClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; not implement interface &quot;</span> <span class="token operator">+</span> serviceType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 7）创建实例</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mockClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No default constructor from mock class &quot;</span> <span class="token operator">+</span> mockClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果代码5中的mock类型为true或者deafult，则mockService被设置为接口名称加上Mock，例如，如果接口为<code>com.books.dubbo.demo.api.GreetingServic</code>并且mock设置为true，则这里的mockService就是<code>com.books.dubbo.demo.api.GreetingServicMock</code>，然后代码6加载<code>com.books.dubbo.demo.api.GreetingServicMock</code>的字节码文件以创建Class对象，代码7则创建实例。上面这些代码的作用是查看用户程序的classpath下是否存在mock类的实现<code>com.books.dubbo.demo.api.GreetingServicMock</code>，如果不存在，则抛出异常。</p> <h3 id="_5-2-2-服务消费端使用mock服务"><a href="#_5-2-2-服务消费端使用mock服务" class="header-anchor">#</a> 5.2.2 服务消费端使用mock服务</h3> <p>mock服务与服务降级策略一样，也是在MockClusterInvoker中实现的，这里我们再看看其中的invoke（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 1）查看 URL 里面是否有 mock 字段</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MOCK_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）如果没有，或者值为默认的 false，则说明没有设置降级策略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> value<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//no mock</span>
          <span class="token comment">// 2.）没有 mock，正常发起远程调用</span>
            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3）设置了 force:return 降级策略</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;force&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.1）force:direct mock</span>
            result <span class="token operator">=</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//4）设置fail-mock</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4.1</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">isBiz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//4.2</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;fail-mock: &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; fail-mock enabled , url : &quot;</span> <span class="token operator">+</span> directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result <span class="token operator">=</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4.3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>由于我们设置的mock为true，所以这里的value为true，代码会执行到步骤3也就是fail-mock阶段，这也说明了服务mock与服务降级的fail-mock功能相似，不同之处在于前者会设置mock服务实现类，而后者是返回设置的静态返回值。代码3会首先发起远程RPC，如果成功则不会执行mock操作，否则执行doMockInvoke。</p> <blockquote><p>doMockInvoke 内部回常见一个 MockInvoker 对象，调用其 invoke 方法</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">Result</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> minvoker<span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mockInvokers <span class="token operator">=</span> <span class="token function">selectMockInvoker</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mockInvokers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            minvoker <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">MockInvoker</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            minvoker <span class="token operator">=</span> mockInvokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> minvoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> me<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">isBiz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMockExceptionMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">,</span> me<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> me<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token function">getMockExceptionMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">,</span> me<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>org/apache/dubbo/rpc/support/MockInvoker.java:89</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
  <span class="token comment">//4）mock 类型</span>
    <span class="token class-name">String</span> mock <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MOCK_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 5）格式化类型</span>
    mock <span class="token operator">=</span> <span class="token function">normalizeMock</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//6）根据不同类型，返回 mock 值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">RETURN_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mock <span class="token operator">=</span> mock<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">RETURN_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> returnTypes <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getReturnTypes</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token function">parseMockValue</span><span class="token punctuation">(</span>mock<span class="token punctuation">,</span> returnTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ew<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;mock return invoke error. method :&quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;, mock:&quot;</span> <span class="token operator">+</span> mock <span class="token operator">+</span> <span class="token string">&quot;, url: &quot;</span> <span class="token operator">+</span> url<span class="token punctuation">,</span> ew<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THROW_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mock <span class="token operator">=</span> mock<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THROW_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;mocked exception for service degradation.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// user customized class</span>
            <span class="token class-name">Throwable</span> t <span class="token operator">=</span> <span class="token function">getThrowable</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token class-name">RpcException</span><span class="token punctuation">.</span><span class="token constant">BIZ_EXCEPTION</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//impl mock</span>
      <span class="token comment">//7）impl mock</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token function">getInvoker</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create mock implementation class &quot;</span> <span class="token operator">+</span> mock<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，根据mock类型的不同，返回不同的mock值。这里我们重点看看代码7，即mock实现类GreetingServiceMock如何返回mock值：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">String</span> mockService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> mocks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mockService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> serviceType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getServiceInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">T</span> mockObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">getMockObject</span><span class="token punctuation">(</span>mockService<span class="token punctuation">,</span> serviceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>mockObject<span class="token punctuation">,</span> serviceType<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mocks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mocks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mockService<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>通过上面的代码可知，如果缓存里含有mock实现类对应的invoker对象，则直接返回，否则使用getMockObject（）方法创建对象实例，并进行代理后保存到缓存，然后返回。在调用代理的invoke（）方法后，就会调用mock实现类GreetingServiceMock的方法。</p> <h2 id="_5-3-小结"><a href="#_5-3-小结" class="header-anchor">#</a> 5.3 小结</h2> <p>本章首先讲解了Dubbo中如何对一个指定的服务进行服务降级，并讲解了在Dubbo中如何实现服务降级；然后讲解了Dubbo消费端服务mock原理，以及如何在服务消费端使用mock功能。</p> <h2 id="第6章-dubbo集群容错与负载均衡策略"><a href="#第6章-dubbo集群容错与负载均衡策略" class="header-anchor">#</a> 第6章 Dubbo集群容错与负载均衡策略</h2> <h2 id="_6-1-dubbo集群容错策略概述"><a href="#_6-1-dubbo集群容错策略概述" class="header-anchor">#</a> 6.1 Dubbo集群容错策略概述</h2> <p>当我们进行系统设计时，不仅要考虑正常情况下代码逻辑应该如何走，还要考虑异常情况下代码逻辑应该怎么走。当服务消费方调用服务提供方的服务出现错误时，Dubbo提供了多种容错方案，默认模式为Failover Cluster，也就是失败重试。</p> <p>下面让我们看看Dubbo提供的集群容错模式。</p> <h4 id="failover-cluster-失败重试"><a href="#failover-cluster-失败重试" class="header-anchor">#</a> Failover Cluster：失败重试</h4> <p>当服务消费方调用服务提供者失败后，会自动切换到其他服务提供者服务器进行重试，这通常用于读操作或者具有幂等的写操作。需要注意的是，重试会带来更长延迟。可以通过retries=&quot;2&quot;来设置重试次数（不含第1次）。</p> <p>可以使用＜dubbo：reference retries=&quot;2&quot;/＞来进行接口级别配置的重试次数，当服务消费方调用服务失败后，此例子会再重试两次，也就是说最多会做3次调用，这里的配置对该接口的所有方法生效。</p> <p>当然你也可以针对某个方法配置重试次数，比如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sayHello<span class="token punctuation">&quot;</span></span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="failfast-cluster-快速失败"><a href="#failfast-cluster-快速失败" class="header-anchor">#</a> Failfast Cluster：快速失败</h4> <p>当服务消费方调用服务提供者失败后，立即报错，也就是只调用一次。通常，这种模式用于非幂等性的写操作。</p> <h4 id="failsafe-cluster-安全失败"><a href="#failsafe-cluster-安全失败" class="header-anchor">#</a> Failsafe Cluster：安全失败</h4> <p>当服务消费者调用服务出现异常时，直接忽略异常。这种模式通常用于写入审计日志等操作。</p> <h4 id="failback-cluster-失败自动恢复"><a href="#failback-cluster-失败自动恢复" class="header-anchor">#</a> Failback Cluster：失败自动恢复</h4> <p>当服务消费端调用服务出现异常后，在后台记录失败的请求，并按照一定的策略后期再进行重试。这种模式通常用于消息通知操作。</p> <h4 id="forking-cluster-并行调用"><a href="#forking-cluster-并行调用" class="header-anchor">#</a> Forking Cluster：并行调用</h4> <p>当消费方调用一个接口方法后，Dubbo Client会并行调用多个服务提供者的服务，只要其中有一个成功即返回。这种模式通常用于实时性要求较高的读操作，但需要浪费更多服务资源。如下代码可通过forks=&quot;4&quot;来设置最大并行数：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.test.UserServiceBo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">group</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dubbo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version&quot;1.0.0&quot;</span> <span class="token attr-name">cluster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>forking<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>parameter</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>forks<span class="token punctuation">&quot;</span></span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="broadcast-cluster-广播调用"><a href="#broadcast-cluster-广播调用" class="header-anchor">#</a> Broadcast Cluster：广播调用</h4> <p>当消费者调用一个接口方法后，Dubbo Client会逐个调用所有服务提供者，任意一台服务器调用异常则这次调用就标志失败。这种模式通常用于通知所有提供者更新缓存或日志等本地资源信息。</p> <p>Dubbo本身提供了丰富的集群容错模式，但是如果你有定制化需求，可以根据Dubbo提供的扩展接口Cluster进行定制。</p> <blockquote><p>在3.3节中，我们了解到服务消费端具体调用的是集群容错策略的doInvoke（）方法，所以下面我们主要剖析几种比较常见的集群容错的doInvoke（）方法，并介绍一下如何自定义集群容错策略。在这里提醒一点，所有集群容错策略都是继承自抽象类AbstractClusterInvoker。</p></blockquote> <p>首先，我们来看看服务消费端发起远程调用的一个简化时序图，如图6.1所示。</p> <p>图6.1是采用默认的FailOver集群容错方法时的调用时序图，从中可以看到，调用集群容错是在服务降级策略后进行的，集群容错FailoverClusterInvoker内部首先会调用父类AbstractClusterInvoker的list（）方法来获取invoker列表，即从RegistryDirectory管理的RouterChain的route（）方法中获取保存的invoker列表（参见第4章）。</p> <p><img src="/assets/img/image-20240521202733128.baf699a7.png" alt="image-20240521202733128"></p> <h2 id="_6-2-failfast-cluster策略源码分析"><a href="#_6-2-failfast-cluster策略源码分析" class="header-anchor">#</a> 6.2 Failfast Cluster策略源码分析</h2> <p>在Dubbo中，实现快速失败策略的是FailfastClusterInvoker类，这里我们看看具体实现，主要看看doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token function">checkInvokers</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 1）使用负载均衡策略选择一个服务提供者</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2）执行远程调用</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//3）出错则抛出异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">RpcException</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcException</span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBiz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// biz exception.</span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">RpcException</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcException</span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Failfast invoke providers &quot;</span> <span class="token operator">+</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> loadbalance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">&quot; select from all providers &quot;</span> <span class="token operator">+</span> invokers <span class="token operator">+</span> <span class="token string">&quot; for service &quot;</span> <span class="token operator">+</span> <span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">&quot; method &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; on consumer &quot;</span> <span class="token operator">+</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">&quot; use dubbo version &quot;</span> <span class="token operator">+</span> <span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">&quot;, but no luck to perform the invocation. Last error is: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1根据具体的负载均衡策略选择一个服务提供者对应的invoker对象。</p> <p>代码2使用选择的invoker对象发起远程RPC调用。</p> <p>如果代码3发现代码2执行出错，则直接将异常抛给调用方，不进行任何补救措施。</p> <h2 id="_6-3-failsafe-cluster策略源码分析"><a href="#_6-3-failsafe-cluster策略源码分析" class="header-anchor">#</a> 6.3 Failsafe Cluster策略源码分析</h2> <p>在Dubbo 中，实现失败安全的是FailsafeClusterInvoker 类，这里我们看看具体实现，主要看看doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">checkInvokers</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1）</span>
            <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2）</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failsafe ignore exception: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ignore</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1根据具体的负载均衡策略选择一个服务提供者对应的invoker对象。</p> <p>代码2使用选择的invoker对象发起远程RPC调用。</p> <p>与Failfast的不同之处在于，该策略不会把异常抛给调用者。</p> <h2 id="_6-4-failover-cluster策略源码分析"><a href="#_6-4-failover-cluster策略源码分析" class="header-anchor">#</a> 6.4 Failover Cluster策略源码分析</h2> <p>在Dubbo 中，实现失败重试的是FailoverClusterInvoker 类，这里我们看看具体实现，主要看看doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">//1）所有服务提供者</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> copyInvokers <span class="token operator">=</span> invokers<span class="token punctuation">;</span>
        <span class="token function">checkInvokers</span><span class="token punctuation">(</span>copyInvokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//2）获取重试次数</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">RETRIES_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_RETRIES</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// retry loop.</span>
      <span class="token comment">//3）使用循环，失败重试</span>
        <span class="token class-name">RpcException</span> le <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// last exception.</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invoked <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>copyInvokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invoked invokers.</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//Reselect before retry to avoid a change of candidate `invokers`.</span>
            <span class="token comment">//NOTE: if `invokers` changed, then `invoked` also lose accuracy.</span>
          <span class="token comment">// 重试时，进行重新选择，避免重试时 invoker 列表已发生变化</span>
          <span class="token comment">// 注意：如果列表发生变化，那么 invoked 判断时会失效，因为 invoker 实例已经改变</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//3.1）如果当前实例已经被销毁，则抛出异常</span>
                <span class="token function">checkWhetherDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//3.2）重新获取所有服务提供者</span>
                copyInvokers <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// check again</span>
              <span class="token comment">//3.3）重新检查一下</span>
                <span class="token function">checkInvokers</span><span class="token punctuation">(</span>copyInvokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token comment">//3.4）选择负载均衡策略</span>
            <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> copyInvokers<span class="token punctuation">,</span> invoked<span class="token punctuation">)</span><span class="token punctuation">;</span>
            invoked<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span> invoked<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//3.5）具体发起远程调用</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>le <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">isBiz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// biz exception.</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                le <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                le <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>le<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed to invoke the method &quot;</span>
                <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">&quot; in the service &quot;</span> <span class="token operator">+</span> <span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;. Tried &quot;</span> <span class="token operator">+</span> len <span class="token operator">+</span> <span class="token string">&quot; times of the providers &quot;</span> <span class="token operator">+</span> providers
                <span class="token operator">+</span> <span class="token string">&quot; (&quot;</span> <span class="token operator">+</span> providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> copyInvokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;) from the registry &quot;</span> <span class="token operator">+</span> directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot; on the consumer &quot;</span> <span class="token operator">+</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; using the dubbo version &quot;</span>
                <span class="token operator">+</span> <span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;. Last error is: &quot;</span>
                <span class="token operator">+</span> le<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> le<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> le<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> le<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码2从URL参数里获取设置的重试次数，如果用户没有设置重试次数，则取默认值，默认值是重试2次。这里需要注意的是，代码2将获取的配置重试次数又加1了，这说明总共调用次数=重试次数+1（1是正常调用），用户可以通过＜dubbo：reference retries=&quot;2&quot;/＞设置重试次数。</p> <p>代码3循环重试调用，如果第一次调用成功，则直接跳出循环返回，否则循环重试。在第一次调用时，不会运行代码3.1、代码3.2和代码3.3。如果第一次调用出现异常，则会循环，这时候i=1，所以会执行代码3.1以检查是否有线程调用了当前ReferenceConfig的destroy（）方法，销毁了当前消费者。如果当前消费者实例已经被销毁，那么重试就没意义了，所以会抛出RpcException异常。</p> <p>如果当前消费者实例没有被销毁，则执行代码3.2以重新获取当前服务提供者列表，这是因为从第一次调开始到现在可能提供者列表已经变化了，获取列表后，执行代码3.2又进行了一次校验。如果校验通过，则执行代码3.4，以便根据负载均衡策略选择一个服务提供者，然后再次尝试调用。关于负载均衡策略的选择在下一节会做讲解。</p> <h2 id="_6-5-failback-cluster策略源码分析"><a href="#_6-5-failback-cluster策略源码分析" class="header-anchor">#</a> 6.5 Failback Cluster策略源码分析</h2> <p>在Dubbo中，实现失败后定时重试的是FailbackClusterInvoker类，这里我们看看具体实现，主要看看doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">//1）检查 invokers 是否合法</span>
            <span class="token function">checkInvokers</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//2）根据负载均衡策略选择一个 invoker，并发起调用</span>
            invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failback to invoke method &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, wait for retry in background. Ignored exception: &quot;</span>
                    <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//3）失败则添加到定时器</span>
            <span class="token function">addFailed</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ignore</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1检查invokers是否合法，具体是看invokers是否为空，或者是否元素为0个，如果是，说明没有可用的服务提供者，则抛出异常。</p> <p>代码2根据负载均衡策略选择一个invoker，并发起远程RPC调用。</p> <p>如果执行代码1和代码2抛出了异常，则执行代码3，即把当前请求上下文添加到定时器后，将一个空的RpcResult返回调用方。其中addFailed（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addFailed</span><span class="token punctuation">(</span><span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> lastInvoker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 4）创建自定义定时器实例</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failTimer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>failTimer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    failTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashedWheelTimer</span><span class="token punctuation">(</span>
                            <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;failback-cluster-timer&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token number">1</span><span class="token punctuation">,</span>
                            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> failbackTasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//5）创建重试任务，并启动</span>
        <span class="token class-name">RetryTimerTask</span> retryTimerTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RetryTimerTask</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> lastInvoker<span class="token punctuation">,</span> retries<span class="token punctuation">,</span> <span class="token constant">RETRY_FAILED_PERIOD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            failTimer<span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span>retryTimerTask<span class="token punctuation">,</span> <span class="token constant">RETRY_FAILED_PERIOD</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failback background works error,invocation-&gt;&quot;</span> <span class="token operator">+</span> invocation <span class="token operator">+</span> <span class="token string">&quot;, exception: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码4创建了一个自定义定时器，代码5创建了重试任务，并把任务添加到定时器，然后延迟5s执行定时任务，下面我们看看RetryTimerTask的任务内容：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// 负载均衡器选择 invoker</span>
                <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> retryInvoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>lastInvoker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 发起远端调用</span>
                lastInvoker <span class="token operator">=</span> retryInvoker<span class="token punctuation">;</span>
                retryInvoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 失败次数达到重试次数则不再重试</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed retry to invoke method &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, waiting again.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">++</span>retryTimes<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> retries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed retry times exceed threshold (&quot;</span> <span class="token operator">+</span> retries <span class="token operator">+</span> <span class="token string">&quot;), We have to abandon, invocation-&gt;&quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 否则再次重试</span>
                    <span class="token function">rePut</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token comment">// 任务放入定时器，再次重试</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rePut</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Timer</span> timer <span class="token operator">=</span> timeout<span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">isStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> timeout<span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 再次重试</span>
            timer<span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tick<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-6-forking-cluster策略源码分析"><a href="#_6-6-forking-cluster策略源码分析" class="header-anchor">#</a> 6.6 Forking Cluster策略源码分析</h2> <p>在Dubbo 中，实现并行调用的是ForkingClusterInvoker 类，这里我们看看具体实现，主要看看doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">checkInvokers</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selected<span class="token punctuation">;</span>
          <span class="token comment">// 1）获取配置参数</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> forks <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">FORKS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_FORKS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token comment">//2）获取并执行的 invoker 列表</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>forks <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> forks <span class="token operator">&gt;=</span> invokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                selected <span class="token operator">=</span> invokers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                selected <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> forks<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// TODO. Add some comment here, refer chinese version for more details.</span>
                  <span class="token comment">// 在 invoker 列表（排除 selected）后，如果没有选够，则存在重复循环问题</span>
                    <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> selected<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 防止重复添加 invoker</span>
                        <span class="token comment">//Avoid add the same invoker several times.</span>
                        selected<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          
          <span class="token comment">// 3）使用线程池让 invoker 列表中的 invker 并发地执行</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span> selected<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">:</span> selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            ref<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token comment">// 3.1）所有的 invoker 都调用失败则记录错误</span>
                            <span class="token keyword">int</span> value <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&gt;=</span> selected<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                ref<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">//4.）获取执行结果并返回</span>
                <span class="token class-name">Object</span> ret <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token keyword">instanceof</span> <span class="token class-name">Throwable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Throwable</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span> ret<span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">RpcException</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcException</span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed to forking invoke provider &quot;</span> <span class="token operator">+</span> selected <span class="token operator">+</span> <span class="token string">&quot;, but no luck to perform the invocation. Last error is: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to forking invoke provider &quot;</span> <span class="token operator">+</span> selected <span class="token operator">+</span> <span class="token string">&quot;, but no luck to perform the invocation. Last error is: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// clear attachments which is binding to current thread.</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedInternalThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;forking-cluster-timer&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>代码1获取并行执行的参数，其中forks为并行执行的invoker个数，timeout为调用线程获取执行结果的超时时间（默认为1000ms），这个超时时间与下面配置的接口的timeout超时时间一致：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userServiceNew<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.test.UserServiceBo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">group</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dubbo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.0.0<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>代码2根据设置的forks参数获取并行执行的invoker 列表，如果forks参数值小于等于0或者大于服务提供者机器的个数，则设置forks为提供者机器个数。</p> <p>代码3使用线程池让invoker列表中的invoker并发执行，执行完毕后会把返回结果放入并发安全的队列ref中。这里的count用来记录远程调用过程中出现异常的次数，如果异常次数大于等于forks参数值，则说明有forks个并发调用全部失败了，这时候将把异常放到并发安全的队列ref中。</p> <p>代码4调用队列ref的poll（）方法，poll（）方法带有超时时间，并且当队列ref中含有元素或者超时时间到了的时候返回。代码3并发启动了forks个请求，只要有一个请求返回了，ref中就有元素了，这时poll（）方法就直接返回了远程调用的结果。如果forks个调用都失败了，由于远程调用过程的超时时间和poll（）方法的超时时间相同，并且远程调用是先发起的，那么这时poll（）方法会返回代码3.1里面设置的异常信息。</p> <p>这里需要注意的是，即使代码4的poll返回了一个RPC调用的结果，其他并行的调用还是要继续进行的。</p> <h2 id="_6-7-broadcast-cluster策略源码分析"><a href="#_6-7-broadcast-cluster策略源码分析" class="header-anchor">#</a> 6.7 Broadcast Cluster策略源码分析</h2> <p>在Dubbo中，实现广播调用的是BroadcastClusterInvoker类，这里我们看看具体实现，主要看看doInvoke（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token function">checkInvokers</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span> invokers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcException</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">:</span> invokers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exception <span class="token operator">=</span> e<span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过过上面的代码可知，广播调用是顺序轮询每个服务提供者进行调用的，其中返回给调用方的result为最后一次远程调用返回的结果。</p> <h2 id="_6-8-如何基于扩展接口自定义集群容错策略"><a href="#_6-8-如何基于扩展接口自定义集群容错策略" class="header-anchor">#</a> 6.8 如何基于扩展接口自定义集群容错策略</h2> <p>前面已经讲过，Dubbo 本身提供了丰富的集群容错策略，但是如果你有定制化需求，可以根据Dubbo提供的扩展接口Cluster进行定制。</p> <p>为了自定义扩展实现，首先需要实现Cluster接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCluster</span> <span class="token keyword">implements</span> <span class="token class-name">Cluster</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> directory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyClusterInvoker</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，MyCluster实现了Cluster的join接口。</p> <p>然后，需要集成AbstractClusterInvoker类创建自己的ClusterInvoker类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractClusterInvoker</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">public</span> <span class="token class-name">MyClusterInvoker</span><span class="token operator">&lt;</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> directory<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
		<span class="token function">checkInvokers</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span> invokers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RpcException</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 做自己的集群容错策略  </span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，doInvoke方法需要重写，在该方法内用户就可以实现自己的集群容错策略。
然后，在src/main/resources/MeTA-INF/dubbo目录下创建文件，并在文件里添加myCluster=org.apache.dubbo.demo.cluster.MyCluster，如图6.2所示。</p> <p><img src="/assets/img/image-20240521211017328.b5907f52.png" alt="image-20240521211017328"></p> <p>最后，使用下面的方法将集群容错模式切换为myCluster：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>greetingService<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.books.dubbo.demo.api.GreetingService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">group</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dubbo<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cluster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myCluster<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><h2 id="_6-9-dubbo负载均衡策略概述"><a href="#_6-9-dubbo负载均衡策略概述" class="header-anchor">#</a> 6.9 Dubbo负载均衡策略概述</h2> <p>当服务提供方是集群时，为了避免大量请求一直集中在一个或者几个服务提供方机器上，从而使这些机器负载很高，甚至导致服务不可用，需要做一定的负载均衡策略。Dubbo提供了多种均衡策略，默认为random，也就是每次随机调用一台服务提供者的服务。</p> <p>Dubbo提供的负载均衡策略有如下几种。</p> <h4 id="random-loadbalance-随机策略"><a href="#random-loadbalance-随机策略" class="header-anchor">#</a> Random LoadBalance：随机策略</h4> <p>按照概率设置权重，比较均匀，并且可以动态调节提供者的权重。</p> <h4 id="roundrobin-loadbalance-轮循策略"><a href="#roundrobin-loadbalance-轮循策略" class="header-anchor">#</a> RoundRobin LoadBalance：轮循策略</h4> <p>轮循，按公约后的权重设置轮循比率。会存在执行比较慢的服务提供者堆积请求的情况，比如一个机器执行得非常慢，但是机器没有宕机（如果宕机了，那么当前机器会从ZooKeeper 的服务列表中删除），当很多新的请求到达该机器后，由于之前的请求还没处理完，会导致新的请求被堆积，久而久之，消费者调用这台机器上的所有请求都会被阻塞。</p> <h4 id="leastactive-loadbalance-最少活跃调用数"><a href="#leastactive-loadbalance-最少活跃调用数" class="header-anchor">#</a> LeastActive LoadBalance：最少活跃调用数</h4> <p>如果每个提供者的活跃数相同，则随机选择一个。在每个服务提供者里维护着一个活跃数计数器，用来记录当前同时处理请求的个数，也就是并发处理任务的个数。这个值越小，说明当前服务提供者处理的速度越快或者当前机器的负载比较低，所以路由选择时就选择该活跃度最底的机器。如果一个服务提供者处理速度很慢，由于堆积，那么同时处理的请求就比较多，也就是说活跃调用数目较大（活跃度较高），这时，处理速度慢的提供者将收到更少的请求。</p> <h4 id="consistenthash-loadbalance一致性hash策略"><a href="#consistenthash-loadbalance一致性hash策略" class="header-anchor">#</a> ConsistentHash LoadBalance一致性Hash策略</h4> <p>一致性Hash，可以保证相同参数的请求总是发到同一提供者，当某一台提供者机器宕机时，原本发往该提供者的请求，将基于虚拟节点平摊给其他提供者，这样就不会引起剧烈变动。</p> <p>如上所述，Dubbo提供了丰富的负载均衡策略，但是如果你有定制化需求，可以基于Dubbo提供的扩展接口LoadBalance进行定制。</p> <p>AbstractLoadBalance实现了LoadBalance接口，上面的各种负载均衡策略实际上就是继承了AbstractLoadBalance方法，但重写了其doSelect（）方法，所以下面我们重点看看每种负载均衡策略的doSelect（）方法。</p> <p>我们先看看从消费端发起请求到处理负载均衡的时序图，如图6.3所示。</p> <p><img src="/assets/img/image-20240521214320386.0856a92b.png" alt="image-20240521214320386"></p> <p>从图6.3可以看到，消费端发起远程调用后会先经过步骤4进行服务降级检查，如果发现没有设置降级策略，则会执行步骤5进入集群容错invoker，其内部会先执行步骤6，以便从RegistryDirectory里获取经过服务路由规则过滤后的服务提供者的invokers列表。然后，执行步骤8～步骤11，以便根据具体负载均衡策略从invoker列表中选择一个invoker，最后使用所选的invoker，执行步骤12以发起远程调用。</p> <h2 id="_6-10-random-loadbalance策略源码分析"><a href="#_6-10-random-loadbalance策略源码分析" class="header-anchor">#</a> 6.10 Random LoadBalance策略源码分析</h2> <p>在Dubbo中，实现随机选择策略的是RandomLoadBalance类，这里我们看看具体实现，主要看看doSelect（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Number of invokers</span>
      <span class="token comment">// 1）服务提供方总个数</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Every invoker has the same weight?</span>
      <span class="token comment">// 2）所有服务提供者的权重是否都是一样的</span>
        <span class="token keyword">boolean</span> sameWeight <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// the weight of every invokers</span>
      <span class="token comment">// 3）存放所有服务提供者设置的权重</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// the first invoker's weight</span>
      <span class="token comment">// 4）第一个服务提供者的权重</span>
        <span class="token keyword">int</span> firstWeight <span class="token operator">=</span> <span class="token function">getWeight</span><span class="token punctuation">(</span>invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        weights<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstWeight<span class="token punctuation">;</span>
        <span class="token comment">// The sum of weights</span>
      <span class="token comment">// 5）累加所有的服务提供者设置的权重</span>
        <span class="token keyword">int</span> totalWeight <span class="token operator">=</span> firstWeight<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> weight <span class="token operator">=</span> <span class="token function">getWeight</span><span class="token punctuation">(</span>invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// save for later use</span>
          <span class="token comment">// 保存</span>
            weights<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> weight<span class="token punctuation">;</span>
            <span class="token comment">// Sum</span>
          <span class="token comment">// 求和</span>
            totalWeight <span class="token operator">+=</span> weight<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sameWeight <span class="token operator">&amp;&amp;</span> weight <span class="token operator">!=</span> firstWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sameWeight <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 7）如果所有服务提供者权重并不是都一样，并且至少有一个提供者的权重大于0，则基于总权重随机选择一个</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>totalWeight <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If (not every invoker has the same weight &amp; at least one invoker's weight&gt;0), select randomly based on totalWeight.</span>
            <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>totalWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Return a invoker based on the random value.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                offset <span class="token operator">-=</span> weights<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// If all invokers have the same weight value or totalWeight=0, return evenly.</span>
      <span class="token comment">// 8）如果所有服务提供者权重都一样</span>
        <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1计算服务提供者总个数，也就是服务提供者集群中有多少机器在提供该服务。</p> <p>代码2创建一个变量，用来标识所有服务提供者的权重是否都是一样的。</p> <p>代码3创建一个数组，用来保存所有服务提供者设置的权重。</p> <p>代码4计算第一个服务提供者的权重，并保存到数组中。</p> <p>代码5累加所有服务提供者设置的权重，并且记录所有服务提供者的权重是否都是一样的，如果不一样则将sameWeight设置为false。</p> <p>在代码8中，如果所有服务提供者权重都一样，则使用ThreadLocalRandom.current（）.nextInt（length）从所有服务提供者里随机选择一个服务提供者进行调用。需要注意的是，这里没有使用Random而是使用了ThreadLocalRandom，这是出于性能上的考虑，因为Random在高并发下会导致大量线程竞争同一个原子变量，导致大量线程原地自旋，从而浪费CPU资源（参见笔者编写的《Java并发编程之美》一书）。</p> <p>在代码7中，如果所有服务提供者权重不一样，那么在正常情况下应该选择权重最大的提供者来提供服务，但是Dubbo还考虑到另外一个因素，就是服务预热时间。如果服务提供者A的权重比服务提供者B的权重大，但服务提供者A是刚启动的，而服务提供者B已经服务了一些时间，则这时候Dubbo会选择服务提供者B而不是服务提供者A来进行调用。为此，我们可以看看计算权重的getWeight（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 6.1）</span>
        <span class="token keyword">int</span> weight <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">WEIGHT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_WEIGHT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>weight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 6.2）</span>
            <span class="token keyword">long</span> timestamp <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">REMOTE_TIMESTAMP_KEY</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 6.3）</span>
                <span class="token keyword">int</span> uptime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 6.4）    public static final int DEFAULT_WARMUP = 10 * 60 * 1000;</span>
                <span class="token keyword">int</span> warmup <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">WARMUP_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_WARMUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 6.5）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>uptime <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> uptime <span class="token operator">&lt;</span> warmup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    weight <span class="token operator">=</span> <span class="token function">calculateWarmupWeight</span><span class="token punctuation">(</span>uptime<span class="token punctuation">,</span> warmup<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> weight <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> weight <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码6.1获取用户对该服务提供者设置的权重，默认情况下权重都是100。</p> <p>代码6.2获取该服务提供者发布服务时的时间timestamp。</p> <p>代码6.3计算该服务已经发布了多少时间。</p> <p>代码6.4获取用户设置的该服务的预热时间，默认是10分钟。</p> <p>在代码6.5中，如果该服务提供者还没过预热期，则让该服务提供者的预热时间参与计算权重calculateWarmupWeight：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">calculateWarmupWeight</span><span class="token punctuation">(</span><span class="token keyword">int</span> uptime<span class="token punctuation">,</span> <span class="token keyword">int</span> warmup<span class="token punctuation">,</span> <span class="token keyword">int</span> weight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ww <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> uptime <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> warmup <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ww <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>ww <span class="token operator">&gt;</span> weight <span class="token operator">?</span> weight <span class="token operator">:</span> ww<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果当前服务提供者还没过预热期，则用户设置的权重将通过（float） uptime/（float） warmup打折扣。如果一个服务提供者设置的权重很大，但是还没过预热时间，那么重新计算出来的权重就比实际的小。</p> <p>如果服务提供者已经过了预热期，则这时就会按照用户设置的权重的大小来选择使用哪个服务提供者。</p> <h2 id="_6-11-roundrobin-loadbalance策略源码分析"><a href="#_6-11-roundrobin-loadbalance策略源码分析" class="header-anchor">#</a> 6.11 RoundRobin LoadBalance策略源码分析</h2> <p>在Dubbo中，实现轮询选择策略的是RoundRobinLoadBalance类，这里我们看看具体实现，主要看看doSelect（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）获取调用方法的 key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）获取该调用方法对应的每个服务提供者的 WeightedRoundRobin 对象组成的 Map</span>
        <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> methodWeightMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            methodWeightMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map <span class="token operator">=</span> methodWeightMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
      <span class="token comment">// 3）遍历所有提供者，计算总权重和权重最大的提供者</span>
        <span class="token keyword">int</span> totalWeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> maxCurrent <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> selectedInvoker <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">WeightedRoundRobin</span> selectedWRR <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">:</span> invokers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> identifyString <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIdentityString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WeightedRoundRobin</span> weightedRoundRobin <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>identifyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> weight <span class="token operator">=</span> <span class="token function">getWeight</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>weightedRoundRobin <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                weightedRoundRobin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                weightedRoundRobin<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>identifyString<span class="token punctuation">,</span> weightedRoundRobin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>weight <span class="token operator">!=</span> weightedRoundRobin<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//weight changed</span>
              <span class="token comment">// 权重变化</span>
                weightedRoundRobin<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> cur <span class="token operator">=</span> weightedRoundRobin<span class="token punctuation">.</span><span class="token function">increaseCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            weightedRoundRobin<span class="token punctuation">.</span><span class="token function">setLastUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&gt;</span> maxCurrent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                maxCurrent <span class="token operator">=</span> cur<span class="token punctuation">;</span>
                selectedInvoker <span class="token operator">=</span> invoker<span class="token punctuation">;</span>
                selectedWRR <span class="token operator">=</span> weightedRoundRobin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            totalWeight <span class="token operator">+=</span> weight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 4）更新 Map</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updateLock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> invokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateLock<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// copy -&gt; modify -&gt; update reference</span>
                  <span class="token comment">// 4.1）拷贝新值</span>
                    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment">// 4.2）更新 Map，移除过期的</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> newMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeightedRoundRobin</span><span class="token punctuation">&gt;</span></span> item <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token constant">RECYCLE_PERIOD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token comment">// 4.3）更新</span>
                    methodWeightMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    updateLock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 5）返回选择的提供者的 Invoker 对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedInvoker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            selectedWRR<span class="token punctuation">.</span><span class="token function">sel</span><span class="token punctuation">(</span>totalWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> selectedInvoker<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回第一个，不会走到这里</span>
        <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>RECYCLE_PERIOD是清理周期，如果服务提供者耗时RECYCLE_PERIOD还没有更新自己的WeightedRoundRobin对象，则会被自动回收；updateLock用来确保更新methodWeightMap的线程安全，这里使用了原子变量的CAS操作，减少了因为使用锁带来的开销。</p> <p>代码1获取当前调用方法组成的服务key，比如对于调用<code>com.books.dubbo.demo.api.GreetingService</code>接口的String sayHello（String name）方法来说，key为<code>dubbo/com.books.dubbo.demo.api.GreetingService：1.0.0.sayHello</code>。</p> <p>在代码2中，methodWeightMap是一个Map，其中key就是代码1计算的值。value是一个map，其中key是每个服务提供者机器IP组成的方法的key。这里仍以调用sayHello（）方法为例，key为dubbo：//30.10.75.231：20880/com.books.dubbo.demo.api.GreetingService，对应的value为WeightedRoundRobin对象，WeightedRoundRobin记录了当前提供者的权重和最后一次更新的时间。</p> <p>代码3遍历所有服务提供者，计算所有提供者对于该方法的总权重和和最大权重，其中代码3.1计算当前机器对应的该方法的权重，代码3.2更新该方法对应的权重（current的值）和更新时间，并记录权重最大（current最大）的服务提供者。</p> <p>代码4通过CAS操作，更新methodWeightMap对象。</p> <p>代码5返回选择的提供者的Invoker对象，并把当前提供者对应的方法的权重（current）设置为当前值减去总权重，以便实现轮询对外提供服务。</p> <p>下面我们通过图表的方式来了解一下上面的代码到底是如何工作的：假设我们有机器A、B、C同时提供com.books.dubbo.demo.api.GreetingService接口的String sayHello（String name）方法，并且每个机器设置的提供者的权重分别为1、2、3，下面我们看看如何实现轮询调用。</p> <p>消费端第一次调用服务，如图6.4所示。</p> <p><img src="/assets/img/image-20240521224425059.2e12771e.png" alt="image-20240521224425059"></p> <p>在消费端第一次调用服务时，服务提供者A、B、C对应的WeightedRoundRobin对象里的weight和current如图6.4中的第二列所示，代码3执行完毕后，对应的weight和current值如图6.4中的第三列所示，这时最大权重的机器是C，所以轮询算法选择了机器C来提供服务。</p> <p>消费端第二次调用服务，如图6.5所示。</p> <p><img src="/assets/img/image-20240521224456821.7ebe8f7c.png" alt="image-20240521224456821"></p> <p>在消费端第二次调用服务时，服务提供者A、B、C对应的WeightedRoundRobin对象里的weight和current如图6.5中的第二列所示，代码3执行完毕后，对应的weight和current值如图6.5中的第三列所示，这时最大权重的机器是B，所以轮询算法选择了机器B来提供服务。</p> <p>消费端第三次调用服务，如图6.6所示。</p> <p><img src="/assets/img/image-20240521224535464.07fea27d.png" alt="image-20240521224535464"></p> <p>在消费端第三次调用服务时，服务提供者A、B、C对应的WeightedRoundRobin对象里的weight和current如图6.6中的第二列所示，代码3执行完毕后，对应的weight和current值如图6.6中的第三列所示，这时最大权重的机器是A，所以轮询算法选择了机器A来提供服务。</p> <p>消费端第四次调用服务，如图6.7所示。</p> <p><img src="/assets/img/image-20240521224603062.12eae36d.png" alt="image-20240521224603062"></p> <p>在消费端第四次调用服务时，服务提供者A、B、C对应的WeightedRoundRobin对象里的weight和current如图6.7中的第二列所示，代码3执行完毕后，对应的weight和current值如图6.7中的第三列所示，这时最大权重的机器是C，所以轮询算法选择了机器C来提供服务。</p> <p>消费端第五次调用服务，如图6.8所示。</p> <p><img src="/assets/img/image-20240521224631238.144aa7fc.png" alt="image-20240521224631238"></p> <p>在消费端第五次调用服务时，服务提供者A、B、C对应的WeightedRoundRobin对象里的weight和current如图6.8中的第二列所示，代码3执行完毕后，对应的weight和current值如图6.8中的第三列所示，这时最大权重的机器是B，所以轮询算法选择了机器B来提供服务。</p> <p>消费端第六次调用服务，如图6.9所示。</p> <p><img src="/assets/img/image-20240521224718286.54321ca6.png" alt="image-20240521224718286"></p> <p>在消费端第六次调用服务时，服务提供者A、B、C对应的WeightedRoundRobin对象里的weight和current如图6.9中的第二列所示，代码3执行完毕后，对应的weight和current值如图6.9中的第三列所示，这时最大权重的机器是C，所以轮询算法选择了机器C来提供服务。下一次再次调用时就又回到了第一次调用的情况，也就是说6次调用完成一次轮询。</p> <p>这里的RR算法并不是严格意义上的RR，因为选择提供者时还参考了其设置的权重，如上所述，调用6次服务并不是严格按照A—B—C—A—B—C这样的次序提供服务的，这是因为我们设置的每台机器的权重不一样。如果大家把A、B、C的权重设置成一样的，那么就会发现将以顺序方式选中机器A、B、C作为服务提供者。</p> <h2 id="_6-12-leastactive-loadbalance策略源码分析"><a href="#_6-12-leastactive-loadbalance策略源码分析" class="header-anchor">#</a> 6.12 LeastActive LoadBalance策略源码分析</h2> <p>在Dubbo中，实现最少活跃调用策略的是LeastActiveLoadBalance类，这里我们看看具体实现，主要看看doSelect（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Number of invokers</span>
      <span class="token comment">// 1）服务提供者个数</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The least active value of all invokers</span>
      <span class="token comment">// 2）临时变量，用来暂寸被调用的最少次数</span>
        <span class="token keyword">int</span> leastActive <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）记录调用次数等于最小调用次数的服务提供者个数</span>
        <span class="token comment">// The number of invokers having the same least active value (leastActive)</span>
        <span class="token keyword">int</span> leastCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// 4）记录调用次数等于最小调用次数的服务提供者的下标</span>
        <span class="token comment">// The index of invokers having the same least active value (leastActive)</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> leastIndexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// the weight of every invokers</span>
      <span class="token comment">// 5）记录每个服务提供者的权重</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// The sum of the warmup weights of all the least active invokes</span>
      <span class="token comment">// 6）记录调用次数等于最小调用次数的服务提供者的权重和</span>
        <span class="token keyword">int</span> totalWeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// The weight of the first least active invoke</span>
      <span class="token comment">// 7）记录第一个调用次数等于最小调用次数的服务提供者的权重</span>
        <span class="token keyword">int</span> firstWeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// Every least active invoker has the same weight value?</span>
      <span class="token comment">// 8）所有调用次数等于最小调用次数的服务提供者的权重是否一样</span>
        <span class="token keyword">boolean</span> sameWeight <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>


        <span class="token comment">// Filter out all the least active invokers</span>
      <span class="token comment">// 9）过滤出所有的调用次数等于最小调用次数的服务提供者</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Get the active number of the invoke</span>
          <span class="token comment">// 9.1）获取当前服务提供者被调用次数</span>
            <span class="token keyword">int</span> active <span class="token operator">=</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Get the weight of the invoke configuration. The default value is 100.</span>
          <span class="token comment">// 9.2）计算当前服务提供者的权重（默认为100）</span>
            <span class="token keyword">int</span> afterWarmup <span class="token operator">=</span> <span class="token function">getWeight</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// save for later use</span>
          <span class="token comment">// 9.3）保存当前服务提供者的权重</span>
            weights<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> afterWarmup<span class="token punctuation">;</span>
            <span class="token comment">// If it is the first invoker or the active number of the invoker is less than the current least active number</span>
          <span class="token comment">// 9.4）如果是第一个服务提供者，或者当前服务提供者的调用次数小于当前的最小调用次数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leastActive <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> active <span class="token operator">&lt;</span> leastActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Reset the active number of the current invoker to the least active number</span>
                leastActive <span class="token operator">=</span> active<span class="token punctuation">;</span>
                <span class="token comment">// Reset the number of least active invokers</span>
                leastCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">// Put the first least active invoker first in leastIndexs</span>
                leastIndexes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token comment">// Reset totalWeight</span>
                totalWeight <span class="token operator">=</span> afterWarmup<span class="token punctuation">;</span>
                <span class="token comment">// Record the weight the first least active invoker</span>
                firstWeight <span class="token operator">=</span> afterWarmup<span class="token punctuation">;</span>
                <span class="token comment">// Each invoke has the same weight (only one invoker here)</span>
                sameWeight <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// If current invoker's active value equals with leaseActive, then accumulating.</span>
              <span class="token comment">// 9.5）如果当前提供者的被调用次数等于当前最小调用次数</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>active <span class="token operator">==</span> leastActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Record the index of the least active invoker in leastIndexs order</span>
              <span class="token comment">// 记录调用次数等于最小调用次数的服务提供者的下标</span>
                leastIndexes<span class="token punctuation">[</span>leastCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token comment">// Accumulate the total weight of the least active invoker</span>
              <span class="token comment">// 累加所有的权重</span>
                totalWeight <span class="token operator">+=</span> afterWarmup<span class="token punctuation">;</span>
                <span class="token comment">// If every invoker has the same weight?</span>
              <span class="token comment">// 9.5.1）所有的 invoker 是否权重都一样</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sameWeight <span class="token operator">&amp;&amp;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> afterWarmup <span class="token operator">!=</span> firstWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sameWeight <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Choose an invoker from all the least active invokers</span>
      <span class="token comment">// 10）如果只有一个最小调用次数的 invoker 则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leastCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If we got exactly one invoker having the least active value, return this invoker directly.</span>
            <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndexes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 11）如果最小调用次数的 invoker 有多个并且权重不一样</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sameWeight <span class="token operator">&amp;&amp;</span> totalWeight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If (not every invoker has the same weight &amp; at least one invoker's weight&gt;0), select randomly based on </span>
            <span class="token comment">// totalWeight.</span>
            <span class="token keyword">int</span> offsetWeight <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>totalWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Return a invoker based on the random value.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> leastCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> leastIndex <span class="token operator">=</span> leastIndexes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                offsetWeight <span class="token operator">-=</span> weights<span class="token punctuation">[</span>leastIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetWeight <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      
      <span class="token comment">// 12）如果最小调用次数的 invoker 有多个并且权重一样</span>
        <span class="token comment">// If all invokers have the same weight value or totalWeight=0, return evenly.</span>
        <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndexes<span class="token punctuation">[</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>leastCount<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1～代码8初始化一系列的变量。</p> <p>代码9遍历所有服务提供者，过滤出所有的调用次数等于最小调用次数的服务提供者</p> <blockquote><p>其中代码9.1获取当前服务提供者被调用的次数，代码9.2计算当前服务提供者的权重（默认为100），代码9.3保存当前服务提供者的权重，代码9.4和代码9.5则是计算出最小被调用的次数。由于等于最小被调用次数的服务提供者可能不止一个，所以这里把所有等于最小被调用次数的服务提供者记录到leastIndexes数组中，并且，如果发现这些服务提供者的权重不是一样的，则设置标记sameWeight。</p></blockquote> <p>在代码10中，如果只有一个最小调用次数的服务提供者，则直接返回。</p> <p>在代码11中，如果最小调用次数的invoker有多个并且权重不一样，则使用随机选择策略中的方法来选择一个。</p> <p>在代码12中，如果最小调用次数的invoker有多个并且权重一样，则随机选择一个。</p> <blockquote><p>这里需要注意的是，在2.5.*版本里使用的是单例的Random来生成随机变量，这里替换为ThreadLocalRandom是为了减少高并发下Random导致CAS自旋带来的性能开销。</p></blockquote> <h2 id="_6-13-consistenthash-loadbalance策略源码分析"><a href="#_6-13-consistenthash-loadbalance策略源码分析" class="header-anchor">#</a> 6.13 ConsistentHash LoadBalance策略源码分析</h2> <h3 id="_6-13-1-一致性hash负载均衡策略原理"><a href="#_6-13-1-一致性hash负载均衡策略原理" class="header-anchor">#</a> 6.13.1 一致性Hash负载均衡策略原理</h3> <p>在分布式系统中，负载均衡的问题可以使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器就会固定处理一部分请求（并维护这些请求的信息），从而起到负载均衡的作用。</p> <p>但是普通的余数Hash（用户ID）算法伸缩性很差，当新增或者下线服务器机器时，用户ID与服务器的映射关系会大量失效。一致性Hash则利用Hash环对其进行了改进。</p> <p>为了能直观地理解一致性Hash 原理，这里结合一个简单的例子来讲解。假设有4台服务器，地址为IP1、IP2、IP3、IP4。</p> <ul><li>一致性Hash，首先计算4个IP地址对应的Hash值：Hash（IP1）、Hash（IP2）、Hash（IP3）、Hash（IP4），计算出来的Hash 值是0～最大正整数之间的一个值，这4个值在一致性Hash环上的呈现如图6.10所示。</li></ul> <img src="/assets/img/image-20240522082842048.8d221d66.png" alt="image-20240522082842048" style="zoom:33%;"> <ul><li>在Hash环上按顺时针从整数0开始，一直到最大正整数，我们根据4个IP计算的Hash 值肯定会落到这个Hash 环上的某一个点，至此我们把服务器的4个IP映射到了一致性Hash环上。</li> <li>当用户在客户端进行请求时，首先根据Hash（用户ID）计算路由规则（Hash值），然后看Hash值落到了Hash环的哪个地方，根据Hash值在Hash环上的位置顺时针找距离最近的IP作为路由IP，如图6.11所示。</li></ul> <p>通过图6.11可知，user1、user2的请求会落到服务器IP2进行处理，user3的请求会落到服务器IP3进行处理，user4的请求会落到服务器IP4进行处理，user5、user6的请求会落到服务器IP1进行处理。</p> <img src="/assets/img/image-20240522083036920.9b9fda19.png" alt="image-20240522083036920" style="zoom:33%;"> <p>下面考虑一下当IP2的服务器宕机时会出现什么情况。</p> <p>当IP2的服务器宕机时，一致性Hash环大致如图6.12所示。</p> <img src="/assets/img/image-20240522083356087.20b0a55f.png" alt="image-20240522083356087" style="zoom:33%;"> <p>根据顺时针规则可知，user1、user2 的请求会被服务器IP3 进行处理，而其他用户的请求所对应的处理服务器不变，也就是只有之前被IP2处理的一部分用户的映射关系被破坏了，并且其负责处理的请求被顺时针的下一个节点处理。</p> <p>下面考虑一下当有新增机器加入时会出现什么情况。</p> <p>在新增一个IP5的服务器后，一致性Hash环大致如图6.13所示。</p> <img src="/assets/img/image-20240522083439184.73942ecd.png" alt="image-20240522083439184" style="zoom:33%;"> <p>根据顺时针规则可知，之前user5 的请求应该被IP1 服务器处理，现在被新增的IP5服务器处理，其他用户的请求处理服务器不变，也就是说距新增的服务器顺时针最近的服务器的一部分请求，会被新增的服务器所替代。</p> <h4 id="_1-一致性hash的特性"><a href="#_1-一致性hash的特性" class="header-anchor">#</a> 1.一致性Hash的特性</h4> <p>一致性Hash主要有以下一些特性。</p> <ul><li>单调性（Monotonicity）：单调性是指如果已经有一些请求通过Hash分派到了相应的服务器进行处理，当又有新的服务器加入到系统中时，应保证原有的请求可以被映射到原有的或者新增的服务器上，而不会被映射到原来的其他服务器上。这一点通过上面新增的服务器IP5就可以证明，在新增了IP5后，原来被IP1处理的user6现在还是被IP1处理，原来被IP1处理的user5现在被新增的IP5处理。</li> <li>分散性（Spread）：在分布式环境中，当客户端请求时可能不知道所有服务器的存在，可能只知道其中一部分服务器，从客户端看来，它看到的部分服务器会形成一个完整的Hash环。如果多个客户端都把部分服务器作为一个完整Hash环，那么可能会导致同一个用户的请求被路由到不同的服务器进行处理。这种情况显然是应该避免的，因为它不能保证同一个用户的请求落到同一台服务器。所谓分散性是指上述情况发生的严重程度。</li> <li>平衡性（Balance）：平衡性也就是指负载均衡，是指客户端Hash 后的请求应该能够分散到不同的服务器上。一致性Hash 可以做到每个服务器都进行处理请求，但是不能保证每个服务器处理的请求的数量大致相同，如图6.14所示。</li></ul> <h4 id="_2-虚拟节点"><a href="#_2-虚拟节点" class="header-anchor">#</a> 2.虚拟节点</h4> <p>当服务器节点比较少的时候会出现上面所说的一致性Hash倾斜问题，一种解决方法是多加机器，但加机器是有成本的，那么就加虚拟节点，比如上面三台机器，每台机器引入1个虚拟节点后的一致性Hash环如图6.15所示。</p> <img src="/assets/img/image-20240522084035665.12b798f0.png" alt="image-20240522084035665" style="zoom:33%;"> <p>图中的IP1-1是IP1的虚拟节点，IP2-1是IP2的虚拟节点，IP3-1是IP3的虚拟节点。</p> <p>当物理机器数目为M，虚拟节点为N的时候，实际Hash环上节点个数为M*（N+1）。</p> <h4 id="_3-均匀一致性hash"><a href="#_3-均匀一致性hash" class="header-anchor">#</a> 3.均匀一致性Hash</h4> <p>上一小节我们使用虚拟节点后的图看起来比较均衡，但如果生成虚拟节点的算法不够好，则很可能会得到如图6.16所示的环。</p> <img src="/assets/img/image-20240522084225721.4de9cc7a.png" alt="image-20240522084225721" style="zoom:33%;"> <p>均匀一致性Hash的目标是，如果服务器有N台，客户端的Hash值有M个，那么每台服务器应该处理大概M/N个用户的请求，也就是说每台服务器负载尽量均衡。</p> <h3 id="_6-13-2-源码分析"><a href="#_6-13-2-源码分析" class="header-anchor">#</a> 6.13.2 源码分析</h3> <p>在Dubbo中，实现一致性Hash策略的是ConsistentHashLoadBalance类，这里我们看看具体实现，主要看看doSelect（）方法的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ConsistentHashSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> selector <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConsistentHashSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> selectors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，一致性Hash策略主要是ConsistentHashSelector类实现，其构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> virtualInvokers<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> replicaNumber<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> identityHashCode<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argumentIndex<span class="token punctuation">;</span>

        <span class="token class-name">ConsistentHashSelector</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token keyword">int</span> identityHashCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>virtualInvokers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>identityHashCode <span class="token operator">=</span> identityHashCode<span class="token punctuation">;</span>
            <span class="token class-name">URL</span> url <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 获取设置的虚拟节点个数，默认为 160 个</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>replicaNumber <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token string">&quot;hash.nodes&quot;</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> index <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">COMMA_SPLIT_PATTERN</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token string">&quot;hash.arguments&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            argumentIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>index<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> index<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                argumentIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>index<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker <span class="token operator">:</span> invokers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> address <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> replicaNumber <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> digest <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> h <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> h<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">long</span> m <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>digest<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        virtualInvokers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>这里主要是根据所有服务提供者的invoker列表，生成从Hash环上的节点到服务提供者机器的映射关系，并存放到virtualInvokers中，具体的算法介绍可参见https://en.wikipedia.org/wiki/Consistent_hashing。</p> <blockquote><p>https://cn.dubbo.apache.org/zh-cn/blog/2023/01/30/dubbo3-%E5%BA%94%E7%94%A8%E7%BA%A7%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E8%AE%BE%E8%AE%A1/</p> <p>dubbo 官方博客</p></blockquote> <p>当调用方调用服务时，就是调用ConsistentHashSelector的select（）方法来选择一个服务提供者：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">public</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 1）获取参与一致性 Hash 算法的 key，默认是第一个参数</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">toKey</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 2）根据具体算法计算该 key 对应 md5 值</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> digest <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3）计算该 key 对应 Hash 环上哪一个点，并选择该点对应的服务提供者</span>
            <span class="token keyword">return</span> <span class="token function">selectForKey</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>digest<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>代码1 获取参与一致性Hash算法的key，默认是第一个参数，消费端可以设置hash.arguments指定哪几个参数参与计算。</p> <p>代码2根据具体算法计算该key对应md5值。</p> <p>代码3计算该key对应Hash环上哪一个点，并选择该点对应的服务提供者。</p> <h2 id="_6-14-如何基于扩展接口自定义负载均衡策略"><a href="#_6-14-如何基于扩展接口自定义负载均衡策略" class="header-anchor">#</a> 6.14 如何基于扩展接口自定义负载均衡策略</h2> <p>如前所述，Dubbo本身提供了丰富的负载均衡策略，但是如果你有定制化需求，则可以根据Dubbo提供的扩展接口LoadBalance进行定制。</p> <p>自定义扩展实现，首先需要实现LoadBalance接口，由于Dubbo本身提供了一个抽象类AbstractLoadBalance，所以我们可以直接继承该类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLoadBalance</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalance</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token class-name">Invoker</span> invoker <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// 自定义负载均衡算法，从invokers中选择一个invoker</span>
		invoker <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，MyLoadBalance实现了LoadBalance的doSelect接口。</p> <p>然后，在src/main/resources/META-INF/dubbo/目录下创建文件org.apache.dubbo.rpc.cluster.LoadBalance，并在文件里添加myLoadBalance=com.books.dubbo.demo.loadbalance.MyLoadBalance，如图6.18所示。</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">myLoadBalance</span><span class="token punctuation">=</span><span class="token value attr-value">com.books.dubbo.demo.loadbalance.MyLoadBalance</span>
<span class="token key attr-name">myroundrobin</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.demo.cluster.MyLoadBalance</span>
</code></pre></div><p><img src="/assets/img/image-20240522090644031.ee935e44.png" alt="image-20240522090644031"></p> <p>最后，使用如下方法将负载均衡模式切换为myLoadBalance：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>greetingService<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.books.dubbo.demo.api.GreetingService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">group</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dubbo<span class="token punctuation">&quot;</span></span>
                 <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myLoadBalance<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><h2 id="_6-15-小结"><a href="#_6-15-小结" class="header-anchor">#</a> 6.15 小结</h2> <p>本章主要探讨了Dubbo框架提供的各种集群容错策略以及实现原理，并讲解了当业务需要时如何基于SPI接口实现自己的集群容错策略，然后讲解了Dubbo框架提供的常用的负载均衡策略以及实现原理，并讲解了当业务需要时，如何基于SPI接口实现自己的负载均衡策略。</p> <h2 id="第7章-dubbo线程模型与线程池策略"><a href="#第7章-dubbo线程模型与线程池策略" class="header-anchor">#</a> 第7章 Dubbo线程模型与线程池策略</h2> <blockquote><p>https://www.cnblogs.com/xhj123/p/9095278.html 学习博客</p></blockquote> <h2 id="_7-1-dubbo的线程模型概述"><a href="#_7-1-dubbo的线程模型概述" class="header-anchor">#</a> 7.1 Dubbo的线程模型概述</h2> <p>Dubbo默认的底层网络通信使用的是Netty，服务提供方NettyServer使用两级线程池，其中EventLoopGroup（boss） 主要用来接收客户端的链接请求，并把完成TCP三次握手的连接分发给EventLoopGroup（worker）来处理，我们把boss和worker线程组称为I/O线程。</p> <p>如果服务提供方的逻辑处理能迅速完成，并且不会发起新的I/O请求，那么直接在I/O线程上处理会更快，因为这样减少了线程池调度与上下文切换的开销。</p> <p>但如果处理逻辑较慢，或者需要发起新的I/O请求，比如需要查询数据库，则I/O线程必须派发请求到新的线程池进行处理，否则I/O线程会被阻塞，导致不能接收其他请求。</p> <p>根据请求的消息类是被I/O线程处理还是被业务线程池处理，Dubbo提供了下面几种线程模型。</p> <h4 id="all-alldispatcher类"><a href="#all-alldispatcher类" class="header-anchor">#</a> all（AllDispatcher类）</h4> <p>所有消息都派发到业务线程池，这些消息包括请求、响应、连接事件、断开事件、心跳事件等</p> <p><img src="/assets/img/image-20240522202516548.d28330d5.png" alt="image-20240522202516548"></p> <h4 id="direct-directdispatcher-类"><a href="#direct-directdispatcher-类" class="header-anchor">#</a> direct（DirectDispatcher 类）</h4> <p>所有消息都不派发到业务线程池，全部在IO 线程上直接执行</p> <p><img src="/assets/img/image-20240522202602031.e1bae301.png" alt="image-20240522202602031"></p> <h4 id="message-messageonlydispatcher类"><a href="#message-messageonlydispatcher类" class="header-anchor">#</a> message（MessageOnlyDispatcher类）</h4> <p>只有请求响应消息派发到业务线程池，其他消息如连接事件、断开事件、心跳事件等，直接在I/O线程上执行</p> <p><img src="/assets/img/1057539-20180527101947012-783716641.b328af6e.png" alt="img"></p> <h4 id="execution-executiondispatcher类"><a href="#execution-executiondispatcher类" class="header-anchor">#</a> execution（ExecutionDispatcher类）</h4> <p>只把请求类消息派发到业务线程池处理，但是响应、连接事件、断开事件、心跳事件等消息直接在I/O线程上执行</p> <p><img src="/assets/img/1057539-20180527102219225-1001726464.2c17e341.png" alt="img"></p> <h4 id="connection-connectionordereddispatcher类"><a href="#connection-connectionordereddispatcher类" class="header-anchor">#</a> connection（ConnectionOrderedDispatcher类）</h4> <p>在I/O线程上将连接事件、断开事件放入队列，有序地逐个执行，其他消息派发到业务线程池处理</p> <p><img src="/assets/img/1057539-20180527102603109-106667064.f8c85e27.png" alt="img"></p> <p>在Dubbo中，线程模型的扩展接口为Dispatcher，其提供的上述扩展实现都实现了该接口，其中all模型是默认的线程模型。</p> <h2 id="_7-2-alldispatcher源码剖析"><a href="#_7-2-alldispatcher源码剖析" class="header-anchor">#</a> 7.2 AllDispatcher源码剖析</h2> <p>AllDispatcher对应的是all线程模型的实现，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AllChannelHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">WrappedChannelHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">AllChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 连接完成事件，交给业务线程池处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">CONNECTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;connect event&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process connected event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 连接断开事件，交给业务线程池处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disconnected</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">DISCONNECTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;disconnect event&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process disconnected event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 请求响应事件，交给业务线程池处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">RECEIVED</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO A temporary solution to the problem that the exception information can not be sent to the opposite end after the thread pool is full. Need a refactoring</span>
            <span class="token comment">//fix The thread pool is full, refuses to call, does not return, and causes the consumer to wait for time out</span>
        	<span class="token keyword">if</span><span class="token punctuation">(</span>message <span class="token keyword">instanceof</span> <span class="token class-name">Request</span> <span class="token operator">&amp;&amp;</span> t <span class="token keyword">instanceof</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        		<span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span>message<span class="token punctuation">;</span>
        		<span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        			<span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;Server side(&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) threadpool is exhausted ,detail msg:&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        			<span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        			response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVER_THREADPOOL_EXHAUSTED_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        			response<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        			channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        			<span class="token keyword">return</span><span class="token punctuation">;</span>
        		<span class="token punctuation">}</span>
        	<span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process received event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 异常处理事件</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">caught</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">CAUGHT</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;caught event&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process caught event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，这种线程模型把所有事件都直接交给业务线程池进行处理了。</p> <h2 id="_7-3-directdispatcher源码剖析"><a href="#_7-3-directdispatcher源码剖析" class="header-anchor">#</a> 7.3 DirectDispatcher源码剖析</h2> <p>DirectDispatcher对应的是direct线程模型的实现，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DirectDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，direct线程模型的dispatch（）方法直接返回了参数handler，所以其所有事件的处理都是在I/O线程上进行的。</p> <h2 id="_7-4-messageonlydispatcher源码剖析"><a href="#_7-4-messageonlydispatcher源码剖析" class="header-anchor">#</a> 7.4 MessageOnlyDispatcher源码剖析</h2> <p>MessageOnlyDispatcher对应是message线程模型的实现，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageOnlyDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MessageOnlyChannelHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageOnlyChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">WrappedChannelHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">MessageOnlyChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">RECEIVED</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process received event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，只有请求响应消息派发到业务线程池，其他耗时比较短的连接事件、断开事件、心跳事件等消息则直接在I/O线程上执行。</p> <h2 id="_7-5-executiondispatcher源码剖析"><a href="#_7-5-executiondispatcher源码剖析" class="header-anchor">#</a> 7.5 ExecutionDispatcher源码剖析</h2> <p>ExecutionDispatcher对应是execution线程模型的实现，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutionDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;execution&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionChannelHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutionChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">WrappedChannelHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">ExecutionChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 只把请求类消息派发到业务线程池处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token keyword">instanceof</span> <span class="token class-name">Request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">RECEIVED</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// FIXME: when the thread pool is full, SERVER_THREADPOOL_EXHAUSTED_ERROR cannot return properly,</span>
                <span class="token comment">// therefore the consumer side has to wait until gets timeout. This is a temporary solution to prevent</span>
                <span class="token comment">// this scenario from happening, but a better solution should be considered later.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> message<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;Server side(&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">&quot;) thread pool is exhausted, detail msg:&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVER_THREADPOOL_EXHAUSTED_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process received event.&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            handler<span class="token punctuation">.</span><span class="token function">received</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，只把请求类消息派发到业务线程池处理，但是响应、连接事件、断开事件、心跳事件等消息则直接在I/O线程上执行。这里与message模型不同之处在于，响应类型的事件也是在I/O线程上执行的。</p> <h2 id="_7-6-connectionordereddispatcher源码剖析"><a href="#_7-6-connectionordereddispatcher源码剖析" class="header-anchor">#</a> 7.6 ConnectionOrderedDispatcher源码剖析</h2> <p>ConnectionOrderedDispatcher对应是connection线程模型的实现，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionOrderedDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;connection&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionOrderedChannelHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionOrderedChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">WrappedChannelHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> connectionExecutor<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queuewarninglimit<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ConnectionOrderedChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 1.1）创建线程池</span>
        <span class="token class-name">String</span> threadName <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREAD_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPositiveParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONNECT_QUEUE_CAPACITY</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span>threadName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">AbortPolicyWithReport</span><span class="token punctuation">(</span>threadName<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// FIXME There's no place to release connectionExecutor!</span>
      <span class="token comment">// 1.2）线程池队列元素限制警告</span>
        queuewarninglimit <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONNECT_QUEUE_WARNING_SIZE</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CONNECT_QUEUE_WARNING_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 2）链接建立</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connected</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">checkQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connectionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">CONNECTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;connect event&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process connected event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 3）链接断开</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disconnected</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">checkQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connectionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">DISCONNECTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;disconnected event&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process disconnected event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 请求、响应事件</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">RECEIVED</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//fix, reject exception can not be sent to consumer because thread pool is full, resulting in consumers waiting till timeout.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token keyword">instanceof</span> <span class="token class-name">Request</span> <span class="token operator">&amp;&amp;</span> t <span class="token keyword">instanceof</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> message<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;Server side(&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) threadpool is exhausted ,detail msg:&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVER_THREADPOOL_EXHAUSTED_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process received event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">caught</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> cexecutor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token class-name">ChannelState</span><span class="token punctuation">.</span><span class="token constant">CAUGHT</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;caught event&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; error when process caught event .&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 6）检查线程池队列元素个数</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionExecutor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> queuewarninglimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token string">&quot;connectionordered channel handler `queue size: &quot;</span> <span class="token operator">+</span> connectionExecutor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; exceed the warning limit number :&quot;</span> <span class="token operator">+</span> queuewarninglimit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在代码1中，在构造函数内创建一个只含有一个线程的线程池和一个有限元素的队列，如果设置的参数connect.queue.capacity大于0，则设置为线程池队列容量，否则线程池队列容量为整数最大值，这个线程池用来实现把链接建立和链接断开事件进行顺序化处理。</p> <p>代码2、代码3分别处理链接建立、链接断开事件，可以先使用代码9检查线程池队列的元素个数，个数超过阈值则打印日志，然后把事件放入线程池队列，并使用单线程进行处理。由于是单线程处理，所以其实是“多生产-单消费”模型，实现了把链接建立、链接断开事件的处理变为顺序化处理。</p> <p>代码4、代码5则处理请求事件和异常事件，这里是直接交给了线程池（这个线程池不是connectionExecutor）进行异步处理。</p> <h2 id="_7-7-线程模型的确定时机"><a href="#_7-7-线程模型的确定时机" class="header-anchor">#</a> 7.7 线程模型的确定时机</h2> <p>前面介绍了Dubbo提供的线程模型，下面我们介绍的是何时确定使用哪种线程模型。在前面的3.1节提到，服务提供方会启动NettyServer来监听消费方的链接，其构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandlers</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token class-name">ExecutorUtil</span><span class="token punctuation">.</span><span class="token function">setThreadName</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">SERVER_THREAD_POOL_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里我们主要看看ChannelHandlers.wrap（handler，ExecutorUtil.setThreadName（url，SERVER_THREAD_POOL_NAME））这个代码，该代码加载了具体的线程模型，这是通过ChannelHandlers的wrapInternal方法完成的：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ChannelHandler</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ChannelHandlers</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrapInternal</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">ChannelHandler</span> <span class="token function">wrapInternal</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MultiMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartbeatHandler</span><span class="token punctuation">(</span><span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Dispatcher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里根据URL里的线程模型来选择具体的Dispatcher 实现类。在此，我们再提一下Dubbo提供的Dispatcher实现类，其默认的实现类是all：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">all</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.remoting.transport.dispatcher.all.AllDispatcher</span>
<span class="token key attr-name">direct</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.remoting.transport.dispatcher.direct.DirectDispatcher</span>
<span class="token key attr-name">message</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.remoting.transport.dispatcher.message.MessageOnlyDispatcher</span>
<span class="token key attr-name">execution</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.remoting.transport.dispatcher.execution.ExecutionDispatcher</span>
<span class="token key attr-name">connection</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.remoting.transport.dispatcher.connection.ConnectionOrderedDispatcher</span>
</code></pre></div><h2 id="_7-8-如何基于扩展接口自定义线程模型"><a href="#_7-8-如何基于扩展接口自定义线程模型" class="header-anchor">#</a> 7.8 如何基于扩展接口自定义线程模型</h2> <p>Dubbo提供了常用的线程模型，这些模型可以满足我们绝大部分的需求，但是也可以根据自己的需要进行扩展定制。</p> <p>首先，我们需要实现扩展接口Dispatcher，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">&quot;mydispatcher&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AllChannelHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>然后，我们需要实现自己的Handler，这里的实例为MyChannelHandler，我们需要在项目的src/main/resources目录下创建目录/META-INF/dubbo，并在该目录下创建文件org.apache.dubbo.remoting.Dispatcher，文件内容为mydispatcher=com.books.dubbo.demo.provider.mydispatcher.MyDispatcher。</p> <p>最后，在服务提供者启动时将线程模型设置为mydispatcher即可：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
parameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;dispatcher&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mydispatcher&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceConfig<span class="token punctuation">.</span><span class="token function">setParameters</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_7-9-dubbo的线程池策略"><a href="#_7-9-dubbo的线程池策略" class="header-anchor">#</a> 7.9 Dubbo的线程池策略</h2> <p>我们在上面讲解Dubbo线程模型时提到，为了尽量早地释放Netty的I/O线程，某些线程模型会把请求投递到线程池进行异步处理，那么这里所谓的线程池是什么样的线程池呢？其实这里的线程池ThreadPool也是一个扩展接口SPI，Dubbo提供了该扩展接口的一些实现，具体如下。</p> <h4 id="fixedthreadpool"><a href="#fixedthreadpool" class="header-anchor">#</a> FixedThreadPool</h4> <p>创建一个具有固定个数线程的线程池。</p> <h4 id="limitedthreadpool"><a href="#limitedthreadpool" class="header-anchor">#</a> LimitedThreadPool</h4> <p>创建一个线程池，这个线程池中的线程个数随着需要量动态增加，但是数量不超过配置的阈值。另外，空闲线程不会被回收，会一直存在。</p> <h4 id="eagerthreadpool"><a href="#eagerthreadpool" class="header-anchor">#</a> EagerThreadPool</h4> <p>创建一个线程池，在这个线程池中，当所有核心线程都处于忙碌状态时，将创建新的线程来执行新任务，而不是把任务放入线程池阻塞队列。</p> <h4 id="cachedthreadpool"><a href="#cachedthreadpool" class="header-anchor">#</a> CachedThreadPool</h4> <p>创建一个自适应线程池，当线程空闲1分钟时，线程会被回收；当有新请求到来时，会创建新线程。</p> <h2 id="_7-10-fixedthreadpool源码剖析"><a href="#_7-10-fixedthreadpool源码剖析" class="header-anchor">#</a> 7.10 FixedThreadPool源码剖析</h2> <p>FixedThreadPool的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedThreadPool</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//1）获取线程名称</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREAD_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//2）获取线程池线程个数</span>
        <span class="token keyword">int</span> threads <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//3）获取线程池队列大小</span>
        <span class="token keyword">int</span> queues <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">QUEUES_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_QUEUES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//4）使用 JUC 包的 ThreadPoolExecutor 创建线程池</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>threads<span class="token punctuation">,</span> threads<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                queues <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                        <span class="token punctuation">(</span>queues <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>queues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">NamedInternalThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AbortPolicyWithReport</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>代码1获取用户设置的线程池中线程的名称前缀，如果没有设置，则使用默认名称Dubbo。</p> <p>代码2获取用户设置的线程池中线程的个数，如果没有设置，则使用默认的数值200。</p> <p>代码3获取用户设置的线程池的阻塞队列大小，如果没有设置，则使用默认的数值0。</p> <p>代码4使用JUC包里的ThreadPoolExecutor创建线程池。关于ThreadPoolExecutor</p> <p>这里把ThreadPoolExecutor的核心线程个数和最大线程个数都设置为threads，所以创建的线程池是固定线程个数的线程池。另外，当队列元素为0时，阻塞队列使用的是SynchronousQueue；当队列元素小于0时，使用的是无界阻塞队列LinkedBlockingQueue；当队列元素大于0时，使用的是有界的LinkedBlockingQueue。</p> <p>并且，这里使用了自定义的线程工厂NamedInternalThreadFactory来为线程创建自定义名称，并将线程设置为deamon线程。</p> <p>最后，线程池拒绝策略选择了AbortPolicyWithReport，意味着当线程池队列已满并且线程池中线程都忙碌时，新来的任务会被丢弃，并抛出RejectedExecutionException异常。</p> <h2 id="_7-11-limitedthreadpool源码剖析"><a href="#_7-11-limitedthreadpool源码剖析" class="header-anchor">#</a> 7.11 LimitedThreadPool源码剖析</h2> <p>LimitedThreadPool的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LimitedThreadPool</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）获取线程名称</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREAD_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）获取线程池核心线程个数</span>
        <span class="token keyword">int</span> cores <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CORE_THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CORE_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）获取线程池最大线程个数</span>
        <span class="token keyword">int</span> threads <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4）获取线程池队列大小</span>
        <span class="token keyword">int</span> queues <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">QUEUES_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_QUEUES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 5）使用 JUC 包的 ThreadPoolExecutor 创建线程池</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>cores<span class="token punctuation">,</span> threads<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                queues <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                        <span class="token punctuation">(</span>queues <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>queues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">NamedInternalThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AbortPolicyWithReport</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>代码1获取用户设置的线程池中线程的名称前缀，如果没有设置，则使用默认名称Dubbo。</p> <p>代码2获取用户设置的线程池中核心线程的个数，如果没有设置，则使用默认的数值0。</p> <p>代码3获取用户设置的线程池中最大线程的个数，如果没有设置，则使用默认的数值200。</p> <p>代码4获取用户设置的线程池阻塞队列大小，如果没有设置，则使用默认的数值0。</p> <p>代码5使用JUC包里的ThreadPoolExecutor创建线程池。</p> <h2 id="_7-12-eagerthreadpool源码剖析"><a href="#_7-12-eagerthreadpool源码剖析" class="header-anchor">#</a> 7.12 EagerThreadPool源码剖析</h2> <p>EagerThreadPool的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EagerThreadPool</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）获取线程名称</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREAD_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）获取线程池核心线程个数</span>
        <span class="token keyword">int</span> cores <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CORE_THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CORE_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）获取线程池最大线程个数</span>
        <span class="token keyword">int</span> threads <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4）获取线程池队列大小</span>
        <span class="token keyword">int</span> queues <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">QUEUES_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_QUEUES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 5）获取线程池队列空闲多少时间被回收</span>
        <span class="token keyword">int</span> alive <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ALIVE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ALIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// init queue and executor</span>
      <span class="token comment">// 6）初始化自定义线程池和队列</span>
        <span class="token class-name">TaskQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> taskQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>queues <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> queues<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EagerThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EagerThreadPoolExecutor</span><span class="token punctuation">(</span>cores<span class="token punctuation">,</span>
                threads<span class="token punctuation">,</span>
                alive<span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                taskQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">NamedInternalThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">AbortPolicyWithReport</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskQueue<span class="token punctuation">.</span><span class="token function">setExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码1获取用户设置的线程池中线程的名称前缀，如果没有设置，则使用默认名称Dubbo。</p> <p>代码2获取用户设置的线程池中核心线程的个数，如果没有设置，则使用默认的数值0。</p> <p>代码3获取用户设置的线程池中最大线程的个数，如果没有设置，则使用默认的数值200。</p> <p>代码4获取用户设置的线程池阻塞队列大小，如果没有设置，则使用默认的数值0。</p> <p>代码5获取用户设置的线程被回收的空闲时间值，如果没有设置，则使用默认的数值60*1000。</p> <p>代码6使用自定义线程池EagerThreadPoolExecutor和队列创建需要的线程池。</p> <p>EagerThreadPoolExecutor与JUC包中的ThreadPoolExecutor不同之处在于，对于后者来说，当线程池核心线程个数达到设置的阈值时，新来的任务会被放入线程池队列，等队列满了以后，才会开启新线程来处理任务（前提是当前线程个数没有超过线程池最大线程个数）；而对于前者来说，当线程池核心线程个数达到设置的阈值时，新来的任务不会被放入线程池队列，而是会开启新线程来处理任务（前提是当前线程个数没有超过线程池最大线程个数），当线程个数达到最大线程个数时，才会把任务放入线程池队列。</p> <p>由于EagerThreadPoolExecutor继承自ThreadPoolExecutor，所以在向EagerThreadPoolExecutor提交任务后，最终还是会调用ThreadPoolExecutor的execute（）方法，这里我们简单讲解一下EagerThreadPoolExecutor的功能是如何实现的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ThreadPoolExecutor.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取当前线程池的状态 + 线程池个数变量的组合</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果线程池运行的任务数量小于corePoolSize，开启新线程运行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4）如果线程池处于 RUNNING 状态，则添加任务到阻塞队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 4.1）二次检查</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果当前线程池状态不是 RUNNING，则从队列删除任务，并执行拒绝策略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4.3）否则如果当前线程池线程空，则添加一个线程</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//5）如果队列满了，则新建线程，新增失败则执行决绝策略</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//如果maxPoolSize也用光了，走reject拒绝策略</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在代码3中，当目前线程池线程个数大于等于核心线程个数时会执行代码4。在正常情况下，代码4会把任务添加到队列而不是开启新线程，但是EagerThreadPoolExecutor使用了自己的队列TaskQueue，下面我们看看TaskQueue的offer（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">int</span> currentPoolThreadSize <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// have free worker. put task into queue to let the worker deal with task.</span>
      <span class="token comment">// 6）如果提交到线程池的任务个数小于当前线程池线程个数，则提交到队列，让空闲线程处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">getSubmittedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> currentPoolThreadSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// return false to let executor create new worker.</span>
      <span class="token comment">// 7）如果当前线程池线程个数小于线程池设置的最大个数，返回 false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPoolThreadSize <span class="token operator">&lt;</span> executor<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// currentPoolThreadSize &gt;= max</span>
      <span class="token comment">// 8）如果当前线程池个数小于等于线程池设置的最大个数，则添加到队列</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在代码7中，如果当前线程池线程个数小于线程池设置的最大个数，则返回false，然后执行代码5新开启线程来处理当前任务。</p> <h2 id="_7-13-cachedthreadpool源码剖析"><a href="#_7-13-cachedthreadpool源码剖析" class="header-anchor">#</a> 7.13 CachedThreadPool源码剖析</h2> <p>CachedThreadPool的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）获取线程名称</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREAD_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）获取线程池核心线程个数</span>
        <span class="token keyword">int</span> cores <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CORE_THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CORE_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）获取线程池最大线程个数</span>
        <span class="token keyword">int</span> threads <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4）获取线程池队列大小</span>
        <span class="token keyword">int</span> queues <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">QUEUES_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_QUEUES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 5）获取线程池队列线程空闲多少时间被回收</span>
        <span class="token keyword">int</span> alive <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ALIVE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ALIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>cores<span class="token punctuation">,</span> threads<span class="token punctuation">,</span> alive<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                queues <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                        <span class="token punctuation">(</span>queues <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>queues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">NamedInternalThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AbortPolicyWithReport</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1获取用户设置的线程池中线程的名称前缀，如果没有设置，则使用默认名称Dubbo。</p> <p>代码2获取用户设置的线程池中核心线程的个数，如果没有设置，则使用默认的数值0。</p> <p>代码3获取用户设置的线程池中最大线程的个数，如果没有设置，则使用默认的数值200。</p> <p>代码4获取用户设置的线程池阻塞队列大小，如果没有设置，则使用默认的数值0。</p> <p>代码5获取用户设置的线程被回收的空闲时间值，如果没有设置，则使用默认的数值60*1000。</p> <p>代码6使用JUC包的ThreadPoolExecutor创建线程池，需要注意的是，这里设置了线程池中线程空闲时间，当线程空闲时间达到后，线程会被回收。</p> <h2 id="_7-14-线程池的确定时机"><a href="#_7-14-线程池的确定时机" class="header-anchor">#</a> 7.14 线程池的确定时机</h2> <p>到这里介绍完了线程模型的加载位置，但线程模型中的线程池SPI扩展什么时候加载呢？这里以线程模型AllDispatcher 为例做介绍。线程模型AllDispatcher对应的处理器是AllChannelHandler，其构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AllChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">WrappedChannelHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        executor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorService</span><span class="token punctuation">)</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">ThreadPool</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExecutor</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，在WrappedChannelHandler的构造函数中，根据URL获取了扩展接口ThreadPool 的SPI 实现类。这里再提一下ThreadPool的扩展接口，其默认设置是fixed：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">fixed</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.common.threadpool.support.fixed.FixedThreadPool</span>
<span class="token key attr-name">cached</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.common.threadpool.support.cached.CachedThreadPool</span>
<span class="token key attr-name">limited</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.common.threadpool.support.limited.LimitedThreadPool</span>
<span class="token key attr-name">eager</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.dubbo.common.threadpool.support.eager.EagerThreadPool</span>
</code></pre></div><h2 id="_7-15-如何基于扩展接口自定义线程池策略"><a href="#_7-15-如何基于扩展接口自定义线程池策略" class="header-anchor">#</a> 7.15 如何基于扩展接口自定义线程池策略</h2> <p>Dubbo提供了常用的线程池策略，这些策略可以满足我们绝大部分的需求，但是也可以根据自己的需要进行扩展定制。
首先，需要实现扩展接口ThreadPool，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadPool</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREAD_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_THREAD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> cores <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CORE_THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CORE_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> threads <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">THREADS_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> queues <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">QUEUES_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_QUEUES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> alive <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ALIVE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ALIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>cores<span class="token punctuation">,</span> threads<span class="token punctuation">,</span> alive<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                queues <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                        <span class="token punctuation">(</span>queues <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>queues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">NamedInternalThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AbortPolicyWithReport</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后，需要在项目的src/main/resources目录下创建目录/META-INF/dubbo，并在该目录下创建文件org.apache.dubbo.common.threadpool.ThreadPool，文件内容为mythreadpool=com.books.dubbo.demo.provider.mydispatcher.MyThreadPool。</p> <p>最后，在服务提供者启动时把线程池策略设置为mythreadpool即可：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
parameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;threadpool&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mythreadpool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceConfig<span class="token punctuation">.</span><span class="token function">setParameters</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_7-16-小结"><a href="#_7-16-小结" class="header-anchor">#</a> 7.16 小结</h2> <p>本章首先探讨了Dubbo框架提供的几种常见的线程模型以及实现原理，然后讲解了Dubbo提供的常用的几种线程池策略，并讲解了当业务需要定制线程池策略或者线程模型时，如何基于SPI接口进行定制。</p> <h2 id="第8章-dubbo如何实现泛化引用"><a href="#第8章-dubbo如何实现泛化引用" class="header-anchor">#</a> 第8章 Dubbo如何实现泛化引用</h2> <p>基础篇中我们已经介绍了，基于Dubbo API搭建Dubbo服务时，服务消费端引入了一个SDK二方包，里面存放着服务提供端提供的所有接口类。</p> <p>泛化接口调用方式主要是在服务消费端没有API接口类及模型类元（比如入参和出参的POJO类）的情况下使用，其参数及返回值中没有对应的POJO类，所以全部POJO均转换为Map表示。使用泛化调用时服务消费模块不再需要引入SDK二方包。</p> <p>我们在本章中将探讨Dubbo如何实现泛化调用，主要内容包括：服务消费端如何使用GenericImplFilter拦截泛化调用，把泛化参数进行校验并发起远程调用；服务提供方如何使用GenericFilter拦截请求，并把泛化参数进行反序列化处理，然后把请求转发给具体的服务进行执行。调用流程图如图8.1所示。</p> <p><img src="/assets/img/image-20240523084018073.eb9bfa6a.png" alt="image-20240523084018073"></p> <h2 id="_8-1-服务消费端genericimplfilter源码分析"><a href="#_8-1-服务消费端genericimplfilter源码分析" class="header-anchor">#</a> 8.1 服务消费端GenericImplFilter源码分析</h2> <p>在基础篇中介绍的泛化调用有三个测试类，分别为APiGenericConsumerForTrue、APiGenericConsumerForNativeJava和APiGenericConsumerForBean，三者分别对应三种泛化引用。这里我们使用APiGenericConsumer来替代这三个类进行讲解，首先看看如图8.2所示的时序图。</p> <p><img src="/assets/img/image-20240523084512301.eb4dc9da.png" alt="image-20240523084512301"></p> <p>通过图8.2可知，在消费端使用泛化调用发起请求后，请求会经过包装类ProtocolFilterWrapper创建的责任链。这里只展示了责任链中的GenericImplFilter过滤器，GenericImplFilter处理完后会把请求传递给被包装的DubboInvoker，然后DubboInvoker会发起远程调用，这里我们主要看看GenericImplFilter是如何实现泛化引用的：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> generic <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//1）判断是否为泛化调用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>$<span class="token constant">INVOKE</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span>
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isGeneric</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//1.1）获取泛化参数</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">//1.2）如果为 nativejava 方式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isJavaGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> arg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">error</span><span class="token punctuation">(</span>generic<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token comment">// 1.3）如果为 bean 方式</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isBeanGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>arg <span class="token keyword">instanceof</span> <span class="token class-name">JavaBeanDescriptor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">error</span><span class="token punctuation">(</span>generic<span class="token punctuation">,</span> <span class="token class-name">JavaBeanDescriptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token comment">//1.4）设置泛化调用方式，以便服务端使用</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> invocation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span>
                    <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//2）发起远程调用</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1判断是否为泛化调用，如果不是，则直接指向代码2发起远程调用。</p> <p>如果为泛化调用，则代码1.1获取泛化参数。代码1.2判断泛化调用是否为nativejava方式，如果是，则判断参数是否是byte[]类型的；如果不是，则说明参数传递错误，抛出异常（可以参考在基础篇的实例中讲过的APiGenericConsumerForNativeJava类）。在代码1.3中，如果泛化类型为bean方式，则判断参数是否为JavaBeanDescriptor类型；如果不是，则说明参数错误，抛出异常（可以参考在基础篇的实例中讲过的APiGenericConsumerForBean类）。</p> <h2 id="_8-2-服务提供端genericfilter源码分析"><a href="#_8-2-服务提供端genericfilter源码分析" class="header-anchor">#</a> 8.2 服务提供端GenericFilter源码分析</h2> <p>在3.2节我们讲到，服务提供端默认会把接收到的请求封装为ChannelEventRunnable任务，并投递到业务线程池以便及时释放I/O线程，这里我们就从ChannelEventRunnable的执行开始，看看流程是如何走到GenericFilter的。服务提供端处理请求的时序图如图8.3所示。</p> <p><img src="/assets/img/image-20240523195340393.e555586f.png" alt="image-20240523195340393"></p> <p>从图8.3可以看到，当异步任务被执行时，请求会经过包装类ProtocolFilterWrapper创建的责任链。这里只展示了责任链中的GenericFilter过滤器，GenericFilter处理完后会把请求传递给AbstractProxyInvoker，然后AbstractProxyInvoker会进行本地服务的执行。这里我们主要看看GenericFilter是如何实现泛化引用的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> inv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）判断是否为泛化请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>$<span class="token constant">INVOKE</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">GenericService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 1.1）获取参数名称、参数类型、参数值</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// 1.2）使用反射获取调用方法</span>
                <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">findMethodByMethodSignature</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> types<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>params<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token comment">// 1.3）获取泛化引用方使用的泛化类型</span>
                <span class="token class-name">String</span> generic <span class="token operator">=</span> inv<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    generic <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

              <span class="token comment">// 1.4）泛化类型为空，则使用 generic=true 的泛化方式</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span>
                        <span class="token operator">||</span> <span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isDefaultGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    args <span class="token operator">=</span> <span class="token class-name">PojoUtils</span><span class="token punctuation">.</span><span class="token function">realize</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> params<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getGenericParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment">// 1.5）generic=nativejava的方式</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isJavaGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">UnsafeByteArrayInputStream</span> is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayInputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Serialization</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_SERIALIZATION_NATIVE_JAVA</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> is<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Deserialize argument [&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] failed.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>
                                    <span class="token string">&quot;Generic serialization [&quot;</span> <span class="token operator">+</span>
                                            <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_SERIALIZATION_NATIVE_JAVA</span> <span class="token operator">+</span>
                                            <span class="token string">&quot;] only support message type &quot;</span> <span class="token operator">+</span>
                                            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">+</span>
                                            <span class="token string">&quot; and your message type is &quot;</span> <span class="token operator">+</span>
                                            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token comment">// 1.6）generic=bean 的方式</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isBeanGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">JavaBeanDescriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">JavaBeanSerializeUtil</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JavaBeanDescriptor</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>
                                    <span class="token string">&quot;Generic serialization [&quot;</span> <span class="token operator">+</span>
                                            <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_SERIALIZATION_BEAN</span> <span class="token operator">+</span>
                                            <span class="token string">&quot;] only support message type &quot;</span> <span class="token operator">+</span>
                                            <span class="token class-name">JavaBeanDescriptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                            <span class="token string">&quot; and your message type is &quot;</span> <span class="token operator">+</span>
                                            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token comment">// 1.7）传递请求到 filter 链的下一个 filter，最后执行具体服务</span>
                <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RpcInvocation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> inv<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">hasException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">GenericException</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericException</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token comment">// 1.8）如果泛化类型为 nativejava 则使用 Java 序列化方式对结果进行序列化处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isJavaGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">UnsafeByteArrayOutputStream</span> os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Serialization</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_SERIALIZATION_NATIVE_JAVA</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Serialize result failed.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
               <span class="token comment">// 1.9）如果泛化类型为 bean 则使用 bean 序列化方式对结果进行序列化处理</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isBeanGenericSerialization</span><span class="token punctuation">(</span>generic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token class-name">JavaBeanSerializeUtil</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JavaBeanAccessor</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// 1.10）如果泛化类型为 true，则使用 POJO 序列化方式对结果进行序列化处理</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token class-name">PojoUtils</span><span class="token punctuation">.</span><span class="token function">generalize</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 2）如果不是泛化调用，则直接把请求传播下去</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>在代码1中，判断当前请求是不是泛化调用，如果不是泛化调用，则直接执行代码2把请求传播下去；如果是泛化调用，则执行代码1.1以获取调用方法的参数信息，然后使用代码1.2来获取调用方法的实例。</p> <p>代码1.3用来获取泛化引用方使用的泛化类型，如果泛化类型为空，则代码1.4默认以generic=true的泛化方式对参数进行反序列化处理；如果序列化方式为nativejava，则代码1.5使用Java的反序列化对参数进行反序列化处理；如果泛化类型为bean，则代码1.6使用JavaBeanSerializeUtil对参数进行反序列化处理。</p> <p>代码1.7将请求传递到Filter链的下一个Filter，最后执行具体服务。</p> <p>代码1.8和代码1.9则是根据泛化类型对服务执行结果进行序列化处理，所以服务引用方在收到结果后还需要对结果进行反序列化处理。</p> <h2 id="_8-3-小结"><a href="#_8-3-小结" class="header-anchor">#</a> 8.3 小结</h2> <p>本章首先从服务消费端讲解了如何使用Filter链中的GenericImplFilter对三种泛化调用的参数进行合法性校验，然后讲解了服务提供端接受请求后如何使用Filter链中的GenericFilter对泛化请求进行处理。</p> <h2 id="第9章-dubbo并发控制"><a href="#第9章-dubbo并发控制" class="header-anchor">#</a> 第9章 Dubbo并发控制</h2> <p>由于资源的限制，一般会在服务提供方和消费方限制接口调用的并发数，本章将探讨相关的原理。图9.1是原理的模型图。</p> <p><img src="/assets/img/image-20240523202911467.a1ba13a4.png" alt="image-20240523202911467"></p> <h2 id="_9-1-服务消费端并发控制"><a href="#_9-1-服务消费端并发控制" class="header-anchor">#</a> 9.1 服务消费端并发控制</h2> <p>在基础篇的Demo中，APiConsumerForActiveLimit类使用了消费端并发控制，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//设置激活并发限制个数</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setActives</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//设置隐式参数</span>
		<span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alibaba&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码对com.books.dubbo.demo.api.GreetingService 接口中的所有方法进行了设置，每个方法最多同时并发请求10个。</p> <blockquote><p>其实也可以只设置接口GreetingService中某一个方法的并发请求限制个数：</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodConfig</span><span class="token punctuation">&gt;</span></span> methodList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodConfig</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">MethodConfig</span> methodConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methodConfig<span class="token punctuation">.</span><span class="token function">setActives</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methodConfig<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methodList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>methodConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setMethods</span><span class="token punctuation">(</span>methodList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></blockquote> <p>在服务消费端，具体进行并发控制的是ProtocolFilterWrapper类创建的Filter链中的ActiveLimitFilter（）方法，下面我们看看如图9.2所示的调用时序图。</p> <p><img src="/assets/img/image-20240523203840780.5156058f.png" alt="image-20240523203840780"></p> <p>在上面的代码中，在DubboInvoker的invoke（）方法真正向远端发起RPC请求前，请求会先经过ActiveLimitFilter的invoke（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Activate</span><span class="token punctuation">(</span>group <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONSUMER</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ACTIVES_KEY</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActiveLimitFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）获取 URL 和调用的方法名称</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）获取设置的 actives 的值（默认为0）和最大可用并发数</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ACTIVES_KEY</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）根据 URL 和方法名获取对应的状态对象</span>
        <span class="token class-name">RpcStatus</span> count <span class="token operator">=</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4）判断是不是超过并发限制</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">.</span><span class="token function">beginCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> timeout <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_KEY</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> remain <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
          <span class="token comment">// 4.1）超过并发限制则阻塞当前线程 timeout 时间</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">.</span><span class="token function">beginCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        count<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>remain<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ignore</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> elapsed <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
                    remain <span class="token operator">=</span> timeout <span class="token operator">-</span> elapsed<span class="token punctuation">;</span>
                  <span class="token comment">// 4.2）超过了还没被唤醒则抛出异常</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>remain <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting concurrent invoke timeout in client-side for service:  &quot;</span>
                                <span class="token operator">+</span> invoker<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, method: &quot;</span>
                                <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, elapsed: &quot;</span> <span class="token operator">+</span> elapsed
                                <span class="token operator">+</span> <span class="token string">&quot;, timeout: &quot;</span> <span class="token operator">+</span> timeout <span class="token operator">+</span> <span class="token string">&quot;. concurrent invokes: &quot;</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">getActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">&quot;. max concurrent invoke limit: &quot;</span> <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 5）到这里说明激活并发数没达到限制，则继续 Filter 链的调用，正常发起远程调用</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token comment">// 6）远程调用完成后，当前激活并发减去1，并通过 notifyAll 方法激活所有挂起线程</span>
            count<span class="token punctuation">.</span><span class="token function">endCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> isSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>max <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    count<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码2获取设置的最大活跃并发数，代码2根据URL和调用方法名获取对应方法的RPC状态对象，这里我们来看看RpcStatus是如何统计远程调用状态的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcStatus</span> <span class="token punctuation">{</span>
    
  <span class="token comment">// 7)缓存 key 为接口类，value 为map</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">METHOD_STATISTICS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 8）当前激活并发数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> active <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token comment">// 9）获取方法对应的 RpcStatus</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RpcStatus</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toIdentityString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token constant">METHOD_STATISTICS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">METHOD_STATISTICS</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map <span class="token operator">=</span> <span class="token constant">METHOD_STATISTICS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RpcStatus</span> status <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
  <span class="token comment">// 10）递增方法对应的激活并发数</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">beginCount</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">beginCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">beginCount</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        max <span class="token operator">=</span> <span class="token punctuation">(</span>max <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">:</span> max<span class="token punctuation">;</span>
        <span class="token class-name">RpcStatus</span> appStatus <span class="token operator">=</span> <span class="token function">getStatus</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 10.1）获取方法对应的 RpcStatus</span>
        <span class="token class-name">RpcStatus</span> methodStatus <span class="token operator">=</span> <span class="token function">getStatus</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 10.2）原子性递增方法对应激活并发数，若超过最大限制则返回 false，否则返回 true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodStatus<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            methodStatus<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            appStatus<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
  <span class="token comment">// 11）原子性递减方法对应的激活并发数</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">endCount</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token keyword">long</span> elapsed<span class="token punctuation">,</span> <span class="token keyword">boolean</span> succeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">endCount</span><span class="token punctuation">(</span><span class="token function">getStatus</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">,</span> elapsed<span class="token punctuation">,</span> succeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">endCount</span><span class="token punctuation">(</span><span class="token class-name">RpcStatus</span> status<span class="token punctuation">,</span> <span class="token keyword">long</span> elapsed<span class="token punctuation">,</span> <span class="token keyword">boolean</span> succeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 原子性递减激活并发数</span>
        status<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，在RpcStatus中维护了一个并发安全的METHOD_STATISTICS缓存，其中key为服务接口，value为该服务接口中所有方法的一个缓存，后者ConcurrentMap＜String，RpcStatus＞的key为具体的方法，value为RpcStatus对象。</p> <p>代码9根据URL和方法名称获取方法对应的RpcStatus对象，如果不存在则创建一个新的。</p> <p>代码10则调用beginCount（）方法，参数为URL和方法名，代码10.1首先根据URL和方法名获取对应的RpcStatus对象，接着代码10.2递增该方法状态对象中的原子性变量（增加该方法的并发激活数量），然后判断当前激活并发数量是不是超过了最大并发数，如果是则返回false，否则返回true。</p> <p>如果beginCount（）方法返回了false，则让当前线程挂起timeout时间，然后当前线程会在timeout时间后再被唤醒，或者当其他线程调用了count的notifyAll（）方法时被唤醒。如果超过timeout时间还没被唤醒，则当前线程会自动被唤醒，然后抛出RpcException异常，也就是说远程调用还没到达服务提供方，调用方就抛出异常结束了。</p> <p>如果beginCount（）方法返回了true，则说明当前方法的激活并发数没有达到最大值，此时将执行代码5，继续Filter链的调用，最终向远端发起调用，调用完毕后执行代码6的endCount（）方法以递减当前方法的激活并发数（endCount（）方法的代码见代码11，这里首先根据URL和方法名获取方法对应的RpcStatus变量，然后执行原子性递减）。代码6还调用了当前方法对应的count的notifyAll（）方法来激活代码4.1中被阻塞的线程。</p> <p>综上所述，在客户端并发控制中，如果当激活并发量达到指定值后，当前客户端请求线程会被挂起。如果在等待超时期间激活并发请求量少了，那么阻塞的线程会被激活，然后发送请求到服务提供方；如果等待超时了，则直接抛出异常，这时服务根本就没有发送到服务提供方服务器。</p> <h2 id="_9-2-服务提供端并发控制"><a href="#_9-2-服务提供端并发控制" class="header-anchor">#</a> 9.2 服务提供端并发控制</h2> <p>在基础篇的Demo中，ApiProviderForExecuteLimit使用了服务提供端并发控制：</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> serviceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-provider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GreetingServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		serviceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setExecutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;server is started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码对com.books.dubbo.demo.api.GreetingService 接口中的所有方法进行了设置，每个方法最多同时处理10个请求。</p> <blockquote><p>其实也可以只设置接口GreetingService中的某一个方法的并发处理限制个数：</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodConfig</span><span class="token punctuation">&gt;</span></span> methodList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodConfig</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">MethodConfig</span> methodConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methodConfig<span class="token punctuation">.</span><span class="token function">setExecutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methodConfig<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		methodList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>methodConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		serviceConfig<span class="token punctuation">.</span><span class="token function">setMethods</span><span class="token punctuation">(</span>methodList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></blockquote> <p>上面的代码只设置了sayHello（）方法的同时并发处理数目。</p> <p>在服务提供端，具体进行并发控制的是ProtocolFilterWrapper类创建的Filter链中的ExecuteLimitFilter（）方法，下面我们看看如图9.3所示的调用时序图。</p> <p><img src="/assets/img/image-20240523211020119.b7c5bfcc.png" alt="image-20240523211020119"></p> <p>在上面的代码中，服务提供方的AbstractProxyInvoker的invoke（）方法在真正执行服务处理的前，请求会先经过ExecuteLimitFilter的invoke（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Activate</span><span class="token punctuation">(</span>group <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PROVIDER</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">EXECUTES_KEY</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecuteLimitFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）获取 URL 和调用的方法名称</span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2）获取设置的 executes 的值（默认为0）和最大可用并发数</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">EXECUTES_KEY</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）判断是不是超过并发限制</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">RpcStatus</span><span class="token punctuation">.</span><span class="token function">beginCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to invoke method &quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; in provider &quot;</span> <span class="token operator">+</span>
                    url <span class="token operator">+</span> <span class="token string">&quot;, cause: The service using threads greater than &lt;dubbo:service executes=\&quot;&quot;</span> <span class="token operator">+</span> max <span class="token operator">+</span>
                    <span class="token string">&quot;\&quot; /&gt; limited.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">// 4）到这里说明激活并发数没达到限制，继续 Filter 链的处理，正常执行服务处理</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected exception when ExecuteLimitFilter&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token comment">// 5）当前方法激活并发数减去1</span>
            <span class="token class-name">RpcStatus</span><span class="token punctuation">.</span><span class="token function">endCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> isSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>代码2获取设置的executes的值，代码3递增方法对应的激活并发数。如果并发数超过了设置最大值，则直接抛出异常，否则执行代码4继续Filter链的处理，正常执行服务处理，然后执行代码5将当前方法激活并发数减去1。</p> <p>需要注意的是，服务提供方设置并发数后，如果同时请求数超过了设置的executes的值，则会抛出异常，而不是像消费端设置actives时那样去等待。</p> <h2 id="_9-3-小结"><a href="#_9-3-小结" class="header-anchor">#</a> 9.3 小结</h2> <p>本章首先探讨了Dubbo中消费端如何对并发请求数进行限制，可知当激活并发量达到指定值后，当前客户端请求线程会被挂起，并等待；如果等待超时了，则直接抛出异常，这时服务根本都没有发送到服务提供方服务器。然后，我们探讨了Dubbo中服务提供端如何对并发请求数进行限制，可知服务提供方在设置并发数量后，如果同时请求数量大于设置的executes值，则会直接抛出异常。</p> <h2 id="第10章-dubbo隐式参数传递"><a href="#第10章-dubbo隐式参数传递" class="header-anchor">#</a> 第10章 Dubbo隐式参数传递</h2> <p>在基础篇中我们讲到Dubbo提供了隐式参数传递的功能，即服务调用方可以通过RpcContext.getContext（）.setAttachment（）方法设置附加属性键值对，然后设置的键值对可以在服务提供方服务方法内获取。</p> <p>要实现隐式参数传递，首先需要在服务消费端的AbstractClusterInvoker类的invoke（）方法内，把附加属性键值对放入到RpcInvocation的attachments变量中，然后经过网络传递到服务提供端；服务提供端则使用ContextFilter对请求进行拦截，并从RpcInvocation中获取attachments中的键值对，然后使用RpcContext.getContext（）.setAttachment设置到上下文对象中，其模型图如图10.1所示。</p> <p><img src="/assets/img/image-20240523214533483.f568f90f.png" alt="image-20240523214533483"></p> <h2 id="_10-1-服务消费端abstractclusterinvoker原理剖析"><a href="#_10-1-服务消费端abstractclusterinvoker原理剖析" class="header-anchor">#</a> 10.1 服务消费端AbstractClusterInvoker原理剖析</h2> <p>AbstractClusterInvoker是服务集群容错策略的抽象类，在默认情况下，集群容错策略为FailoverClusterInvoker，其继承了AbstractClusterInvoker，下面我们首先看看如图10.2所示的时序图。</p> <p><img src="/assets/img/image-20240523214645354.d877a25f.png" alt="image-20240523214645354"></p> <p>从图中可以看到，服务消费端启动后最终会到达默认的集群容错策略FailoverClusterInvoker的invoke（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// AbstractClusterInvoker.java    </span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token function">checkWhetherDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// binding attachments into invocation.</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> contextAttachments <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contextAttachments <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> contextAttachments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> invocation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAttachments</span><span class="token punctuation">(</span>contextAttachments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> invokers <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoadBalance</span> loadbalance <span class="token operator">=</span> <span class="token function">initLoadBalance</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">attachInvocationIdIfAsync</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> loadbalance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>上面的代码从上下文中获取附加属性并设置到RpcInvocation对象中，另外RpcContext中的attachments是一个Map结构。</p> <p>服务消费端什么时候会把里面设置的值清除掉呢？其实清除操作是在时序图中ConsumerContextFilter的invoke（）方法内完成的：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setInvocation</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setLocalAddress</span><span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setRemoteAddress</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invocation <span class="token keyword">instanceof</span> <span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> invocation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 具体发起 RPC 调用</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">removeServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token comment">// 清除附加属性</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>当请求发出去后，会清除当前与调用线程关联的线程变量里面的附加属性。</p> <h2 id="_10-2-服务提供方contextfilter原理剖析"><a href="#_10-2-服务提供方contextfilter原理剖析" class="header-anchor">#</a> 10.2 服务提供方ContextFilter原理剖析</h2> <p>上一节讲解了服务消费端如何把隐式参数设置到Invocation参数中，本节我们看看服务提供端接收请求后如何把隐式参数设置到上下文对象中，以便让服务提供方在服务方法内获取，服务提供端ContextFilter过滤器的激活时序与8.1节所讲的GenericFilter的激活时序一致。看ContextFilter的代码：</p> <p><img src="/assets/img/image-20240523215552422.462ad543.png" alt="image-20240523215552422"></p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）从 invocation 对象获取附加属性 Map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attachments <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
        <span class="token comment">// 2）不为 null 则设置到上下文对象重</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attachments <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>attachments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttachments</span><span class="token punctuation">(</span>attachments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>invocation <span class="token keyword">instanceof</span> <span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> invocation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token comment">// 3）清除上下文对象，则附加属性也被回收</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">removeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">removeServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1首先从从invocation对象获取附加属性Map，代码2发现附加属性Map不为null，则添加附加属性到上下文对象的attachments对象里，这样在服务实现方法里就可以通过RpcContext.getContext（）.getAttachment来获取附加属性了。代码3等服务逻辑执行完毕后清除当前线程所关联的上下文对象，由于附加属性属于上下文对象，所以附加属性也会被回收。</p> <h2 id="_10-3-小结"><a href="#_10-3-小结" class="header-anchor">#</a> 10.3 小结</h2> <p>本章主要讲解了Dubbo如何实现隐式参数传递，即为了实现隐式参数传递，首先需要在服务消费端的AbstractClusterInvoker类的invoke（）方法内，把附加属性键值对放入RpcInvocation的attachments变量中，然后经过网络传输到服务提供端；服务提供端则使用ContextFilter对请求进行拦截，并从RpcInvocation中获取attachments中的键值对，接着使用RpcContext.getContext（）.setAttachment将键值对设置到上下文中，然后就可以在服务提供方服务实现类方法里使用RpcContext.getContext（）.getAttachment（）方法获取参数值了。</p> <h2 id="第11章-dubbo全链路异步"><a href="#第11章-dubbo全链路异步" class="header-anchor">#</a> 第11章 Dubbo全链路异步</h2> <h2 id="_11-1-服务消费端异步调用"><a href="#_11-1-服务消费端异步调用" class="header-anchor">#</a> 11.1 服务消费端异步调用</h2> <p>正如Dubbo官网所介绍的，从2.7.0版本开始，Dubbo以CompletableFuture为基础支持所有异步编程接口，解决了2.7.0之前的版本异步调用的不便与功能缺失。</p> <p>异步调用是基于NIO 的非阻塞能力实现并行调用，服务消费端不需要启动多线程即可完成并行调用多个远程服务，相对多线程开销较小。图11.1显示的是Dubbo异步调用链路的流程图。</p> <p><img src="/assets/img/image-20240523220624078.890b5b29.png" alt="image-20240523220624078"></p> <p>图11.1中的步骤1是当服务消费端发起RPC调用时使用的用户线程，用户线程首先使用步骤2创建一个Future对象，接着步骤3会把请求转换为I/O线程来执行，步骤3为异步过程，所以会马上返回，然后用户线程使用步骤4把其创建的Future对象设置到RpcContext中，其后用户线程就返回了。</p> <p>在步骤5中，用户线程可以在某个时间点从RpcContext中获取设置的Future对象，并且使用步骤6来等待调用结果。</p> <p>在步骤7中，当服务提供方返回结果后，调用方线程模型中的线程池中的线程则会把结果使用步骤8写入Future，这时用户线程就可以得到远程调用结果了。</p> <p>图11.1中的实线箭头代表同步调用，虚线箭头表示异步调用。</p> <h3 id="_11-1-1-2-7-0版本前的异步调用实现"><a href="#_11-1-1-2-7-0版本前的异步调用实现" class="header-anchor">#</a> 11.1.1 2.7.0版本前的异步调用实现</h3> <p>2.7.0版本之前的异步调用能力比较弱，比如在基础篇介绍的APiAsyncConsumer类里使用下面的方式进行异步调用：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token comment">//1.创建引用实例，并设置属性</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setApplication</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">(</span><span class="token string">&quot;first-dubbo-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setRegistry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryConfig</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setInterface</span><span class="token punctuation">(</span><span class="token class-name">GreetingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//2. 设置为异步</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//3. 直接返回null</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//4.等待结果</span>
		<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>代码2设置调用为异步方式，代码3直接调用sayHello（）方法会马上返回null。如果要想获取远程调用的真正结果，需要使用代码4获取future对象，并且调用future的get（）系列方法来获取真正的结果，下面我们看看这种方式是如何实现的。</p> <p>在3.4节我们讲到，具体发起远程调用是在DubboInvoker的doInvoke（）方法内，其中会区分是否为异步调用：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 1）执行远程过程调用</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 1.1）是否为异步调用</span>
            <span class="token keyword">boolean</span> isAsync <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.2）是否为 future 方式异步</span>
            <span class="token keyword">boolean</span> isAsyncFuture <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isReturnTypeFuture</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.3）是否为 oneway （不需要响应结果的请求）</span>
            <span class="token keyword">boolean</span> isOneway <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isOneway</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.4）超时等待时间</span>
            <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.5）不需要响应的请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOneway<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 1.6）异步请求</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 1.6.1）</span>
                <span class="token class-name">ResponseFuture</span> future <span class="token operator">=</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// For compatibility</span>
              <span class="token comment">// 为了兼容返回适配器对象</span>
                <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> futureAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// 1.6.2）异步 future</span>
                <span class="token class-name">Result</span> result<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsyncFuture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// register resultCallback, sometimes we need the async result being processed by the filter chain.</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 1.7）同步请求</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果发现是异步调用，代码1.6会调用currentClient.request（inv，timeout）执行远程调用，该调用不会阻塞，而是马上返回一个future对象，返回的future对象会被适配器类FutureAdapter做包装，接着把包装结果设置到RpcContext里，然后返回SimpleAsyncRpcResult，SimpleAsyncRpcResult的构造函数保存了上下文对象（这在后面会具体用到）：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&gt;</span></span> rFuture<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registerCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// employ copy of context avoid the other call may modify the context content</span>
        <span class="token comment">// 为避免其他调用修改上下文内容，这里拷贝保存</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storedContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storedServerContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>另外，由于SimpleAsyncRpcResult的recreate（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">recreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO should we check the status of valueFuture here?</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>为了探究2.7.0版本之前的异步调用的实现原理，我们需要看看代码1.6.1内到底做了什么。其中，currentClient是ReferenceCountExchangeClient的实例，我们首先看看如图11.2所示的时序图。</p> <blockquote><p>本节一开始讲解了Dubbo异步调用链路流程图，当服务消费端业务线程发起请求后，会创建一个DefaultFuture对象并设置到RpcContext中，然后在启动I/O线程发起请求后调用线程就返回了null的结果；当业务线程从RpcContext获取future对象并调用其get（）方法获取真实的响应结果后，当前线程会调用条件变量done的await（）方法而挂起；当服务提供端把结果写回调用方之后，调用方线程模型中线程池里的线程会把结果写入DefaultFuture对象内的结果变量中，接着调用条件变量的signal（）方法来激活业务线程，然后业务线程就会从get（）方法返回响应结果。</p></blockquote> <p><img src="/assets/img/image-20240525101640681.1d832975.png" alt="image-20240525101640681"></p> <p>通过图11.2可知，代码1.6.1最终调用了HeaderExchangeChannel的request（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">ResponseFuture</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token class-name">Object</span> request<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 2）创建 request 对象</span>
        <span class="token class-name">Request</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">setTwoWay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3）创建 DefaultFuture 对象</span>
        <span class="token class-name">DefaultFuture</span> future <span class="token operator">=</span> <span class="token class-name">DefaultFuture</span><span class="token punctuation">.</span><span class="token function">newFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4）发送请求到远端，并返回 future</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码2创建了请求对象，然后代码3创建了一个future对象，代码4使用底层通信异步发送请求（使用Netty的I/O线程把请求写入远端）。因代码4是非阻塞的，所以会马上返回。</p> <p>这里简单提一下，从用户线程发起远程调用到返回request，使用的都是用户线程。由于代码4 channel.send（req）会马上返回，所以不会阻塞用户线程。</p> <h4 id="defaultfuture"><a href="#defaultfuture" class="header-anchor">#</a> DefaultFuture</h4> <p>为了探究异步实现，我们需要看看代码3中的DefaultFuture，其类图如图11.3所示。</p> <img src="/assets/img/image-20240525102044966.228de2f7.png" alt="image-20240525102044966" style="zoom:33%;"> <p>从图11.3可以看到，DefaultFuture中有3个静态变量：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 通道缓存</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token constant">CHANNELS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// future 缓存</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">DefaultFuture</span><span class="token punctuation">&gt;</span></span> <span class="token constant">FUTURES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 超时检查定时器</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Timer</span> <span class="token constant">TIME_OUT_TIMER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashedWheelTimer</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;dubbo-future-timeout&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">30</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>由于是static变量，所以全部DefaultFuture实例共享这3个变量。</p> <p>图11.3中的lock是一个独占锁，done是该锁的一个条件变量：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> done <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>lock和done是为了实现线程之间的通知等待模型，比如调用DefaultFuture的get（）方法的线程为了获取响应结果，内部会调用done.await（）方法挂起调用线程。当接收到响应结果后，调用方线程模型中线程池里的线程会调用received（）方法，其内部会把响应结果设置到DefaultFuture内，然后调用done的signal（）方法激活一个因调用done的await（）系列方法而挂起的线程（比如调用get（）方法被阻塞的线程）。</p> <p>首先我们看看代码3是如何使用newFuture创建DefaultFuture对象的：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DefaultFuture</span> <span class="token function">newFuture</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 5）创建 DefaultFuture 实例</span>
        <span class="token keyword">final</span> <span class="token class-name">DefaultFuture</span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> request<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// timeout check</span>
      <span class="token comment">// 6）超时检查</span>
        <span class="token function">timeoutCheck</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>其中，DefaultFuture构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">DefaultFuture</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 5.1）保存通信通道</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> channel<span class="token punctuation">;</span>
      <span class="token comment">// 5.2）保存请求内容</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
      <span class="token comment">// 5.3）保存请求 ID</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 5.4）保存超时时间</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> timeout <span class="token operator">:</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPositiveParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// put into waiting map.</span>
      <span class="token comment">// 5.5）把当前对象保存到缓存 FUTURES 中</span>
        <span class="token constant">FUTURES</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 5.6）把当前通道保存到缓存 CHANNELS 中</span>
        <span class="token constant">CHANNELS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>DefaultFuture内部保存了请求的信息，包含请求ID、请求通道、请求内容、超时时间，并且把当前DefaultFuture对象保存到缓存中，通道也保存到缓存中，缓存的key为请求ID。</p> <p>代码5创建完DefaultFuture后，代码6检查超时情况，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">timeoutCheck</span><span class="token punctuation">(</span><span class="token class-name">DefaultFuture</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 6.1）创建一个任务</span>
        <span class="token class-name">TimeoutCheckTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutCheckTask</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 6.2）定时 timeout 执行任务</span>
        <span class="token constant">TIME_OUT_TIMER</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码6.1创建了一个可执行任务，代码6.2则当设置的超时时间到了之后执行创建的任务，在任务内会检查调用是否已经完成，具体代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 6.3）如果 future 为 null 或 future 已完成，则返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// create exception response.</span>
          <span class="token comment">// 6.4）创建响应对象</span>
            <span class="token class-name">Response</span> timeoutResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// set timeout status.</span>
          <span class="token comment">// 6.5）设置超时状态</span>
            timeoutResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVER_TIMEOUT</span> <span class="token operator">:</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">CLIENT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeoutResponse<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">getTimeoutMessage</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// handle response.</span>
          <span class="token comment">// 6.6）把超时响应信息设置到 future 内的通道</span>
            <span class="token class-name">DefaultFuture</span><span class="token punctuation">.</span><span class="token function">received</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeoutResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
</code></pre></div><p>当超时时间到了之后，上面的代码会检查任务是否已经完成，如果已经完成则直接返回，否则创建超时事件，并调用DefaultFuture.received把结果设置到future内。</p> <p>到这里我们就讲完了newFuture（）方法的作用，具体来说就是创建一个DefaultFuture对象，并启动一个定时器，然后在超时时间后检查是否已经有响应结果，如果有则直接返回，否则返回超时信息。</p> <p>下面我们看看received（Channel channel，Response response）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 7）从 FUTURES 中移除 ID 对应的 future 对象</span>
            <span class="token class-name">DefaultFuture</span> future <span class="token operator">=</span> <span class="token constant">FUTURES</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 8）如果 future 存在，则调用 doReceived</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                future<span class="token punctuation">.</span><span class="token function">doReceived</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token comment">// 9）从缓存 CHANNELS 移除请求 ID 对应的通道</span>
            <span class="token constant">CHANNELS</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，当发起的请求的结果返回时或者超时时间到了之后，会调用received（）方法，其中代码7把请求ID对应的future从缓存中移除，然后调用doReceived（）方法把响应结果设置到DefaultFuture的结果变量response中：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReceived</span><span class="token punctuation">(</span><span class="token class-name">Response</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> res<span class="token punctuation">;</span>
          <span class="token comment">// 10.1）激活由于调用 done 的 wait 方法被阻塞的一个线程</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>done <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                done<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 11）如果设置了回调，则调用回掉</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，doReceived（）方法会把响应结果设置到response变量里，然后激活一个由于调用done的wait（）方法被阻塞的线程（比如由于调用了get（）系列方法导致线程阻塞的线程）。另外，如果在future上设置了回调，则会调用回调函数。</p> <p>获取执行结果的get（）方法如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果超时时间 &lt;= 0，则使用默认值 1000</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TIMEOUT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 13）如果 future 任务还没有完成</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// 任务没有完成，则挂起线程 timeout ms</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    done<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&gt;</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span>sent <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getTimeoutMessage</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 14）任务完成则直接返回响应结果</span>
        <span class="token keyword">return</span> <span class="token function">returnFromResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，如果超时时间＜=0，则使用默认值1000；如果任务还没完成（响应结果还是为null），则调用条件变量done的await（）方法，让当前线程挂起timeout时间——若在timeout时间内得到了响应结果（也就是说received（）方法被调用了），则当前线程会被激活；如果已经得到响应结果，则直接执行代码14返回结果。</p> <p>简单总结一下：本节一开始讲解了Dubbo异步调用链路流程图，当服务消费端业务线程发起请求后，会创建一个DefaultFuture对象并设置到RpcContext中，然后在启动I/O线程发起请求后调用线程就返回了null的结果；当业务线程从RpcContext获取future对象并调用其get（）方法获取真实的响应结果后，当前线程会调用条件变量done的await（）方法而挂起；当服务提供端把结果写回调用方之后，调用方线程模型中线程池里的线程会把结果写入DefaultFuture对象内的结果变量中，接着调用条件变量的signal（）方法来激活业务线程，然后业务线程就会从get（）方法返回响应结果。</p> <p>这里所讲的这种实现异步调用的方式基于从返回的future调用get（）方法，其缺点是，当业务线程调用get（）方法后业务线程会被阻塞，这不是我们想要的，所以Dubbo提供了在future对象上设置回调函数的方式，让我们实现真正的异步调用。</p> <h4 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h4> <p>先看看在基础篇中介绍的APiAsyncConsumerForCallBack类：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

		<span class="token comment">// 15. 设置为异步</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 16. 直接返回null</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 17.异步执行回调</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FutureAdapter</span><span class="token punctuation">)</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// 返回响应结果</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token class-name">Object</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;result:&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

      <span class="token comment">// 出现异常</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">caught</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;error:&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，这种方式在业务线程获取了future对象后，在其上设置回调函数后马上就会返回，接着等服务提供端把响应结果写回调用方，然后调用方线程模型中线程池里的线程会把结果写入future对象，其后对回调函数进行回调。由此可知，这个过程中是不需要业务线程干预的，实现了真正的异步调用。</p> <p>下面我们看看回调函数的异步方式具体是如何实现的。在代码1.6.1中，在发起远程调用后，把返回的future对象使用FutureAdapter进行了包装，通过RpcContext.getContext（）.getFuture（）获取的其实就是FutureAdapter对象，调用FutureAdapter的getFuture（）方法获取的其实就是DefaultFuture对象，所以代码17是把回调函数设置到了DefaultFuture内，下面我们看看setCallback（）方法：</p> <blockquote><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// DubboInovker    </span>
<span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 1）执行远程过程调用</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 1.1）是否为异步调用</span>
            <span class="token keyword">boolean</span> isAsync <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.2）是否为 future 方式异步</span>
            <span class="token keyword">boolean</span> isAsyncFuture <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isReturnTypeFuture</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.3）是否为 oneway （不需要响应结果的请求）</span>
            <span class="token keyword">boolean</span> isOneway <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isOneway</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.4）超时等待时间</span>
            <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 1.5）不需要响应的请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOneway<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 1.6）异步请求</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 1.6.1）</span>
                <span class="token class-name">ResponseFuture</span> future <span class="token operator">=</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// For compatibility</span>
              <span class="token comment">// 为了兼容返回适配器对象</span>
                <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> futureAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// 1.6.2）异步 future</span>
                <span class="token class-name">Result</span> result<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsyncFuture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// register resultCallback, sometimes we need the async result being processed by the filter chain.</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 1.7）同步请求</span>
                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token class-name">ResponseCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 18）如果响应结果有了，直接调用回调 callback</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 19）设置 callback</span>
            <span class="token keyword">boolean</span> isdone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// 如果没有结果，则设置 callback</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 否则标识已经完成</span>
                    isdone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 19.1）如果响应结果已经有了，则直接调用回调 callback</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isdone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">invokeCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，如果当前任务已经完成则直接执行回调，否则设置回调并等有响应结果时再执行回调。</p> <p>其中，invokeCallback（）方法的代码为：</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeCallback</span><span class="token punctuation">(</span><span class="token class-name">ResponseCallback</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token comment">// 20）调用回调的 done 方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                callbackCopy<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;callback invoke error .result:&quot;</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,url:&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 21）超时则调用 caught 方法</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">CLIENT_TIMEOUT</span> <span class="token operator">||</span> res<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVER_TIMEOUT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeoutException</span> te <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVER_TIMEOUT</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">getErrorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                callbackCopy<span class="token punctuation">.</span><span class="token function">caught</span><span class="token punctuation">(</span>te<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;callback invoke error ,url:&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">RuntimeException</span> re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getErrorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                callbackCopy<span class="token punctuation">.</span><span class="token function">caught</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;callback invoke error ,url:&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>另外，回顾一下前面所讲的doReceived（）方法内的代码10，可知当接收到响应结果后，如果发现回调函数不为null，则也会调用invokeCallback（）方法。</p> <p>上面我们介绍了2.7.0版本之前提供的异步调用方式，Future方式只支持阻塞式的get（）接口获取结果。虽然通过获取内置的ResponseFuture接口，可以设置回调，但获取ResponseFuture的API使用起来很不便，并且无法满足让多个Future协同工作的场景，功能比较单一。</p> <h3 id="_11-1-2-2-7-0版本提供的异步调用实现"><a href="#_11-1-2-2-7-0版本提供的异步调用实现" class="header-anchor">#</a> 11.1.2 2.7.0版本提供的异步调用实现</h3> <p>在基础篇中介绍的APiAsyncConsumerForCompletableFuture2类使用了Dubbo 2.7.0版本提供的基于CompletableFuture的异步调用：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 1.创建服务引用对象，并设置数据</span>
		<span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span> referenceConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceConfig</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GreetingService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">// 2. 设置为异步</span>
		referenceConfig<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 3. 直接返回null</span>
		<span class="token class-name">GreetingService</span> greetingService <span class="token operator">=</span> referenceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>greetingService<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 4.异步执行回调</span>
		<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCompletableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;over&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>代码4可以直接获取到CompletableFuture，然后设置回调，基于CompletableFuture已有的能力，我们可以对CompletableFuture对象进行一系列的操作，以及可以让多个请求的CompletableFuture对象之间进行运算（比如合并两个CompletableFuture对象的结果为一个CompletableFuture对象等）。</p> <p>下面我们看看这是如何实现的，首先看看RpcContext.getContext（）.getCompletableFuture（）到底返回的是什么：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCompletableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，返回的还是FutureAdapter对象，所以我们还要回到FutureAdapter类，该类继承了CompletableFuture类。我们需要看看FutureAdapter类是如何将DefaultFuture转换到CompletableFuture的，为此先看看FutureAdapter的构造函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResponseFuture</span> future<span class="token punctuation">;</span> <span class="token comment">// DefaultFuture 实例</span>
    <span class="token keyword">private</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&gt;</span></span> resultFuture<span class="token punctuation">;</span> <span class="token comment">// CompletableFuture 实例</span>

    <span class="token keyword">public</span> <span class="token class-name">FutureAdapter</span><span class="token punctuation">(</span><span class="token class-name">ResponseFuture</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 5）赋值与初始化</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>future <span class="token operator">=</span> future<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resultFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 6）设置 DefaultFuture 回调</span>
        future<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token class-name">Object</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 6.1）把响应结果设置到 CompletableFuture 中</span>
                <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>
                <span class="token class-name">FutureAdapter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>resultFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">V</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">recreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">FutureAdapter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">FutureAdapter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token comment">// 6.2）把异常设置到 CompletableFuture 中</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">caught</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FutureAdapter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，FutureAdapter继承自CompletableFuture，代码6对传递的DefaultFuture设置回调（在2.7.0版本前，基于回调的异步调用需要我们自己设置回调，为了让CompletableFuture适配上DefaultFuture，专门内建一个回调）。然后，在回调方法的done（）内，把结果写入FutureAdapter继承的CompletableFuture内。</p> <blockquote><p>https://cn.dubbo.apache.org/zh-cn/docsv2.7/dev/source/service-invoking-process/ dubbo 官方讲的不错</p></blockquote> <p>简单总结一下：当业务线程发起远程调用时，会创建一个DefaultFuture实例，接着经过FutureAdapter把DefaultFuture转换为CompletableFuture实例，然后把CompletableFuture实例设置到RpcContext内。业务线程从RpcContext获取该CompletableFuture后，设置业务回调函数。</p> <p>当服务提供方把结果写回调用方之后，调用方的线程模型中线程池里的线程会调用DefaultFuture的received（）方法，并把响应结果写入DefaultFuture，接着调用这里的代码6所设置的回调，回调内部的done（）方法再把结果写入CompletableFuture，然后CompletableFuture会调用业务设置的业务回调函数。</p> <h2 id="_11-2-服务提供端异步执行"><a href="#_11-2-服务提供端异步执行" class="header-anchor">#</a> 11.2 服务提供端异步执行</h2> <p>在Provider端非异步执行时，对调用方发来的请求的处理是在Dubbo内部线程模型的线程池里的线程中执行的（参见第7章和3.2节）。在Dubbo中，服务提供方提供的所有服务接口都是使用这一个线程池来执行的，所以当一个服务执行比较耗时时，可能会占用线程池中很多线程，从而导致其他服务的处理收到影响。</p> <p>Provider端异步执行则将服务的处理逻辑从Dubbo内部线程池切换到业务自定义线程，避免Dubbo线程池中的线程被过度占用，有助于避免不同服务间的互相影响。</p> <p>但需要注意的是，Provider端异步执行对节省资源和提升RPC响应性能是没有效果的，这是因为如果服务处理比较耗时，虽然不是使用Dubbo框架内部线程处理，但还是需要业务自己的线程来处理，另外还有副作用，即会新增一次线程上下文切换（从Dubbo内部线程池线程切换到业务线程），模型如图11.4所示。</p> <p><img src="/assets/img/image-20240523234156485.a9d4771c.png" alt="image-20240523234156485"></p> <p>从图11.4可知，Provider端在同步提供服务时是使用Dubbo内部线程池中的线程来进行处理的，在异步执行时则是使用业务自己设置的线程从Dubbo内部线程池中的线程接收请求进行处理的。</p> <h3 id="_11-2-1-基于定义completablefuture签名的接口实现异步执行"><a href="#_11-2-1-基于定义completablefuture签名的接口实现异步执行" class="header-anchor">#</a> 11.2.1 基于定义CompletableFuture签名的接口实现异步执行</h3> <p>在基础篇的Demo中，GrettingServiceAsyncImpl中的服务提供端实现了基于定义CompletableFuture签名的接口实现异步执行：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrettingServiceAsyncImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrettingServiceAsync</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1.创建业务自定义线程池</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> bizThreadpool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;biz-thread-pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 2.创建服务处理接口，返回值为CompletableFuture</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 2.1 为supplyAsync提供自定义线程池bizThreadpool，避免使用JDK公用线程池(ForkJoinPool.commonPool())</span>
		<span class="token comment">// 使用CompletableFuture.supplyAsync让服务处理异步化进行处理</span>
		<span class="token comment">// 保存当前线程的上下文</span>
		<span class="token class-name">RpcContext</span> context <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;async return &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> context<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> bizThreadpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，基于定义CompletableFuture签名的接口实现异步执行需要接口方法的返回值为CompletableFuture，并且方法内部使用CompletableFuture.supplyAsync让本来该由Dubbo内部线程池中的线程处理的服务，转换为由业务自定义线程池中的线程来处理，CompletableFuture.supplyAsync（）方法会马上返回一个CompletableFuture对象（所以Dubbo内部线程池中的线程会得到及时释放），传递的业务函数则由业务线程池bizThreadpool执行。</p> <p>需要注意的是，调用sayHello（）方法的线程是Dubbo线程模型线程池中的线程，而业务处理是由bizThreadpool中的线程来处理的，所以代码2.1保存了RPC上下文对象，以便在业务处理线程中使用。</p> <p>在3.4节我们提到，当消费端发起远程调用时，请求会被InvokerInvocationHandler拦截，并在其中创建RpcInvocation，并且如果调用方法的返回值为CompletableFuture或者其子类，则会把future_returntype为true和async=true的属性添加到RpcInvocation的附加属性Map中。</p> <p>在3.1节讲到，在Dubbo内部线程池中的线程接收received请求后，当请求被处理时，如果发现请求是需要返回值的，则会调用HeaderExchangeHandler的handleRequest（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ExchangeChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Request</span> req<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Response</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// find handler by message class.</span>
        <span class="token class-name">Object</span> msg <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// handle data.</span>
          <span class="token comment">// 3）调用 DubboProtocol 的 reply 方法</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">reply</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 4）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 如果请求已经完成，则设置结果并写回</span>
                res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token comment">// 5）否则等返回结果后一步调用回掉</span>
            future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Send result to consumer failed, channel is &quot;</span> <span class="token operator">+</span> channel <span class="token operator">+</span> <span class="token string">&quot;, msg is &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// HeaderExchangeChannel.removeChannelIfDisconnected(channel);</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>在上面的代码中，代码3执行的handler.reply的代码为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// org/apache/dubbo/rpc/protocol/dubbo/DubboProtocol.java:90        </span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">reply</span><span class="token punctuation">(</span><span class="token class-name">ExchangeChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 3.1）执行 invoker 调用链</span>
            <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 3.2）写回结果</span>
  <span class="token comment">// 如果结果为 AsyncRpcResult，说明是服务提供方的异步执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 否则为同步执行，则转换结果为 CompletableFuture</span>
                <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>其中，代码3.1最终会调用AbstractProxyInvoker的invoke（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 6）获取上下文对象</span>
        <span class="token class-name">RpcContext</span> rpcContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 6.1）具体执行本地服务调用</span>
            <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 6.2）返回结果</span>
          <span class="token comment">//如果 future_returntype 为 true，则返回结果是 CompletableFuture 类型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isReturnTypeFuture</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcContext<span class="token punctuation">.</span><span class="token function">isAsyncStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ignore obj in case of RpcContext.startAsync()? always rely on user to write back.</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AsyncContextImpl</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rpcContext<span class="token punctuation">.</span><span class="token function">getAsyncContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInternalFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 同步执行时</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码可知，返回结果是CompletableFuture类型，或者使用RpcContext.startAsync（）方法开启异步执行，返回AsyncRpcResult。</p> <p>在代码3.2中，如果发现结果为AsyncRpcResult，则说明是服务提供方的异步执行，此时返回CompletableFuture对象，否则为同步执行，并把结果转换为CompletableFuture对象（同步转异步）。所以，代码3返回的肯定是CompletableFuture对象，无论是同步执行还是异步执行。</p> <p>在接收到CompletableFuture对象后，代码3判断请求处理是否完成。如果请求已经完成，则执行代码4来设置结果并写回到调用方，否则执行代码5，即调用CompletableFuture来设置一个回调，等请求处理完毕后使用业务自己设置的线程池来执行回调，在回调函数内把结果或者错误信息写回调用方。</p> <h3 id="_11-2-2-使用asynccontext实现异步执行"><a href="#_11-2-2-使用asynccontext实现异步执行" class="header-anchor">#</a> 11.2.2 使用AsyncContext实现异步执行</h3> <p>在基础篇的Demo中，GrettingServiceAsyncContextImpl使用了AsyncContext实现异步执行，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrettingServiceAsyncContextImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrettingServiceRpcContext</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1.创建业务自定义线程池</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> bizThreadpool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;biz-thread-pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 2.创建服务处理接口，返回值为CompletableFuture</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 2.1开启异步</span>
		<span class="token keyword">final</span> <span class="token class-name">AsyncContext</span> asyncContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bizThreadpool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">// 2.2 如果要使用上下文，则必须要放在第一句执行</span>
			asyncContext<span class="token punctuation">.</span><span class="token function">signalContextSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 2.3写回响应</span>
			asyncContext<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码2.1调用RpcContext.startAsync（）方法开启服务异步执行，然后返回一个asyncContext，然后把服务处理任务提交到业务线程池后该方法就直接返回了null。在异步任务内，首先执行代码2.2切换任务的上下文，然后休眠500ms充当任务执行，最后代码2.3把任务执行结果写入异步上下文，其实现是参考了Servlet 3.0的异步执行。</p> <p>在这里，由于具体执行业务处理的逻辑不在sayHello（）方法所在的Dubbo内部线程池的线程中，所以不会被阻塞。</p> <p>为了探究其原理，我们先看看RpcContext.startAsync（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AsyncContext</span> <span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.1.1）获取当前线程的上下文对象</span>
        <span class="token class-name">RpcContext</span> currentContext <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2.1.2）为当前线程上下文创建 AsyncContextImpl 实现</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentContext<span class="token punctuation">.</span>asyncContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentContext<span class="token punctuation">.</span>asyncContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncContextImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 2.1.3）启动异步上下文，并返回</span>
        currentContext<span class="token punctuation">.</span>asyncContext<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> currentContext<span class="token punctuation">.</span>asyncContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>上面这些代码的主要作用是为当前调用线程关联的RPC上下文对象关联AsyncContextImpl。AsyncContextImpl构造函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AsyncContextImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storedContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storedServerContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里把当前线程上下文对象保存到了AsyncContextImpl内部（这是因为ThreadLocal变量不能跨线程访问，可以参考《Java并发编程之美》一书）。</p> <p>AsyncContextImpl创建完毕后会被启动，其中AsyncContextImpl的start（）方法为：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可知，这里是为AsyncContextImpl内的future对象创建一个CompletableFuture对象，其中started是原子性boolean变量，为的是避免重复创建CompletableFuture。</p> <p>下面我们看看AsyncContextImpl的signalContextSwitch（）方法，该方法用来将保存在AsyncContextImpl内的上下文信息传递到业务线程池的线程中（也就是说业务线程池中的线程可以通过RpcContext来访问）：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">signalContextSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">restoreContext</span><span class="token punctuation">(</span>storedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">restoreServerContext</span><span class="token punctuation">(</span>storedServerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Restore any other contexts in here if necessary.</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>需要注意的是，signalContextSwitch（）方法需要放在业务线程中的第一句来执行，以避免后面的业务处理使用RpcContext获取上下文信息时出错。</p> <p>下面我们再看看AsyncContextImpl的write（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsyncStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Throwable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Throwable</span> bizExe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
                future<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>bizExe<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 服务结果</span>
                future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;The async response has probably been wrote back by another thread, or the asyncContext has been closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，当业务线程中的服务处理完毕，会把执行结果写入start（）方法创建的CompletableFuture对象内。</p> <p>简单总结一下：当Dubbo线程模型线程池中的线程执行sayHello（）方法时，在方法内通过RpcContext.startAsync（）创建一个AsyncContextImpl实例，接着调用其start（）方法创建一个CompletableFuture对象。然后，在sayHello（）方法把业务处理任务添加到线程池之后，直接返回null。接着，在返回null后，结合上一节在AbstractProxyInvoker的invoke（）方法内代码6.1也返回了null，然后代码6.2通过判断返回结果用RpcContext.startAsync（）开启异步执行，所以使用（（AsyncContextImpl）（rpcContext.getAsyncContext（）））.getInternalFuture（）获取AsyncContextImpl内的future对象，该future对象会被返回给上一节的代码3.1，然后代码3.2把future返回给上一节的代码3，后面的逻辑就与上一节一样了。</p> <h2 id="_11-3-异步调用与执行引入的新问题"><a href="#_11-3-异步调用与执行引入的新问题" class="header-anchor">#</a> 11.3 异步调用与执行引入的新问题</h2> <h3 id="_11-3-1-filter链"><a href="#_11-3-1-filter链" class="header-anchor">#</a> 11.3.1 Filter链</h3> <p>在2.7.0版本之前，在消费端采用异步调用后，由于异步结果在异步线程（Dubbo框架线程模型线程池中的线程）中单独执行，因此DubboInvoker的invoke（）方法在发起远端请求后，会将空的RpcResult对象返回Filter调用链，也就是说，Filter链上的所有Filter获取的远端调用结果都是null，最终null值也直接返回给调用方法。而真正的远端调用结果需要调用方从RpcContext获取future对象来获取，当真正远端结果返回时，已经不会再次走Filter链进行处理了。</p> <p>在2.7.0版本之前，异步调用时序图如图11.5所示。</p> <p><img src="/assets/img/image-20240525132731816.49d4718f.png" alt="image-20240525132731816"></p> <p>从图11.5可知，在2.7.0版本之前，服务消费端的调用在发起远程调用DubboInvoker的invoke（）方法前进入Filter链，如果是异步调用，则DubboInvoker的invoke（）方法会创建一个DefaultFuture对象并设置到RpcContext中，接着返回一个空的RpcResult，然后该RpcResult会一层层返回到Filter链中的Filter，最终返回到业务调用的sayHello（）方法，得到结果null。</p> <p>当调用方要获取真正的响应结果时，则需要首先从RpcContext获取future对象，然后调用其get（）方法进行等待。当服务提供方把服务处理结果写回调用方后，调用方I/O处理线程会把结果传递给调用方线程模型中的线程，从而把结果写入future对象，接着调用方线程就会从future的get（）方法返回，以获取真正的执行结果。可以看到，当真正结果回来时并没有再次执行Filter链。</p> <p>为了解决这个问题，在2.7.0版本中为Filter接口增加了回调接口onResponse：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SPI</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token class-name">Result</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Result</span> result<span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>由此可知，所有实现了Filter扩展接口的实现类都会含有这个默认的onResponse（）方法，并且默认返回传递过来的result。如果有需要的话，实现类可以重写onResponse（）方法，比如FutureFilter：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Activate</span><span class="token punctuation">(</span>group <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONSUMER</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Result</span> result<span class="token punctuation">,</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AsyncRpcResult</span> asyncResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
            asyncResult<span class="token punctuation">.</span><span class="token function">thenApplyWithContext</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">asyncCallback</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> asyncResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">syncCallback</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在2.7.0版本中，在异步调用后，DubboInvoker的invoke（）方法返回的是SimpleAsyncRpcResult对象而不再是RpcResult，前者继承了AsyncRpcResult类，并且其中含有远程调用返回的DefaultFuture。</p> <p>前面我们讲到，Filter链是在ProtocolFilterWrapper的buildInvokerChain（）方法中建立并使用Invoker串联的。在2.7.0版本之前，Invoker的invoke（）方法如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> last <span class="token operator">=</span> invoker<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Filter</span> filter <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> last<span class="token punctuation">;</span>
                last <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token comment">// invoke 直接返回链中 Filter 的结果</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>由上面的代码可知，Filter链中的前一个Filter的结果会直接返回给后一个，而在2.7.0版本中，其代码被修改如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> last <span class="token operator">=</span> invoker<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Filter</span> filter <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> last<span class="token punctuation">;</span>
                last <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token comment">// invoke 方法做了特殊处理</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Result</span> result <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 1）异步调用</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">AsyncRpcResult</span> asyncResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AsyncRpcResult</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
                            asyncResult<span class="token punctuation">.</span><span class="token function">thenApplyWithContext</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> filter<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> asyncResult<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                          <span class="token comment">// 2）同步调用</span>
                            <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在Dubbo 2.7.0中，消费端同步调用会执行代码2，同步调用对应Filter的onResponse（）方法。异步调用则会执行代码1，上面提到了这里的result实际上是SimpleAsyncRpcResult，下面我们看看它的thenApplyWithContext（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token comment">// org/apache/dubbo/rpc/AsyncRpcResult.java:166 </span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">thenApplyWithContext</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resultFuture <span class="token operator">=</span> resultFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>fn<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>beforeContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andThen</span><span class="token punctuation">(</span>afterContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里的resultFuture就是DubboInvoker中的invoke（）方法在执行异步调用返回后创建的FutureAdapter中的resultFuture，它是CompletableFuture对象。</p> <p>其中，函数指针beforeContext的定义为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 把发起远程调用时的线程上下文恢复，并且保存当前的上下文</span>
		<span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">&gt;</span></span> beforeContext <span class="token operator">=</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        tmpContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmpServerContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">restoreContext</span><span class="token punctuation">(</span>storedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">restoreServerContext</span><span class="token punctuation">(</span>storedServerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其中，函数指针afterContext的定义为：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">&gt;</span></span> afterContext <span class="token operator">=</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">restoreContext</span><span class="token punctuation">(</span>tmpContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">restoreServerContext</span><span class="token punctuation">(</span>tmpServerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>thenApplyWithContext（）函数的作用是等得到响应结果后首先执行beforeContext（）函数，以恢复发起远程调用时线程对应的上下文对象，并保存响应线程对应的上下文对象，然后执行传递的fn（）方法，也就是执行filter.onResponse（r，invoker，invocation）来调用当前Filter的onResponse（）方法，最后再调用afterContext（），以恢复保存的响应线程中的上下文。</p> <p>另外，上面的FutureFilter也是同样的逻辑。经过上面的改造后，异步调用流程是这样的：当服务提供端把结果写回调用方后，调用方的线程模型中的线程会把结果写入CompletableFuture对象，接着Filter链中的Filter会执行自己的onResponse（）方法，然后把结果以新的CompletableFuture对象形式返回给Filter链上的一个节点，最后把最终结果写入业务调用方调用的get（）方法的future对象内，这样就获得最终调用结果了。</p> <p>同理，服务提供端异步执行也存在这样的问题，解决方法也是一样的，在此就不再赘述了。</p> <h3 id="_11-3-2-上下文对象传递"><a href="#_11-3-2-上下文对象传递" class="header-anchor">#</a> 11.3.2 上下文对象传递</h3> <p>在服务提供端使用异步调用之前，业务可以直接在服务提供方服务代码内使用RpcContext.getContext（）获取上下文对象，进而可以访问其中保存的内容：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GreetingService</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但在服务提供端使用异步执行后，由于真正执行服务处理的是另外的线程，而RpcContext内部的ThreadLocal变量是不能跨线程访问的，因此在启动异步执行后，需要业务先保存上下文对象，然后在业务线程里再访问：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrettingServiceAsyncImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrettingServiceAsync</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1.创建业务自定义线程池</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> bizThreadpool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;biz-thread-pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 2.创建服务处理接口，返回值为CompletableFuture</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 2.1 为supplyAsync提供自定义线程池bizThreadpool，避免使用JDK公用线程池(ForkJoinPool.commonPool())</span>
		<span class="token comment">// 使用CompletableFuture.supplyAsync让服务处理异步化进行处理</span>
		<span class="token comment">// 保存当前线程的上下文</span>
		<span class="token class-name">RpcContext</span> context <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;async return &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> context<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> bizThreadpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由上面的代码可知，需要先使用代码2.1保存当前线程中的上下文对象，然后在业务线程中，使用代码2.2访问保存的上下文对象中的属性。</p> <p>如果使用了AsyncContext方式的异步执行，则可以方便地使用signalContextSwitch（）方法来实现Context的切换：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrettingServiceAsyncContextImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrettingServiceRpcContext</span> <span class="token punctuation">{</span>

	<span class="token comment">// 1.创建业务自定义线程池</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> bizThreadpool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;biz-thread-pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 2.创建服务处理接口，返回值为CompletableFuture</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 2.1开启异步</span>
		<span class="token keyword">final</span> <span class="token class-name">AsyncContext</span> asyncContext <span class="token operator">=</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bizThreadpool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">// 2.2 如果要使用上下文，则必须要放在第一句执行</span>
			asyncContext<span class="token punctuation">.</span><span class="token function">signalContextSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 2.3写回响应</span>
			asyncContext<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span><span class="token string">&quot;company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码2.2使用signalContextSwitch（）方法实现上下文的切换，然后在业务线程中就可以使用代码2.3的RpcContext.getContext（）方法获取上下文了。</p> <h2 id="_11-4-小结"><a href="#_11-4-小结" class="header-anchor">#</a> 11.4 小结</h2> <p>本章主要讲解了Dubbo框架全链路异步实现，包含服务消费端如何实现异步调用、服务提供端如何实现异步执行、改造为异步后存在哪些问题以及这些问题如何进行解决等。</p> <h2 id="第12章-本地服务暴露与引用原理"><a href="#第12章-本地服务暴露与引用原理" class="header-anchor">#</a> 第12章 本地服务暴露与引用原理</h2> <p>前面的第3章我们讲解了远程服务暴露与引用的流程，这种方式是提供方与消费方通过网络来进行通信的，如图12.1所示。</p> <img src="/assets/img/image-20240525140622954.d11dc31b.png" alt="image-20240525140622954" style="zoom:50%;"> <p>其实Dubbo还提供了一种本地服务暴露与引用的方式，在同一个JVM进程中同时发布与调用同一个服务时，这种方式显得比较重要，因为如果当前JVM内要调用的服务在本JVM进程内已有，则避免了一次远程过程调用，而是直接在JVM内进行通信，如图12.2所示。</p> <img src="/assets/img/image-20240525140659139.ee3beb6d.png" alt="image-20240525140659139" style="zoom:50%;"> <h2 id="_12-1-本地服务暴露流程"><a href="#_12-1-本地服务暴露流程" class="header-anchor">#</a> 12.1 本地服务暴露流程</h2> <p>在3.1节我们提到，本地导出使用了injvm 协议，这是一个伪协议，它不开启端口，不发起远程调用，只在JVM内直接关联，但执行Dubbo的Filter链。</p> <p>首先，我们通过时序图看看本地服务暴露流程，如图12.3所示。</p> <p><img src="/assets/img/image-20240525141123871.6583a80e.png" alt="image-20240525141123871"></p> <p>我们看看ServiceConfig的exportLocal方法是怎么导出服务的：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportLocal</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCAL_PROTOCOL</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">URL</span> local <span class="token operator">=</span> <span class="token class-name">URLBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCAL_PROTOCOL</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token constant">LOCALHOST_VALUE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 2）</span>
            <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>
                    proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 3）</span>
            exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Export dubbo service &quot;</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; to local registry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在代码1中，如果发现协议类型不是injvm，则创建一个新的URL对象，并且设置协议为injvm，然后设置Host为127.0.0.1，端口为0。</p> <p>后面就是与远程服务暴露一样的流程。首先，调用proxyFactory.getInvoker获取代理的对象，其中的proxyFactory也是适配器类，默认ProxyFactory的扩展实现是JavassistProxyFactory，所以这里调用JavassistProxyFactory的getInvoker（）方法来获取代理服务实现类的invoker类。</p> <p>然后，调用protocol.export导出服务，其中的protocol也是扩展接口，这里与远程服务暴露不同之处在于协议类型为injvm，所以会加载扩展实现类InjvmProtocol。由图12.3可知，InjvmProtocol也使用Wrapper类被增强了，并且在ProtocolFilterWrapper内也建立了Filter链。</p> <p>需要注意的是，在InjvmProtocol内有一个static类型的private static InjvmProtocol INSTANCE，而在InjvmProtocol的构造函数内把当前对象赋值给了INSTANCE：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">InjvmProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>另外，由于增强SPI内会缓存每个扩展接口实现的Class对象，所以在整个JVM内对于每个扩展接口来说只会存在一个InjvmProtocol的实例，并且其中INSTANCE保存的就是这个实例对象。</p> <p>下面我们看看InjvmProtocol的export（）方法做了什么：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InjvmExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Exporter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> exporterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Exporter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>在上面的代码中，export（）方法返回了一个InjvmExporter对象，并保存了InjvmProtocol中的exporterMap变量，而InjvmExporter的构造函数为：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token class-name">InjvmExporter</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Exporter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> exporterMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exporterMap <span class="token operator">=</span> exporterMap<span class="token punctuation">;</span>
        exporterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里的key为服务key，比如对服务<code>com.books.dubbo.demo.api.GreetingService</code>来说，其key为<code>dubbo/com.books.dubbo.demo.api.GreetingService:1.0.0</code>。</p> <p>InjvmExporter构造函数把自己放入InjvmProtocol管理的exporterMap缓存中去了，这个很重要，后面会讲到相关内容。</p> <h2 id="_12-2-本地服务引用启动流程"><a href="#_12-2-本地服务引用启动流程" class="header-anchor">#</a> 12.2 本地服务引用启动流程</h2> <p>如果在消费端没有指定scope类型，则启动时会检查当前JVM内是否有导出的服务，如果有则自动开启本地引用（也就是将协议类型修改为injvm）。</p> <p>下面我们看看当没有指定scope类型时，消费端的启动流程，如图12.4所示。</p> <p><img src="/assets/img/image-20240525143039079.44cb0553.png" alt="image-20240525143039079"></p> <p>由图12.4可知，消费端启动时会调用createProxy（）方法来创建代理：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1）引用本地服务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldJvmRefer</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCAL_PROTOCOL</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCALHOST_VALUE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addParameters</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            invoker <span class="token operator">=</span> refprotocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Using injvm service &quot;</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 2）引用远程服务</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>其中，由函数shouldJvmRefer（）决定是开启本地引用还是远程引用，然后其内部会调用InjvmProtocol的isInjvmRefer（）方法来进行判断，后者又会调用其getExporter（）方法从InjvmProtocol的缓存中查看是否有本地暴露的服务：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">static</span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExporter</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Exporter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token class-name">URL</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 看缓存里是否有对应的本地导出服务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmptyMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exporter <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isServiceKeyMatch</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> exporter<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        result <span class="token operator">=</span> exporter<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 没有则返回 null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token comment">// 如果是泛型调用则返回 null</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolUtils</span><span class="token punctuation">.</span><span class="token function">isGeneric</span><span class="token punctuation">(</span>
                result<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GENERIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token comment">// 否则返回缓存里的本地导出服务</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>前面讲过，对应每个扩展接口，在整个JVM内只会有一个InjvmProtocol的实例，并且上一节我们介绍了在本地服务导出时会把导出的服务保存到InjvmProtocol的内部缓存exporterMap中，所以在同一JVM内进行本地引用时，可以根据服务key从exporterMap中找到导出的invoker并返回，所以代码1中的shouldJvmRefer（）方法会返回true。</p> <p>执行代码1将创建一个本地URL，其中Host为127.0.0.1，Port为0，协议为injvm，这些参数与本地服务导出时一致。</p> <p>装配好URL之后，调用refprotocol.refer（interfaceClass，url）进行服务引用，其中refprotocol为扩展接口。由于协议类型为injvm，因此这里会返回SPI中缓存的InjvmProtocol对象，并且该对象也是使用Wrapper包装后的，所以会经过一层层后才调用到InjvmProtocol的refer（）方法（如图12.4所示）。其refer（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> serviceType<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InjvmInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>serviceType<span class="token punctuation">,</span> url<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>由代码可知，该方法返回了一个InjvmInvoker对象，并且保存了InjvmProtocol管理的exporterMap（其中保存了导出的本地服务）。</p> <h2 id="_12-3-本地服务一次引用流程"><a href="#_12-3-本地服务一次引用流程" class="header-anchor">#</a> 12.3 本地服务一次引用流程</h2> <p>面两节我们分别讲解了本地服务如何暴露、本地服务引用的启动流程，本节我们介绍一下发起一次本地引用调用的流程。这里以Provider模块中的APiConsumerInJvm为例画出时序图，如图12.5和图12.6所示。</p> <p><img src="/assets/img/image-20240525144011304.a45381b2.png" alt="image-20240525144011304"></p> <p><img src="/assets/img/image-20240525143958951.ee9e5286.png" alt="image-20240525143958951"></p> <p>如图12.5所示，在发起本地调用后，会进入调用方的Filter链，并最终调用InjvmInvoker的invoke（）方法，其内部又从JVM内唯一的InjvmProtocol实例里获取导出服务对应的InjvmExporter实例，按照图12.6所示的时序，先进入本地服务提供方的Filter链，然后最终调用代理拦截器AbstractProxyInvoker的invoke（）方法以调用服务实现类的对应方法。</p> <h2 id="_12-4-小结"><a href="#_12-4-小结" class="header-anchor">#</a> 12.4 小结</h2> <p>本章主要讲解了Dubbo本地服务发布与引用的原理，可知本地导出使用了injvm 协议，这是一个伪协议，它不开启端口，不发起远程调用，只在JVM 内直接关联，但执行Dubbo的Filter链。</p> <h2 id="第13章-dubbo协议与网络传输"><a href="#第13章-dubbo协议与网络传输" class="header-anchor">#</a> 第13章 Dubbo协议与网络传输</h2> <p>在前面的章节中，我们介绍了服务消费端远程服务调用流程与服务提供端远程服务处理流程，但还有一些东西是我们没有提到的，比如服务消费端如何把服务请求信息序列化为二进制数据、服务提供方如何把消费端发送的二进制数据反序列化为可识别的POJO对象、Dubbo的应用层协议是怎么样的，等等。本章我们就来介绍相关的内容。</p> <h2 id="_13-1-dubbo协议"><a href="#_13-1-dubbo协议" class="header-anchor">#</a> 13.1 Dubbo协议</h2> <p>在TCP协议栈中，每层协议都有自己的协议报文格式，比如TCP是网络七层模型中的传输层，是TCP协议报文格式；在TCP上层是应用层（应用层协议常见的有HTTP协议等），Dubbo协议作为建立在TCP之上的一种应用层协议，自然也有自己的协议报文格式。Dubbo协议也是参考了TCP协议栈中的协议，协议内容由header和body两部分组成，其结构如图13.1所示。</p> <img src="/assets/img/image-20240525144502403.8b56e2ca.png" alt="image-20240525144502403" style="zoom:50%;"> <p>其中，协议头header格式如图13.2所示。</p> <p><img src="/assets/img/image-20240525144556001.b789e0f9.png" alt="image-20240525144556001"></p> <p>由图13.2可知，header总包含了16字节的数据。其中，前两字节为魔数，类似Class类文件里的魔数，这里用来标识一个帧的开始，固定为0xdabb，第一字节固定为0xda，第二字节固定为0xbb。</p> <p>紧跟其后的一字节是请求类型和序列化标记ID的组合结果：requst flag|serializationId。其中，高四位标示请求类型，其枚举值如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">FLAG_REQUEST</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">FLAG_TWOWAY</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">FLAG_EVENT</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
</code></pre></div><p>低四位标示序列化方式，其枚举值如下：</p> <img src="/assets/img/image-20240525145649214.e07084c4.png" alt="image-20240525145649214" style="zoom:33%;"> <p>再后面的一字节是只在响应报文里才设置（在请求报文里不设置），用来标示响应的结果码，具体定义如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * ok.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">OK</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * client side timeout.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">CLIENT_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * server side timeout.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">SERVER_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * channel inactive, directly return the unfinished requests.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">CHANNEL_INACTIVE</span> <span class="token operator">=</span> <span class="token number">35</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * request format error.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">BAD_REQUEST</span> <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * response format error.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">BAD_RESPONSE</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * service not found.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">SERVICE_NOT_FOUND</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * service error.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">SERVICE_ERROR</span> <span class="token operator">=</span> <span class="token number">70</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * internal server error.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">SERVER_ERROR</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * internal server error.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">CLIENT_ERROR</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * server side threadpool exhausted and quick return.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">SERVER_THREADPOOL_EXHAUSTED_ERROR</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre></div><p>其后的8字节是请求ID。</p> <p>最后的4字节是body内容的大小，也就是指定在协议头header内容后的多少字节是协议body的内容。</p> <h2 id="_13-2-服务消费方编码原理"><a href="#_13-2-服务消费方编码原理" class="header-anchor">#</a> 13.2 服务消费方编码原理</h2> <p>在3.3节我们讲到，在消费端启动时，NettyCodecAdapter管理的编解码器被设置到Netty链接的Channel管线里。下面我们看看服务消费端如何对Dubbo协议内容进行编码。</p> <p>另外，在3.4节我们讲到，消费端发起一次调用后，最终会通过DubboInvoker的doInvoke（） 方法内的远程调用客户端对象currentClient的request（）方法把请求发送出去。当网络传输使用Netty时，实际上是把请求转换为任务并投递到了NettyClient对应的Channel管理的异步队列里，这样当前的业务线程就会返回了，Netty会使用I/O线程去异步地执行该任务，把请求通过TCP链接发送出去。Netty异步处理的写入时序图如图13.3所示。</p> <p><img src="/assets/img/image-20240525150046094.7ffc11c2.png" alt="image-20240525150046094"></p> <p>在Netty中，每个Channel（NioSocketChannel）与NioEventLoopGroup中的某一个NioEventLoop固定关联，业务线程就是异步地把请求转换为任务，并写入与当前Channel关联的NioEventLoop内部管理的异步队列中，然后NioEventLoop关联的线程就会去异步执行任务，图13.3就是使用NioEventLoop关联的线程异步地把请求发送出去。</p> <p>在图13.3中，NioEventLoop关联的线程会把请求任务进行传递，即传递给该Channel管理的管线中的每个Handler，其中的一个Handler就是编解码处理器，也就是图13.3中的InternalEncoder，它又把任务委托给DubboCodec对请求任务进行编码，编码完毕执行步骤11，让编码后的数据沿管线继续流转下去。这里我们主要看看DubboCodec是如何按照Dubbo协议对请求进行编码的。</p> <p>先看看DubboCodec的子类ExchangeCodec的encode（）方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">ChannelBuffer</span> buffer<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">Request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 1）编码请求信息</span>
            <span class="token function">encodeRequest</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">Response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 2）编码响应信息</span>
            <span class="token function">encodeResponse</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 3）其他信息进行编码</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>首先我们看encodeRequest如何对请求信息进行编码：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encodeRequest</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">ChannelBuffer</span> buffer<span class="token punctuation">,</span> <span class="token class-name">Request</span> req<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1.1）获取序列化扩展实现</span>
        <span class="token class-name">Serialization</span> serialization <span class="token operator">=</span> <span class="token function">getSerialization</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// header.</span>
      <span class="token comment">// 1.2）创建 Dubbo 协议扩展头字节组</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token constant">HEADER_LENGTH</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// set magic number.</span>
      <span class="token comment">// 1.3）把魔数写入协议</span>
        <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">short2bytes</span><span class="token punctuation">(</span><span class="token constant">MAGIC</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// set request and serialization flag.</span>
      <span class="token comment">// 1.4）设置请求类型与序列化类型</span>
        header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">FLAG_REQUEST</span> <span class="token operator">|</span> serialization<span class="token punctuation">.</span><span class="token function">getContentTypeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token constant">FLAG_TWOWAY</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token constant">FLAG_EVENT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// set request id.</span>
      <span class="token comment">// 1.5）请求 id 设置到协议头</span>
        <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">long2bytes</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// encode request data.</span>
      <span class="token comment">// 1.6）使用代码 1.1 获取的序列化方式对象数据部分进行编码，并把协议数据部分写入缓存</span>
        <span class="token keyword">int</span> savedWriteIndex <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span>savedWriteIndex <span class="token operator">+</span> <span class="token constant">HEADER_LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChannelBufferOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChannelBufferOutputStream</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutput</span> out <span class="token operator">=</span> serialization<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">encodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> out<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">encodeRequestData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> out<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 1.7）刷新缓存</span>
        out<span class="token punctuation">.</span><span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token keyword">instanceof</span> <span class="token class-name">Cleanable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Cleanable</span><span class="token punctuation">)</span> out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        bos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 1.8）检查 payload（协议数据部分）是否合法</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">writtenBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkPayload</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">int2bytes</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> header<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// write</span>
      <span class="token comment">// 1.9）将协议头写入缓存</span>
        buffer<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span>savedWriteIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// write header.</span>
        buffer<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span>savedWriteIndex <span class="token operator">+</span> <span class="token constant">HEADER_LENGTH</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1.1获取序列化扩展实现，默认为hession序列化方式。</p> <p>代码1.2创建Dubbo协议扩展头字节数组，由于Dubbo协议的协议头部分为16字节，所以这里创建了16字节的byte数组。</p> <p>代码1.3把魔数0xdabb写入协议头的前两字节。</p> <p>代码1.4则把请求类型与序列化类型标记到协议头第3字节。</p> <p>代码1.5把请求ID写入协议头的第5～12字节，由于是request类型，所以第4字节的响应码是不需要设置的。</p> <p>代码1.6使用代码1.1获取的序列化方式对象数据部分进行编码，并把协议数据部分写入缓存（buffer）。</p> <p>代码1.7 刷新缓存。在代码1.8中，checkPayload检查协议数据部分是否超过了设置的大小，如果是则抛出异常：</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkPayload</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> payload <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAYLOAD</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            payload <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PAYLOAD_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAYLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">&gt;</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果检查合法，则把协议数据部分的大小写入协议头的第12～16字节。</p> <p>代码1.9则首先把缓存的写入下标移动到写入协议数据前的位置，然后把协议头写入缓存，这时缓存里存放了完整的Dubbo协议帧（协议头+协议数据体），最后把缓存的写入下标设置为写入Dubbo协议帧后面的位置。</p> <blockquote><p>其实，encodeResponse对响应信息进行编码与encodeRequest代码类似，不同之处在于，前者需要对协议头的第4字节写入响应类型。</p></blockquote> <h2 id="_13-3-服务发布方解码原理"><a href="#_13-3-服务发布方解码原理" class="header-anchor">#</a> 13.3 服务发布方解码原理</h2> <p>大家都知道，在客户端与服务端进行网络通信时，客户端会通过socket把需要发送的内容序列化为二进制流后发送出去，接着二进制流通过网络流向服务器端，服务端接收到该请求后会解析该请求包，然后反序列化后对请求进行处理。这看似是一个很简单的过程，但细细想来却会发现没有那么简单。图13.4显示的是客户端与服务端交互的流程。</p> <p><img src="/assets/img/image-20240525153245019.bd5bc1b4.png" alt="image-20240525153245019"></p> <p>由图13.4可知，在客户端发送数据时，实际是把数据写入TCP发送缓存里，如果发送的包的大小比TCP发送缓存的容量大，那么这个数据包就会被分成多个包，通过socket多次发送到服务端。而服务端获取数据是从接收缓存里获取的，假设服务端第一次从接收缓存里获取的数据是整个包的一部分，这时就产生了半包现象。半包不是说只收到了全包的一半，是说收到了全包的一部分。</p> <p>服务器读取到半包数据后，会对读取的二进制流进行解析，一般情况下会把二进制流反序列化为对象，但由于服务器只读取了客户端序列化对象后的一部分，所以反序列化会报错。</p> <p>同理，如果发送的数据包大小比TCP发送缓存的容量小，并且假设TCP缓存可以存放多个包，那么客户端和服务端的一次通信就可能传递了多个包，这时服务端就可能从接收缓存一下读取了多个包，这样就出现了粘包现象。由于服务端从接收缓存获取的二进制流是多个对象转换来的，所以在后续的反序列化时肯定也会出错。</p> <p>其实，出现粘包和半包的原因是TCP层不知道上层业务的包的概念，它只是简单地传递流，所以需要上层的应用层协议来识别读取的数据是不是一个完整的包。</p> <p>在3.1节我们提到，NettyServer启动时把NettyCodecAdapter内部管理的编解码器注入链接Channel的管线内。下面我们看看服务提供端是如何对Dubbo协议的内容进行解码的。</p> <p>另外，在3.2节我们是直接从NettyServer的received（）方法开始讲起的，下面我们看看源头，也就是如何从Netty的NioEventLoop里从TCP缓存读取请求数据，然后经过解码操作后调用NettyServer的received（）方法的。首先我们看看如图13.5所示的时序图。</p> <p><img src="/assets/img/image-20240525153514381.cf96df19.png" alt="image-20240525153514381"></p> <p>如前所述，在Netty中，每个Channel（NioSocketChannel）与NioEventLoopGroup中的某一个NioEventLoop固定关联，NettyServer会为每个接收的链接创建一个Channel对象，这个Channel对象也会与Worker NioEventLoopGroup中的某一个NioEventLoop固定关联。另外，每个NioEventLoop会管理一个Selector对象和一个线程，线程会不断检查注册到该Selector对象上的Channel是否有读取事件，如果有，则从TCP缓存读取数据。</p> <p>由图13.5可知，当有读取事件时，NioEventLoop关联的线程会从缓存读取数据，然后把数据传递给该Channel管理的管线中的handler，这里会把数据传递给NettyCodecAdapter的内部类InternalDecoder，下面我们看看它的channelRead（）方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// io/netty/handler/codec/ByteToMessageDecoder.java:254    </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CodecOutputList</span> out <span class="token operator">=</span> <span class="token class-name">CodecOutputList</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">ByteBuf</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
                first <span class="token operator">=</span> cumulation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cumulation <span class="token operator">=</span> data<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    cumulation <span class="token operator">=</span> cumulator<span class="token punctuation">.</span><span class="token function">cumulate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cumulation<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">callDecode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cumulation<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DecoderException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DecoderException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">fireChannelRead</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> out<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，解码操作是在callDecode（）方法中完成的。callDecode（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//org.apache.dubbo.remoting.transport.netty4.NettyCodecAdapter.InternalDecoder#decode</span>
				<span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> input<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

            <span class="token class-name">ChannelBuffer</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyBackedChannelBuffer</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">NettyChannel</span> channel <span class="token operator">=</span> <span class="token class-name">NettyChannel</span><span class="token punctuation">.</span><span class="token function">getOrAddChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// decode object.</span>
              <span class="token comment">// 具体解析二进制位 dubbo 协议帧对象</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 0.0 保存缓存的当前读取下标</span>
                    <span class="token keyword">int</span> saveReaderIndex <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment">// 0.1 解析二进制数据为对象</span>
                    <span class="token class-name">Object</span> msg <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> messagemessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment">// 0.2 如果返回为 NEED_MORE_INPUT ，说明遇到了半包，重置缓存的读取下标</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token class-name">Codec2<span class="token punctuation">.</span>DecodeResult</span><span class="token punctuation">.</span><span class="token constant">NEED_MORE_INPUT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        message<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span>saveReaderIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token comment">// 0.3）把解码成功的对象放入 out 列表</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">NettyChannel</span><span class="token punctuation">.</span><span class="token function">removeChannelIfDisconnected</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>代码0.1先将message缓存的当前的读取下标保存到变量saveReaderIndex中，然后代码0.1执行具体的解码操作。如果代码0.1返回了NEED_MORE_INPUT，则说明遇到了半包，此时将message的读取下标重置为保存的saveReaderIndex，然后退出循环。否则，执行代码0.3，说明解析出来了一个完整的Dubbo协议帧，并保存到out列表，然后如果message还可读（有数据可以读取），则再次循环执行代码0.1，直到没有数据可读取，就退出循环。</p> <p>这里，我们具体看看codec.decode（DubboCodec的decode（）方法）的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// org/apache/dubbo/remoting/exchange/codec/ExchangeCodec.java:78    </span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">ChannelBuffer</span> buffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将 dubbo 协议头读取到数组 header</span>
        <span class="token keyword">int</span> readable <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>readable<span class="token punctuation">,</span> <span class="token constant">HEADER_LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 解析 dubbo 协议数据部分</span>
        <span class="token keyword">return</span> <span class="token function">decode</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> readable<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>上面的代码先试图从缓存中读取Dubbo协议帧的协议头部分，然后调用decode（）方法解析协议的数据部分。其中decode（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// org/apache/dubbo/remoting/exchange/codec/ExchangeCodec.java:86    </span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">ChannelBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> readable<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// check magic number.</span>
      <span class="token comment">// 1.1）检查魔数，确认为 Dubbo 协议帧</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readable <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> header<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">MAGIC_HIGH</span>
                <span class="token operator">||</span> readable <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">MAGIC_LOW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> length <span class="token operator">=</span> header<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> readable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                header <span class="token operator">=</span> <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> readable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> length<span class="token punctuation">,</span> readable <span class="token operator">-</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> header<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">MAGIC_HIGH</span> <span class="token operator">&amp;&amp;</span> header<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">MAGIC_LOW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    buffer<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> header<span class="token punctuation">.</span>length <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    header <span class="token operator">=</span> <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> readable<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// check length.</span>
      <span class="token comment">// 1.2）检查是否读取了一个完整的 Dubbo 协议头</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readable <span class="token operator">&lt;</span> <span class="token constant">HEADER_LENGTH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">DecodeResult</span><span class="token punctuation">.</span><span class="token constant">NEED_MORE_INPUT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// get data length.</span>
      <span class="token comment">// 1.3）从协议头的最后四个字节读取协议数据部分的大小</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">bytes2int</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkPayload</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 1.4）如果遇到半包问题，则直接返回</span>
        <span class="token keyword">int</span> tt <span class="token operator">=</span> len <span class="token operator">+</span> <span class="token constant">HEADER_LENGTH</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readable <span class="token operator">&lt;</span> tt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">DecodeResult</span><span class="token punctuation">.</span><span class="token constant">NEED_MORE_INPUT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// limit input stream.</span>
      <span class="token comment">// 1.5）解析协议数据部分</span>
        <span class="token class-name">ChannelBufferInputStream</span> is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChannelBufferInputStream</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">decodeBody</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> is<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>代码1.1首先检查魔数以便确定当前数据是Dubbo协议的数据。</p> <p>代码1.2 判断是否读取到了一个完整的Dubbo协议帧头，如果不是，则返回NEED_MORE_INPUT。</p> <p>代码1.3 解析出Dubbo协议帧数据部分（body）的大小，检查body 的大小是否超过了设置的数据包大小，如果超过了，则抛出ExceedPayloadLimitException异常。</p> <p>代码1.4判断是否遇到了半包问题，如果是，则直接返回NEED_MORE_INPUT。</p> <p>代码1.5解析协议帧数据部分。</p> <p>在上面的代码中，如果返回了NEED_MORE_INPUT，则说明遇到了半包的情况（数据不足以支撑一个完整的Dubbo协议帧），此时通过循环继续累加数据直到有至少一个完整协议帧。下面我们看看decodeBody（）方法是如何解析Dubbo协议帧数据部分的：</p> <blockquote><p>org.apache.dubbo.remoting.exchange.codec.ExchangeCodec#decodeBody</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">decodeBody</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> flag <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">SERIALIZATION_MASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// get request id.</span>
        <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">bytes2long</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">FLAG_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// decode response.</span>
          <span class="token comment">// 解码响应</span>
            <span class="token class-name">Response</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">FLAG_EVENT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">setEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// get status.</span>
            <span class="token keyword">byte</span> status <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// 解码数据部分</span>
                <span class="token class-name">ObjectInput</span> in <span class="token operator">=</span> <span class="token class-name">CodecSupport</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
                  <span class="token comment">//心跳</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        data <span class="token operator">=</span> <span class="token function">decodeHeartbeatData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token comment">//事件</span>
                        data <span class="token operator">=</span> <span class="token function">decodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      <span class="token comment">// 解码响应信息</span>
                        data <span class="token operator">=</span> <span class="token function">decodeResponseData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> in<span class="token punctuation">,</span> <span class="token function">getRequestData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token constant">CLIENT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// decode request.</span>
          <span class="token comment">// 解码请求</span>
            <span class="token class-name">Request</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            req<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            req<span class="token punctuation">.</span><span class="token function">setTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">FLAG_TWOWAY</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> <span class="token constant">FLAG_EVENT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                req<span class="token punctuation">.</span><span class="token function">setEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">ObjectInput</span> in <span class="token operator">=</span> <span class="token class-name">CodecSupport</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    data <span class="token operator">=</span> <span class="token function">decodeHeartbeatData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    data <span class="token operator">=</span> <span class="token function">decodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    data <span class="token operator">=</span> <span class="token function">decodeRequestData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// bad request</span>
                req<span class="token punctuation">.</span><span class="token function">setBroken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> req<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>上面的代码比较简单，其流程与编码时的流程是相反的。值得注意的是，decode（）方法在过程中使用“自定义协议header+body”的方式来解决粘包、半包问题，其中header记录了body 的大小，这种方式便于协议的升级。另外需要注意的是，在读取header 后，message的读取指针已经后移了，如果后面发现出现了半包现象，则需要把读取指针重置。</p> <h2 id="_13-4-小结"><a href="#_13-4-小结" class="header-anchor">#</a> 13.4 小结</h2> <blockquote><p>https://cn.dubbo.apache.org/zh-cn/docsv2.7/dev/source/service-invoking-process/</p></blockquote> <p>本章首先探讨了Dubbo框架的协议帧格式，并讲解了服务消费端如何把发送的请求数据封装为Dubbo协议帧，并进行序列化处理，然后讲解了服务提供方如何解决半包粘包问题，以及如何把解码后的数据转换为POJO类对象。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/posts/ant-design-swagger.html" class="prev">
          Ant Design Pro 集合 Swagger 的坑
        </a></span> <span class="next"><a href="/posts/Large-scale_website_system_and_Java_middleware_practice.html">
          大型网站系统与 Java 中间件实践
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#基础篇" class="sidebar-link reco-side-基础篇" data-v-b57cc07c>基础篇</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第1章-dubbo基础" class="sidebar-link reco-side-第1章-dubbo基础" data-v-b57cc07c>第1章 Dubbo基础</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_1-1-初识dubbo" class="sidebar-link reco-side-_1-1-初识dubbo" data-v-b57cc07c>1.1 初识Dubbo</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-本书demo详解" class="sidebar-link reco-side-_1-2-本书demo详解" data-v-b57cc07c>1.2 本书Demo详解</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-1-demo结构说明" class="sidebar-link reco-side-_1-2-1-demo结构说明" data-v-b57cc07c>1.2.1 Demo结构说明</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-2-sdk模块" class="sidebar-link reco-side-_1-2-2-sdk模块" data-v-b57cc07c>1.2.2 SDK模块</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-3-同步发布与调用服务" class="sidebar-link reco-side-_1-2-3-同步发布与调用服务" data-v-b57cc07c>1.2.3 同步发布与调用服务</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-4-服务消费端异步调用服务" class="sidebar-link reco-side-_1-2-4-服务消费端异步调用服务" data-v-b57cc07c>1.2.4 服务消费端异步调用服务</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-5-服务提供端异步执行" class="sidebar-link reco-side-_1-2-5-服务提供端异步执行" data-v-b57cc07c>1.2.5 服务提供端异步执行</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-6-服务消费端泛化调用" class="sidebar-link reco-side-_1-2-6-服务消费端泛化调用" data-v-b57cc07c>1.2.6 服务消费端泛化调用</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-7-服务消费端本地服务mock与服务降级" class="sidebar-link reco-side-_1-2-7-服务消费端本地服务mock与服务降级" data-v-b57cc07c>1.2.7 服务消费端本地服务mock与服务降级</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-8-隐式参数传递" class="sidebar-link reco-side-_1-2-8-隐式参数传递" data-v-b57cc07c>1.2.8 隐式参数传递</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_1-2-9-本地服务暴露与引用" class="sidebar-link reco-side-_1-2-9-本地服务暴露与引用" data-v-b57cc07c>1.2.9 本地服务暴露与引用</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_1-3-小结" class="sidebar-link reco-side-_1-3-小结" data-v-b57cc07c>1.3 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#高级篇" class="sidebar-link reco-side-高级篇" data-v-b57cc07c>高级篇</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第2章-dubbo框架内核原理剖析" class="sidebar-link reco-side-第2章-dubbo框架内核原理剖析" data-v-b57cc07c>第2章 Dubbo框架内核原理剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-1-dubbo分层架构概述" class="sidebar-link reco-side-_2-1-dubbo分层架构概述" data-v-b57cc07c>2.1 Dubbo分层架构概述</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-2-dubbo远程调用细节" class="sidebar-link reco-side-_2-2-dubbo远程调用细节" data-v-b57cc07c>2.2 Dubbo远程调用细节</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_2-2-1-服务提供者暴露一个服务的概要过程" class="sidebar-link reco-side-_2-2-1-服务提供者暴露一个服务的概要过程" data-v-b57cc07c>2.2.1 服务提供者暴露一个服务的概要过程</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_2-2-2-服务消费者消费一个服务的概要过程" class="sidebar-link reco-side-_2-2-2-服务消费者消费一个服务的概要过程" data-v-b57cc07c>2.2.2 服务消费者消费一个服务的概要过程</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-3-dubbo的适配器原理" class="sidebar-link reco-side-_2-3-dubbo的适配器原理" data-v-b57cc07c>2.3 Dubbo的适配器原理</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-4-dubbo的动态编译原理" class="sidebar-link reco-side-_2-4-dubbo的动态编译原理" data-v-b57cc07c>2.4 Dubbo的动态编译原理</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-5-dubbo增强spi" class="sidebar-link reco-side-_2-5-dubbo增强spi" data-v-b57cc07c>2.5 Dubbo增强SPI</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_2-5-1-jdk标准spi" class="sidebar-link reco-side-_2-5-1-jdk标准spi" data-v-b57cc07c>2.5.1 JDK标准SPI</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_2-5-2-增强spi原理" class="sidebar-link reco-side-_2-5-2-增强spi原理" data-v-b57cc07c>2.5.2 增强SPI原理</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_2-5-3-扩展点的自动包装" class="sidebar-link reco-side-_2-5-3-扩展点的自动包装" data-v-b57cc07c>2.5.3 扩展点的自动包装</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-6-dubbo使用javaassist减少反射调用开销" class="sidebar-link reco-side-_2-6-dubbo使用javaassist减少反射调用开销" data-v-b57cc07c>2.6 Dubbo使用JavaAssist减少反射调用开销</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_2-7-小结" class="sidebar-link reco-side-_2-7-小结" data-v-b57cc07c>2.7 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第3章-远程服务发布与引用流程剖析" class="sidebar-link reco-side-第3章-远程服务发布与引用流程剖析" data-v-b57cc07c>第3章 远程服务发布与引用流程剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_3-1-dubbo服务发布端启动流程剖析" class="sidebar-link reco-side-_3-1-dubbo服务发布端启动流程剖析" data-v-b57cc07c>3.1 Dubbo服务发布端启动流程剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_3-2-dubbo服务提供方如何处理请求" class="sidebar-link reco-side-_3-2-dubbo服务提供方如何处理请求" data-v-b57cc07c>3.2 Dubbo服务提供方如何处理请求</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_3-3-dubbo服务消费方启动流程剖析" class="sidebar-link reco-side-_3-3-dubbo服务消费方启动流程剖析" data-v-b57cc07c>3.3 Dubbo服务消费方启动流程剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_3-4-dubbo服务消费端一次远程调用过程" class="sidebar-link reco-side-_3-4-dubbo服务消费端一次远程调用过程" data-v-b57cc07c>3.4 Dubbo服务消费端一次远程调用过程</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_3-5-小结" class="sidebar-link reco-side-_3-5-小结" data-v-b57cc07c>3.5 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第4章-directory目录与router路由服务" class="sidebar-link reco-side-第4章-directory目录与router路由服务" data-v-b57cc07c>第4章 Directory目录与Router路由服务</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_4-1-directory目录" class="sidebar-link reco-side-_4-1-directory目录" data-v-b57cc07c>4.1 Directory目录</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_4-2-registrydirectory的创建" class="sidebar-link reco-side-_4-2-registrydirectory的创建" data-v-b57cc07c>4.2 RegistryDirectory的创建</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_4-3-registrydirectory中invoker列表的更新" class="sidebar-link reco-side-_4-3-registrydirectory中invoker列表的更新" data-v-b57cc07c>4.3 RegistryDirectory中invoker列表的更新</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_4-4-小结" class="sidebar-link reco-side-_4-4-小结" data-v-b57cc07c>4.4 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第5章-dubbo消费端服务mock与服务降级策略原理" class="sidebar-link reco-side-第5章-dubbo消费端服务mock与服务降级策略原理" data-v-b57cc07c>第5章 Dubbo消费端服务mock与服务降级策略原理</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_5-1-服务降级原理" class="sidebar-link reco-side-_5-1-服务降级原理" data-v-b57cc07c>5.1 服务降级原理</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_5-1-1-降级策略注册" class="sidebar-link reco-side-_5-1-1-降级策略注册" data-v-b57cc07c>5.1.1 降级策略注册</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_5-1-2-服务消费端使用降级策略" class="sidebar-link reco-side-_5-1-2-服务消费端使用降级策略" data-v-b57cc07c>5.1.2 服务消费端使用降级策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_5-2-本地服务mock原理" class="sidebar-link reco-side-_5-2-本地服务mock原理" data-v-b57cc07c>5.2 本地服务mock原理</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_5-2-1-mock合法性检查" class="sidebar-link reco-side-_5-2-1-mock合法性检查" data-v-b57cc07c>5.2.1 mock合法性检查</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_5-2-2-服务消费端使用mock服务" class="sidebar-link reco-side-_5-2-2-服务消费端使用mock服务" data-v-b57cc07c>5.2.2 服务消费端使用mock服务</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_5-3-小结" class="sidebar-link reco-side-_5-3-小结" data-v-b57cc07c>5.3 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第6章-dubbo集群容错与负载均衡策略" class="sidebar-link reco-side-第6章-dubbo集群容错与负载均衡策略" data-v-b57cc07c>第6章 Dubbo集群容错与负载均衡策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-1-dubbo集群容错策略概述" class="sidebar-link reco-side-_6-1-dubbo集群容错策略概述" data-v-b57cc07c>6.1 Dubbo集群容错策略概述</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-2-failfast-cluster策略源码分析" class="sidebar-link reco-side-_6-2-failfast-cluster策略源码分析" data-v-b57cc07c>6.2 Failfast Cluster策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-3-failsafe-cluster策略源码分析" class="sidebar-link reco-side-_6-3-failsafe-cluster策略源码分析" data-v-b57cc07c>6.3 Failsafe Cluster策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-4-failover-cluster策略源码分析" class="sidebar-link reco-side-_6-4-failover-cluster策略源码分析" data-v-b57cc07c>6.4 Failover Cluster策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-5-failback-cluster策略源码分析" class="sidebar-link reco-side-_6-5-failback-cluster策略源码分析" data-v-b57cc07c>6.5 Failback Cluster策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-6-forking-cluster策略源码分析" class="sidebar-link reco-side-_6-6-forking-cluster策略源码分析" data-v-b57cc07c>6.6 Forking Cluster策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-7-broadcast-cluster策略源码分析" class="sidebar-link reco-side-_6-7-broadcast-cluster策略源码分析" data-v-b57cc07c>6.7 Broadcast Cluster策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-8-如何基于扩展接口自定义集群容错策略" class="sidebar-link reco-side-_6-8-如何基于扩展接口自定义集群容错策略" data-v-b57cc07c>6.8 如何基于扩展接口自定义集群容错策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-9-dubbo负载均衡策略概述" class="sidebar-link reco-side-_6-9-dubbo负载均衡策略概述" data-v-b57cc07c>6.9 Dubbo负载均衡策略概述</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-10-random-loadbalance策略源码分析" class="sidebar-link reco-side-_6-10-random-loadbalance策略源码分析" data-v-b57cc07c>6.10 Random LoadBalance策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-11-roundrobin-loadbalance策略源码分析" class="sidebar-link reco-side-_6-11-roundrobin-loadbalance策略源码分析" data-v-b57cc07c>6.11 RoundRobin LoadBalance策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-12-leastactive-loadbalance策略源码分析" class="sidebar-link reco-side-_6-12-leastactive-loadbalance策略源码分析" data-v-b57cc07c>6.12 LeastActive LoadBalance策略源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-13-consistenthash-loadbalance策略源码分析" class="sidebar-link reco-side-_6-13-consistenthash-loadbalance策略源码分析" data-v-b57cc07c>6.13 ConsistentHash LoadBalance策略源码分析</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_6-13-1-一致性hash负载均衡策略原理" class="sidebar-link reco-side-_6-13-1-一致性hash负载均衡策略原理" data-v-b57cc07c>6.13.1 一致性Hash负载均衡策略原理</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_6-13-2-源码分析" class="sidebar-link reco-side-_6-13-2-源码分析" data-v-b57cc07c>6.13.2 源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-14-如何基于扩展接口自定义负载均衡策略" class="sidebar-link reco-side-_6-14-如何基于扩展接口自定义负载均衡策略" data-v-b57cc07c>6.14 如何基于扩展接口自定义负载均衡策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_6-15-小结" class="sidebar-link reco-side-_6-15-小结" data-v-b57cc07c>6.15 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第7章-dubbo线程模型与线程池策略" class="sidebar-link reco-side-第7章-dubbo线程模型与线程池策略" data-v-b57cc07c>第7章 Dubbo线程模型与线程池策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-1-dubbo的线程模型概述" class="sidebar-link reco-side-_7-1-dubbo的线程模型概述" data-v-b57cc07c>7.1 Dubbo的线程模型概述</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-2-alldispatcher源码剖析" class="sidebar-link reco-side-_7-2-alldispatcher源码剖析" data-v-b57cc07c>7.2 AllDispatcher源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-3-directdispatcher源码剖析" class="sidebar-link reco-side-_7-3-directdispatcher源码剖析" data-v-b57cc07c>7.3 DirectDispatcher源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-4-messageonlydispatcher源码剖析" class="sidebar-link reco-side-_7-4-messageonlydispatcher源码剖析" data-v-b57cc07c>7.4 MessageOnlyDispatcher源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-5-executiondispatcher源码剖析" class="sidebar-link reco-side-_7-5-executiondispatcher源码剖析" data-v-b57cc07c>7.5 ExecutionDispatcher源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-6-connectionordereddispatcher源码剖析" class="sidebar-link reco-side-_7-6-connectionordereddispatcher源码剖析" data-v-b57cc07c>7.6 ConnectionOrderedDispatcher源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-7-线程模型的确定时机" class="sidebar-link reco-side-_7-7-线程模型的确定时机" data-v-b57cc07c>7.7 线程模型的确定时机</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-8-如何基于扩展接口自定义线程模型" class="sidebar-link reco-side-_7-8-如何基于扩展接口自定义线程模型" data-v-b57cc07c>7.8 如何基于扩展接口自定义线程模型</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-9-dubbo的线程池策略" class="sidebar-link reco-side-_7-9-dubbo的线程池策略" data-v-b57cc07c>7.9 Dubbo的线程池策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-10-fixedthreadpool源码剖析" class="sidebar-link reco-side-_7-10-fixedthreadpool源码剖析" data-v-b57cc07c>7.10 FixedThreadPool源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-11-limitedthreadpool源码剖析" class="sidebar-link reco-side-_7-11-limitedthreadpool源码剖析" data-v-b57cc07c>7.11 LimitedThreadPool源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-12-eagerthreadpool源码剖析" class="sidebar-link reco-side-_7-12-eagerthreadpool源码剖析" data-v-b57cc07c>7.12 EagerThreadPool源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-13-cachedthreadpool源码剖析" class="sidebar-link reco-side-_7-13-cachedthreadpool源码剖析" data-v-b57cc07c>7.13 CachedThreadPool源码剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-14-线程池的确定时机" class="sidebar-link reco-side-_7-14-线程池的确定时机" data-v-b57cc07c>7.14 线程池的确定时机</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-15-如何基于扩展接口自定义线程池策略" class="sidebar-link reco-side-_7-15-如何基于扩展接口自定义线程池策略" data-v-b57cc07c>7.15 如何基于扩展接口自定义线程池策略</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_7-16-小结" class="sidebar-link reco-side-_7-16-小结" data-v-b57cc07c>7.16 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第8章-dubbo如何实现泛化引用" class="sidebar-link reco-side-第8章-dubbo如何实现泛化引用" data-v-b57cc07c>第8章 Dubbo如何实现泛化引用</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_8-1-服务消费端genericimplfilter源码分析" class="sidebar-link reco-side-_8-1-服务消费端genericimplfilter源码分析" data-v-b57cc07c>8.1 服务消费端GenericImplFilter源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_8-2-服务提供端genericfilter源码分析" class="sidebar-link reco-side-_8-2-服务提供端genericfilter源码分析" data-v-b57cc07c>8.2 服务提供端GenericFilter源码分析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_8-3-小结" class="sidebar-link reco-side-_8-3-小结" data-v-b57cc07c>8.3 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第9章-dubbo并发控制" class="sidebar-link reco-side-第9章-dubbo并发控制" data-v-b57cc07c>第9章 Dubbo并发控制</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_9-1-服务消费端并发控制" class="sidebar-link reco-side-_9-1-服务消费端并发控制" data-v-b57cc07c>9.1 服务消费端并发控制</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_9-2-服务提供端并发控制" class="sidebar-link reco-side-_9-2-服务提供端并发控制" data-v-b57cc07c>9.2 服务提供端并发控制</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_9-3-小结" class="sidebar-link reco-side-_9-3-小结" data-v-b57cc07c>9.3 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第10章-dubbo隐式参数传递" class="sidebar-link reco-side-第10章-dubbo隐式参数传递" data-v-b57cc07c>第10章 Dubbo隐式参数传递</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_10-1-服务消费端abstractclusterinvoker原理剖析" class="sidebar-link reco-side-_10-1-服务消费端abstractclusterinvoker原理剖析" data-v-b57cc07c>10.1 服务消费端AbstractClusterInvoker原理剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_10-2-服务提供方contextfilter原理剖析" class="sidebar-link reco-side-_10-2-服务提供方contextfilter原理剖析" data-v-b57cc07c>10.2 服务提供方ContextFilter原理剖析</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_10-3-小结" class="sidebar-link reco-side-_10-3-小结" data-v-b57cc07c>10.3 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第11章-dubbo全链路异步" class="sidebar-link reco-side-第11章-dubbo全链路异步" data-v-b57cc07c>第11章 Dubbo全链路异步</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_11-1-服务消费端异步调用" class="sidebar-link reco-side-_11-1-服务消费端异步调用" data-v-b57cc07c>11.1 服务消费端异步调用</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_11-1-1-2-7-0版本前的异步调用实现" class="sidebar-link reco-side-_11-1-1-2-7-0版本前的异步调用实现" data-v-b57cc07c>11.1.1 2.7.0版本前的异步调用实现</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_11-1-2-2-7-0版本提供的异步调用实现" class="sidebar-link reco-side-_11-1-2-2-7-0版本提供的异步调用实现" data-v-b57cc07c>11.1.2 2.7.0版本提供的异步调用实现</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_11-2-服务提供端异步执行" class="sidebar-link reco-side-_11-2-服务提供端异步执行" data-v-b57cc07c>11.2 服务提供端异步执行</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_11-2-1-基于定义completablefuture签名的接口实现异步执行" class="sidebar-link reco-side-_11-2-1-基于定义completablefuture签名的接口实现异步执行" data-v-b57cc07c>11.2.1 基于定义CompletableFuture签名的接口实现异步执行</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_11-2-2-使用asynccontext实现异步执行" class="sidebar-link reco-side-_11-2-2-使用asynccontext实现异步执行" data-v-b57cc07c>11.2.2 使用AsyncContext实现异步执行</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_11-3-异步调用与执行引入的新问题" class="sidebar-link reco-side-_11-3-异步调用与执行引入的新问题" data-v-b57cc07c>11.3 异步调用与执行引入的新问题</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_11-3-1-filter链" class="sidebar-link reco-side-_11-3-1-filter链" data-v-b57cc07c>11.3.1 Filter链</a></li><li class="level-3" data-v-b57cc07c><a href="/posts/dubbo.html#_11-3-2-上下文对象传递" class="sidebar-link reco-side-_11-3-2-上下文对象传递" data-v-b57cc07c>11.3.2 上下文对象传递</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_11-4-小结" class="sidebar-link reco-side-_11-4-小结" data-v-b57cc07c>11.4 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第12章-本地服务暴露与引用原理" class="sidebar-link reco-side-第12章-本地服务暴露与引用原理" data-v-b57cc07c>第12章 本地服务暴露与引用原理</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_12-1-本地服务暴露流程" class="sidebar-link reco-side-_12-1-本地服务暴露流程" data-v-b57cc07c>12.1 本地服务暴露流程</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_12-2-本地服务引用启动流程" class="sidebar-link reco-side-_12-2-本地服务引用启动流程" data-v-b57cc07c>12.2 本地服务引用启动流程</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_12-3-本地服务一次引用流程" class="sidebar-link reco-side-_12-3-本地服务一次引用流程" data-v-b57cc07c>12.3 本地服务一次引用流程</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_12-4-小结" class="sidebar-link reco-side-_12-4-小结" data-v-b57cc07c>12.4 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#第13章-dubbo协议与网络传输" class="sidebar-link reco-side-第13章-dubbo协议与网络传输" data-v-b57cc07c>第13章 Dubbo协议与网络传输</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_13-1-dubbo协议" class="sidebar-link reco-side-_13-1-dubbo协议" data-v-b57cc07c>13.1 Dubbo协议</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_13-2-服务消费方编码原理" class="sidebar-link reco-side-_13-2-服务消费方编码原理" data-v-b57cc07c>13.2 服务消费方编码原理</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_13-3-服务发布方解码原理" class="sidebar-link reco-side-_13-3-服务发布方解码原理" data-v-b57cc07c>13.3 服务发布方解码原理</a></li><li class="level-2" data-v-b57cc07c><a href="/posts/dubbo.html#_13-4-小结" class="sidebar-link reco-side-_13-4-小结" data-v-b57cc07c>13.4 小结</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.990df87d.js" defer></script><script src="/assets/js/7.491a51aa.js" defer></script><script src="/assets/js/2.e6a59b38.js" defer></script><script src="/assets/js/1.d6963574.js" defer></script><script src="/assets/js/14.b7d37254.js" defer></script>
  </body>
</html>
